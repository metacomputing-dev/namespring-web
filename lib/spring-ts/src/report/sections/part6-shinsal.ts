// @ts-nocheck
/**
 * part6-shinsal.ts -- 신살(神煞) 적중 목록 및 점수 섹션
 *
 * PART 6: 적중 신살을 길신/흉살로 분류하고 점수를 합산합니다.
 *
 * 페르소나: "모험가/RPG 게임 마스터"
 * - 길신 → 패시브 스킬, 버프, 보물상자, 숨겨진 능력
 * - 흉살 → 디버프, 사이드 퀘스트, 도전 미션, 보스전 경고
 */

import type {
  ReportInput,
  ReportSection,
  ReportParagraph,
  ReportTable,
  ReportChart,
  ReportHighlight,
} from '../types.js';

import {
  createRng,
  pickAndFill,
  narrative,
  positive,
  caution,
  tip,
  emphasis,
  encouraging,
} from '../common/sentenceUtils.js';
import { findShinsalEntry } from '../knowledge/shinsalEncyclopedia.js';

// ─────────────────────────────────────────────────────────────────────────────
//  헬퍼
// ─────────────────────────────────────────────────────────────────────────────

function safeName(input: ReportInput): string {
  return input.name?.trim() || '모험가';
}

// ─────────────────────────────────────────────────────────────────────────────
//  신살별 RPG 풍미 설명 매핑
// ─────────────────────────────────────────────────────────────────────────────

/** 길신 계열 — 발견/획득/보너스 느낌 */
const SHINSAL_FLAVOR_GOOD: Record<string, string[]> = {
  천을귀인: [
    '최고 등급의 수호 버프예요. 위기 상황에서 자동으로 발동하는 긴급 구원 스킬과도 같아요.',
    '어려울 때마다 NPC 조력자가 나타나는 히든 이벤트가 항상 대기 중인 셈이에요.',
    '게임에서 말하는 "행운의 패시브 스킬"의 최상위 버전이라 할 수 있어요.',
  ],
  태극귀인: [
    '시작점의 축복이에요. 모든 퀘스트의 첫 스텝에서 추가 경험치를 받는 셈이에요.',
    '캐릭터 생성 때 이미 보너스 포인트를 받고 태어난 것과 같은 특수 능력이에요.',
    '뭔가를 새로 시작할 때마다 은근히 도움이 되는 숨겨진 패시브 버프예요.',
  ],
  문창귀인: [
    '지혜 스탯에 영구 버프가 걸린 상태예요. 학업이나 시험에서 크리티컬 확률이 올라가는 거죠.',
    '지식 관련 퀘스트를 클리어할 때 보상이 두 배로 들어오는 보물 스킬이에요.',
    '책이나 공부와 관련된 미션에서 숨겨진 보너스 경험치를 얻는 특수 패시브예요.',
  ],
  문곡귀인: [
    '예술과 감성 분야에서 숨겨진 재능 트리가 열리는 희귀 버프예요.',
    '창작 활동에서 "영감 게이지"가 두 배 속도로 차오르는 패시브 능력이에요.',
    '글쓰기, 음악, 미술 같은 퀘스트에서 레어 아이템 드롭률이 상승하는 스킬이에요.',
  ],
  학당귀인: [
    '학업의 성소를 발견한 거예요! 배움 관련 퀘스트에서 항상 추가 보상이 따라오는 패시브예요.',
    '경험치 획득 속도가 영구적으로 상승하는 특수 버프인 셈이에요.',
    '공부와 학문이라는 스킬 트리에서 레벨업 속도가 빨라지는 숨겨진 능력이에요.',
  ],
  천주귀인: [
    '요리사의 축복! 먹거리와 관련된 모든 퀘스트에서 행운이 따르는 희귀 버프예요.',
    '식복(食福)이라는 이름의 패시브 스킬이 항상 활성화되어 있는 셈이에요.',
    '맛있는 것과 인연이 깊은, 식도락 모험가만의 특별한 보너스 능력이에요.',
  ],
  천관귀인: [
    '리더십 스킬 트리의 잠금이 해제된 상태예요. 조직에서의 승진 퀘스트가 수월해지는 버프예요.',
    '관직과 명예 관련 미션에서 자동으로 유리한 조건이 걸리는 패시브 능력이에요.',
    '사회적 지위와 관련된 도전에서 크리티컬 히트 확률이 올라가는 특수 스킬이에요.',
  ],
  천복귀인: [
    '복(福)의 보물상자를 품고 태어난 거예요! 전반적 행운이 상승하는 올라운드 버프예요.',
    '어떤 퀘스트든 클리어 보상에 "행운 보너스"가 추가로 붙는 패시브 능력이에요.',
    '게임 내 숨겨진 럭키 아이템을 자동으로 소지하고 있는 것과 같은 축복이에요.',
  ],
  복성귀인: [
    '복의 별이 비추는 특별한 축복이에요. 인생이라는 게임에서 행운 게이지가 높게 유지되는 버프예요.',
    '어려운 보스전에서도 은근히 운이 따르는, 숨겨진 행운의 패시브 스킬이에요.',
    '다른 모험가들보다 레어 아이템 드롭 확률이 약간 높은 특수 체질인 셈이에요.',
  ],
  금여귀인: [
    '황금 마차에 올라탄 것 같은 럭셔리 버프예요! 물질적 풍요 관련 퀘스트에 유리하답니다.',
    '재물과 풍요의 스킬 트리에서 특별 보너스를 받는 레어 패시브 능력이에요.',
    '의식주 관련 미션에서 항상 좋은 결과를 끌어당기는 황금 패시브 스킬이에요.',
  ],
  록신: [
    '매달 들어오는 안정적인 골드 수입이 보장되는 "월급 버프"와도 같아요.',
    '녹봉의 축복이에요. 경제적 안정감이라는 패시브 스킬이 항상 켜져 있는 셈이에요.',
    '직장이나 사업에서 기본 수입이 보장되는 안정의 버프예요.',
  ],
  도화: [
    '매력 스탯에 영구 버프가 걸린 상태예요! 대인관계 퀘스트에서 성공률이 올라가요.',
    '사교 스킬 트리에서 "인기" 패시브가 자동으로 발동하는 특수 능력이에요.',
    '사람을 끌어당기는 마력이 있어서 팀 결성 퀘스트가 수월한 매력 버프예요.',
  ],
  역마: [
    '이동 속도가 상승하는 스위프트 버프예요! 여행, 이사, 해외 퀘스트에 유리해요.',
    '새로운 맵을 탐험할 때마다 보너스 경험치를 받는 탐험가의 패시브 능력이에요.',
    '변화와 이동이 잦지만, 그만큼 새로운 보물을 발견할 확률이 높은 모험가 스킬이에요.',
  ],
  화개살: [
    '종교, 예술, 학문에서 숨겨진 스킬 트리가 열리는 신비로운 버프예요.',
    '영적 감수성이라는 히든 스탯이 높아지는 특수한 패시브 능력이에요.',
    '고독한 수행자의 길에서 특별한 보상을 발견할 수 있는 탐험 스킬이에요.',
  ],
  장성살: [
    '명예와 승진의 사다리를 빠르게 오를 수 있는 특수 이동 스킬이에요.',
    '사회적 퀘스트에서 추가 평판 포인트를 획득하는 숨겨진 패시브 능력이에요.',
    '장군의 별 아래 태어난 것처럼 리더십 스킬에 보너스가 붙는 버프예요.',
  ],
  월덕귀인: [
    '매달 한 번씩 발동하는 "달의 축복" 버프예요. 위기에서 자동으로 회복되는 패시브랍니다.',
    '월광의 가호로 매달 운세가 약간씩 보정되는 은은한 보호 스킬이에요.',
    '달이 바뀔 때마다 행운의 바람이 부는, 꾸준한 보너스 능력이에요.',
  ],
  월덕합: [
    '월덕의 조화로운 버전! 사람들과의 관계에서 자연스럽게 협력 보너스가 생기는 패시브예요.',
    '팀플레이 퀘스트에서 시너지 효과가 증폭되는 특수한 합의 버프예요.',
    '매달 주기적으로 좋은 인연이 찾아오는 "관계의 축복" 패시브 능력이에요.',
  ],
  천덕귀인: [
    '하늘이 내린 덕(德)의 보호막이에요! 나쁜 이벤트의 데미지가 자동으로 경감되는 버프예요.',
    '최악의 상황에서도 최소한의 안전장치가 발동하는 "천상의 방어막" 패시브예요.',
    '덕이 높은 캐릭터라서 주변 NPC들이 호감을 갖고 도와주는 숨겨진 능력이에요.',
  ],
  천덕합: [
    '천덕의 합(合) 버전! 덕(德)으로 주변을 감화시키는 카리스마 패시브 능력이에요.',
    '팀 내에서 자연스럽게 조화를 만들어내는 "덕장의 오라" 버프와 같아요.',
    '좋은 사람들이 자연스럽게 모여드는 인덕(人德)의 패시브 스킬이에요.',
  ],
  천의: [
    '치유의 손길이에요! 건강 관련 퀘스트에서 회복력이 상승하는 패시브 버프예요.',
    '의료나 힐링 관련 스킬 트리에 보너스가 붙는 특수한 힐러의 재능이에요.',
    '아프거나 다쳤을 때 회복 속도가 빠른 "자연 치유" 패시브 능력이에요.',
  ],
  천월덕: [
    '천덕과 월덕이 합쳐진 더블 버프! 하늘과 달 모두의 축복을 받은 최강 방어 패시브예요.',
    '이중 보호막이 항상 켜져 있어서 나쁜 이벤트의 피해가 크게 줄어드는 특수 능력이에요.',
    '두 겹의 행운 버프가 겹쳐진 매우 희귀한 보호 스킬이에요.',
  ],
  천사일: [
    '하늘의 사자가 보호하는 특별한 날에 태어난 축복이에요! 위기 상황에서 반전의 카드가 나타나는 패시브예요.',
    '결정적 순간에 구원의 이벤트가 발생하는 "천사의 개입" 패시브 능력이에요.',
    '어려운 보스전에서 마지막 순간 기적적인 도움이 오는 숨겨진 행운 스킬이에요.',
  ],
  홍란: [
    '연애 이벤트 발동률이 상승하는 로맨스 버프예요! 인연 퀘스트가 풍성해지는 특수 능력이에요.',
    '이성에게 자연스럽게 매력을 발산하는 "붉은 난초의 향기" 패시브 스킬이에요.',
    '결혼이나 연애 관련 미션에서 성공률이 올라가는 사랑의 축복이에요.',
  ],
  천희: [
    '기쁨의 별이 비추는 축복이에요! 즐거운 이벤트가 자주 발생하는 행복 버프예요.',
    '파티나 축하 이벤트에서 추가 보상을 받는 "축제의 별" 패시브 능력이에요.',
    '경사스러운 일이 잘 찾아오는 "기쁨의 오라" 패시브 스킬이에요.',
  ],
  덕수귀인: [
    '덕(德)과 수(壽)가 함께하는 버프예요. 인품과 장수가 함께 보장되는 올라운드 축복이에요.',
    '주변 사람들에게 존경받으며 건강한 삶을 사는 "덕수쌍전" 패시브 능력이에요.',
    '덕을 쌓을수록 보상이 커지는 장기 퀘스트의 숨겨진 보너스 스킬이에요.',
  ],
  반안살: [
    '안정적인 자리를 잡는 데 유리한 "안장 버프"예요. 정착 관련 퀘스트 보너스가 있어요.',
    '어디를 가든 편안한 자리를 찾아내는 "자리잡기의 달인" 패시브 능력이에요.',
    '직장이나 거주지에서 안정감을 주는 "안전 기지" 스킬이에요.',
  ],
};

/** 흉살 계열 — 주의/사이드퀘스트/도전 느낌 */
const SHINSAL_FLAVOR_BAD: Record<string, string[]> = {
  충살: [
    '부딪히는 에너지가 있어요. 하지만 RPG에서 보스전이 없으면 레벨업도 없듯이, 이 충돌이 성장의 발판이 될 수 있어요.',
    '예상치 못한 이벤트가 발생할 수 있는 "서프라이즈 퀘스트" 경고 표시예요. 준비만 잘 하면 괜찮아요.',
    '충돌 이벤트가 예약되어 있지만, 잘 대처하면 레어 보상을 얻는 숨겨진 기회이기도 해요.',
  ],
  형살: [
    '성장을 위한 시련 퀘스트가 주어지는 사이드 미션이에요. 클리어하면 내면의 스탯이 올라가요.',
    '약간의 마찰이 있지만, 이걸 극복하면 숨겨진 스킬이 해금되는 도전 이벤트와 같아요.',
    '"성장통 이벤트"라고 보면 돼요. 일시적 불편함 뒤에 레벨업이 기다리고 있는 거죠.',
  ],
  해살: [
    '뒤에서 몰래 HP를 깎는 약한 디버프예요. 하지만 미리 알고 대비하면 거의 무시할 수 있어요.',
    '소소한 방해 이벤트가 가끔 발생하는 정도예요. 경계 레벨을 한 칸 올려두면 충분해요.',
    '보이지 않는 곳에서 오는 작은 도전이에요. 주의력 스탯만 약간 올리면 충분히 대처 가능해요.',
  ],
  파살: [
    '깨지는 에너지가 있지만, 때로는 낡은 것이 깨져야 새로운 보물이 드러나는 법이에요.',
    '"파괴 후 재건" 타입의 사이드 퀘스트예요. 불편하지만 그 뒤에 업그레이드가 기다리고 있어요.',
    '기존 구조가 흔들리는 이벤트이지만, 리셋 후 더 나은 빌드를 만들 수 있는 기회이기도 해요.',
  ],
  원진살: [
    '특정 관계에서 미묘한 불화가 생길 수 있는 "관계 디버프"예요. 커뮤니케이션 스킬로 극복 가능해요.',
    '인간관계 퀘스트에서 난이도가 살짝 올라가는 정도예요. 이해와 배려 스킬을 올리면 해결돼요.',
    '서로 좋은 사이인데 가끔 삐끗하는, 그런 소소한 관계 미션이 추가되는 셈이에요.',
  ],
  격각살: [
    '예상 밖의 변수가 생기는 "돌발 이벤트" 경고예요. 유연성 스탯이 높으면 쉽게 대처할 수 있어요.',
    '갑작스러운 변화가 올 수 있다는 사전 경고와 같아요. 미리 아는 것만으로도 절반은 해결한 셈이에요.',
    '모험 도중 갑자기 갈림길이 나타나는 이벤트예요. 침착하게 선택하면 문제없어요.',
  ],
  겁살: [
    '강한 도전 미션이 등장하는 경고 표시예요. 하지만 이 보스를 이기면 엄청난 경험치가 기다리고 있어요.',
    '위험 감지 센서가 울리는 구간이지만, RPG에서 위험한 던전일수록 보상도 크잖아요.',
    '도전적인 퀘스트가 주어지는 표시예요. 준비를 단단히 하면 오히려 레벨업의 기회가 돼요.',
  ],
  재살: [
    '재난 이벤트가 예약되어 있다는 표시이지만, 사전에 방어력을 올려두면 피해를 최소화할 수 있어요.',
    '불의의 사고에 대한 "경계 알림"이에요. 미리 아는 것이 최고의 방어 스킬이에요.',
    '안전 관련 사이드 퀘스트를 미리 클리어해 두면 이 디버프의 영향을 크게 줄일 수 있어요.',
  ],
  천살: [
    '자연재해급 이벤트에 대한 사전 경고예요. 하지만 현대 사회에서는 "마음의 준비"로 충분히 대비 가능해요.',
    '큰 변화의 물결이 올 수 있다는 시그널이에요. 서핑하듯 그 파도를 타면 오히려 멀리 갈 수 있어요.',
    '강력한 보스가 출현할 수 있다는 경고이지만, 파티를 잘 꾸리면 클리어할 수 있는 난이도예요.',
  ],
  지살: [
    '땅의 기운이 흔들리는 사이드 퀘스트가 있어요. 기반을 다지는 활동에 신경 쓰면 극복할 수 있어요.',
    '부동산이나 이사 관련 이벤트에서 주의가 필요한 "지형 경고" 디버프예요.',
    '안정적인 기반을 다지는 데 약간의 노력이 더 필요한 도전 미션이에요.',
  ],
  월살: [
    '매달 특정 시기에 에너지가 살짝 떨어지는 디버프예요. 쉬어가는 타이밍으로 활용하면 오히려 좋아요.',
    '달의 변화에 따라 컨디션이 요동치는 주기적 이벤트예요. 패턴을 파악하면 쉽게 대처 가능해요.',
    '한 달 중 특정 시기에 주의력을 높여야 하는 소규모 사이드 퀘스트예요.',
  ],
  망신살: [
    '체면과 관련된 도전 퀘스트가 가끔 발생해요. 겸손 스킬을 올려두면 쉽게 넘길 수 있어요.',
    '남들 앞에서 실수할 수 있는 "당황 이벤트"에 대한 경고예요. 너무 긴장하지 않으면 괜찮아요.',
    '실수나 망신을 통해 오히려 성장하는 "역전 레벨업" 이벤트가 숨어 있는 퀘스트예요.',
  ],
  육해살: [
    '가까운 관계에서 소소한 마찰이 생기는 "관계 미니게임"이에요. 소통 스킬로 해결 가능해요.',
    '친한 사이일수록 작은 갈등이 생기기 쉬운 법이에요. 이해 스킬을 올리면 무난히 클리어돼요.',
    '가족이나 친구와의 관계에서 미세한 디버프가 걸릴 수 있지만, 대화 한 마디로 해제 가능해요.',
  ],
  비인살: [
    '날카로운 에너지가 있어서 "공격력 보너스"가 붙는 대신 방어에 좀 더 신경 써야 하는 스킬이에요.',
    '칼날처럼 예리한 판단력이 있지만, 가끔 너무 날카로워서 주변에 상처를 줄 수 있는 양날의 검이에요.',
    '도전적이고 과감한 성향이 강해지는 버프인데, 조절 스킬이 필요한 양면 능력이에요.',
  ],
  양인: [
    '공격력이 크게 상승하는 대신 방어력에 페널티가 붙는 "버서커 모드" 같은 양날의 스킬이에요.',
    '강한 추진력과 결단력이 있지만, 너무 밀어붙이면 리스크가 커지는 하이리스크 하이리턴 스킬이에요.',
    '강력한 행동력이 부여되지만 조심하지 않으면 오버런이 발생할 수 있는 파워 스킬이에요.',
  ],
  홍염살: [
    '정열의 불꽃이 타오르는 이벤트예요. 매력적이지만 때로는 불꽃에 데일 수 있으니 조절이 필요해요.',
    '로맨스 이벤트 발생률이 상승하는 대신, 감정 조절 퀘스트의 난이도도 올라가는 양면 버프예요.',
    '열정적인 매력이 있지만, 그 열정이 때로는 소진으로 이어질 수 있는 "정열의 양날" 스킬이에요.',
  ],
  공망: [
    '특정 영역이 "안개 지대"처럼 비어 있는 상태예요. 하지만 빈 곳이 있어야 새로운 것을 채울 수 있는 거죠.',
    '일부 능력이 봉인된 듯 보이지만, 오히려 그 빈자리가 정신적 깊이를 만들어 주는 역설적 능력이에요.',
    '"비움의 미학"이 작동하는 영역이에요. 물질보다 정신적 가치에서 보물을 발견할 수 있는 특수 퀘스트예요.',
  ],
  괴강: [
    '극단적으로 강한 에너지를 가진 "전설급 무기"와 같아요. 잘 다루면 최강이지만, 제어가 필요한 스킬이에요.',
    '쎈 캐릭터라서 강한 보스전에는 유리하지만, 평화로운 마을 퀘스트에서는 힘 조절이 필요해요.',
    '카리스마와 추진력이 MAX인 대신, 유연성과 타협 스킬에 투자가 필요한 강력한 양면 스킬이에요.',
  ],
  백호: [
    '백호의 기운은 강한 결단력과 행동력을 부여하지만, 때로 급한 성격으로 나타날 수 있는 파워풀한 스킬이에요.',
    '위기 상황에서 엄청난 돌파력을 발휘하는 "백호의 포효" 스킬이에요. 평소엔 조절 모드를 유지하는 게 좋아요.',
    '강한 카리스마가 있지만 주변 관계에서는 부드러운 접근이 필요한 "호랑이형 리더" 스킬이에요.',
  ],
};

// ─────────────────────────────────────────────────────────────────────────────
//  도입 템플릿
// ─────────────────────────────────────────────────────────────────────────────

const INTRO_TEMPLATES: readonly string[] = [
  '{{이름}}님의 사주에는 특별한 신살(神煞)이 적중해 있어요! RPG 게임으로 치면, 캐릭터 생성 시 부여된 "특수 능력 목록"을 확인하는 순간이에요. 길신은 패시브 스킬처럼 자연스럽게 도움을 주고, 흉살은 흥미진진한 사이드 퀘스트를 열어 준답니다.',
  '모험가 {{이름}}님, 당신의 캐릭터 시트를 펼쳐볼 시간이에요! 신살은 태어날 때 자동으로 세팅된 "스킬 & 디버프 목록"이에요. 길신은 보물상자, 흉살은 도전 미션이라고 생각하면 돼요. 하나하나 살펴보면 정말 재미있는 발견이 있을 거예요.',
  '{{이름}}님의 사주 속 신살을 분석해 볼게요! 게임에서 캐릭터마다 고유 스킬이 있듯이, 사주에도 저마다 다른 신살이 적중해 있어요. 길신은 버프, 흉살은 디버프라고 보면 되는데, 흉살이라고 게임 오버는 아니에요. 오히려 흥미로운 사이드 퀘스트가 생기는 것과 비슷하답니다!',
  '캐릭터 빌드 분석 시작! {{이름}}님의 사주에 적중한 신살은 일종의 "장착 아이템 목록"이에요. 길신은 자동 장착된 행운의 액세서리, 흉살은 주의사항이 적힌 퀘스트 알림이라고 보면 돼요.',
  '{{이름}}님, 사주 캐릭터의 스킬 트리를 열어볼게요! 길신(吉神)은 따로 발동시키지 않아도 자연스럽게 도움을 주는 패시브 스킬이고, 흉살(凶煞)은 주의해야 할 디버프이지만, 미리 알고 대비하면 오히려 레벨업의 기회가 된답니다.',
  '모험의 시작이에요! {{이름}}님의 사주에서 발견된 신살은 게임 속 "숨겨진 퀘스트 트리거"와 같아요. 길신은 뜻밖의 보물 발견, 흉살은 도전적인 미니게임이에요. 자, 어떤 능력들이 세팅되어 있는지 함께 확인해 봐요!',
];

// ─────────────────────────────────────────────────────────────────────────────
//  길신 서술 템플릿
// ─────────────────────────────────────────────────────────────────────────────

const GOOD_OVERVIEW_TEMPLATES: readonly string[] = [
  '길신이 총 {{수}}개나 적중했어요! 이건 마치 게임 시작부터 레어 아이템이 {{수}}개나 인벤토리에 들어 있는 것과 같아요. 각각이 어떤 패시브 스킬인지 살펴볼게요.',
  '{{이름}}님은 무려 {{수}}개의 길신을 보유하고 있어요! RPG로 치면 캐릭터 생성 단계에서 "보너스 스킬 포인트"를 잔뜩 받은 셈이에요. 하나씩 열어볼까요?',
  '축하해요, {{이름}}님! 길신 {{수}}개가 활성화 상태예요. 이건 게임에서 "럭키 스타터 팩"을 장착하고 시작한 것과 같은 거예요. 어떤 버프들이 있는지 확인해 봐요!',
  '와, 길신이 {{수}}개나! {{이름}}님의 캐릭터는 패시브 스킬 슬롯이 꽉 차 있는 셈이에요. 각 스킬이 어떤 효과를 가지고 있는지 하나하나 열어볼게요.',
  '{{이름}}님의 스킬 트리에 길신 {{수}}개가 빛나고 있어요! 보물상자를 하나씩 열어보는 것처럼 각각의 효과를 살펴볼게요.',
];

const GOOD_ITEM_TEMPLATES: readonly string[] = [
  '패시브 스킬 발견! "{{신살명}}"이(가) {{위치}}에서 활성화되어 있어요. {{설명}}',
  '"{{신살명}}" 획득! ({{위치}}) — {{설명}}',
  '보물상자 오픈! {{위치}}에서 "{{신살명}}" 버프를 발견했어요. {{설명}}',
  '{{위치}}에 숨겨진 패시브 "{{신살명}}" 발견! {{설명}}',
  '스킬 슬롯에 "{{신살명}}"({{위치}})이 장착되어 있어요! {{설명}}',
];

// ─────────────────────────────────────────────────────────────────────────────
//  흉살 서술 템플릿
// ─────────────────────────────────────────────────────────────────────────────

const BAD_OVERVIEW_TEMPLATES: readonly string[] = [
  '흉살이 {{수}}개 적중했지만, 게임 오버는 절대 아니에요! RPG에서 난이도 높은 퀘스트일수록 보상도 크듯이, 이 도전들을 잘 대처하면 오히려 더 강해질 수 있어요.',
  '{{이름}}님에게 사이드 퀘스트가 {{수}}개 추가되었어요! 흉살이라고 무서워할 필요 없어요. 미리 알고 대비하는 것 자체가 최고의 방어 스킬이니까요.',
  '주의사항 {{수}}개가 표시되어 있어요. 하지만 RPG에서 경고 표시가 있는 곳에 숨겨진 보물이 있듯이, 이 도전들 속에도 성장의 기회가 숨어 있답니다.',
  '도전 미션 {{수}}개가 기다리고 있어요! 흉살은 "경고 표시"이지 "게임 오버 표시"가 아니에요. 오히려 이 미션들을 클리어하면 {{이름}}님의 캐릭터가 더욱 강해질 거예요.',
  '경고 알림 {{수}}개! 하지만 당황하지 마세요. 게임에서도 보스전 경고가 뜨면 오히려 장비를 점검하고 전략을 세우잖아요. 같은 맥락이에요!',
];

const BAD_ITEM_TEMPLATES: readonly string[] = [
  '사이드 퀘스트 감지! "{{신살명}}"이(가) {{위치}}에서 발동 중이에요. {{설명}}',
  '주의 알림: "{{신살명}}" ({{위치}}) — {{설명}}',
  '도전 미션 발견! {{위치}}에서 "{{신살명}}" 디버프가 감지되었어요. {{설명}}',
  '{{위치}}에 "{{신살명}}" 경고 표시가 있어요. {{설명}}',
  '"{{신살명}}"({{위치}}) 디버프가 활성 상태예요. {{설명}}',
];

// ─────────────────────────────────────────────────────────────────────────────
//  중립 개별 서술 템플릿
// ─────────────────────────────────────────────────────────────────────────────

const NEUTRAL_ITEM_TEMPLATES: readonly string[] = [
  '"{{신살명}}"이(가) {{위치}}에서 활성화되어 있어요. 상황에 따라 버프가 되기도, 디버프가 되기도 하는 양면 스킬이에요.',
  '{{위치}}에서 "{{신살명}}"이(가) 감지되었어요. 긍정도 부정도 아닌, 사용법에 따라 달라지는 변환 스킬인 셈이에요.',
  '"{{신살명}}" ({{위치}}) — 길흉이 정해지지 않은 중립 능력이에요. 어떻게 활용하느냐에 따라 결과가 달라지는 만능 스킬이에요.',
];

// ─────────────────────────────────────────────────────────────────────────────
//  마무리 템플릿
// ─────────────────────────────────────────────────────────────────────────────

const CLOSING_TEMPLATES: readonly string[] = [
  '신살 분석이 끝났어요! 길신은 이미 장착된 패시브 스킬이니 자신감을 가져도 좋고, 흉살은 "미리 아는 것이 최강의 방어"라는 점을 기억하세요. 이 정보를 활용해서 {{이름}}님만의 최적 빌드를 만들어 가세요!',
  '{{이름}}님의 캐릭터 스킬 시트 분석이 완료되었어요! 길신은 보물, 흉살은 도전이에요. 어떤 게임이든 도전이 있어야 재미있는 법이니까요. 이 모든 능력을 지혜롭게 활용해 보세요!',
  '자, 이제 {{이름}}님의 전체 스킬 목록을 확인했어요! RPG에서 캐릭터의 강점과 약점을 파악하는 것이 전략의 시작이듯, 이 신살 분석을 통해 인생 전략을 세워 보세요!',
  '스킬 트리 분석 완료! 모든 신살에는 의미가 있어요. 길신은 자산으로 활용하고, 흉살은 주의 표지판으로 삼으세요. {{이름}}님의 모험은 이제부터가 진짜 시작이에요!',
  '{{이름}}님의 캐릭터 빌드 분석이 끝났어요! 기억하세요 — 최고의 RPG 플레이어는 스탯이 높은 사람이 아니라, 자기 캐릭터를 가장 잘 이해하고 활용하는 사람이에요.',
];

const RATIO_COMMENT_GOOD_DOMINANT: readonly string[] = [
  '길신이 흉살보다 우세해요! 게임에서 말하는 "럭키 캐릭터 빌드"에 가까운 구성이에요. 기본적으로 행운 게이지가 높은 상태라니까요!',
  '버프가 디버프를 압도하는 밸런스예요! 기본 세팅이 좋으니, 이 패시브 스킬들을 최대한 활용하면 멋진 모험이 될 거예요.',
  '전체적으로 길신의 힘이 더 강해요. 마치 "이지 모드"에 가까운 빌드인 셈이에요. 물론 방심은 금물이지만, 자신감을 가져도 좋아요!',
];

const RATIO_COMMENT_BAD_DOMINANT: readonly string[] = [
  '흉살이 길신보다 좀 더 많지만, 절대 "하드 모드"라는 뜻이 아니에요! RPG에서 난이도가 높은 캐릭터일수록 마스터하면 더 강해지는 법이에요.',
  '도전 미션이 좀 많은 편이지만, 그만큼 클리어했을 때의 경험치도 어마어마해요. {{이름}}님은 "도전형 모험가" 빌드인 셈이에요!',
  '디버프가 좀 있지만, 게임에서도 디버프를 역이용하는 고수 플레이어들이 있잖아요. 이 도전들을 성장의 발판으로 삼으세요!',
];

const RATIO_COMMENT_BALANCED: readonly string[] = [
  '길신과 흉살이 비슷한 밸런스를 이루고 있어요. 장점도 있고 주의사항도 있는, 매우 현실적인 캐릭터 빌드예요.',
  '버프와 디버프가 균형을 이루고 있어요. 이것은 "밸런스형 캐릭터"라는 뜻이에요. 전략적으로 장점을 극대화하면 돼요!',
  '공격과 방어가 고르게 분배된 올라운드 빌드예요. 어떤 상황에서든 대처할 수 있는 안정적인 캐릭터 구성이에요.',
];

// ─────────────────────────────────────────────────────────────────────────────
//  신살 플레이버 텍스트 헬퍼
// ─────────────────────────────────────────────────────────────────────────────

const GENERIC_GOOD_FLAVORS: readonly string[] = [
  '좋은 기운이 감지되는 패시브 스킬이에요. 자연스럽게 도움을 주는 버프인 셈이에요.',
  '캐릭터에게 유리하게 작용하는 숨겨진 보너스 능력이에요.',
  '행운의 기운이 감도는 패시브 효과예요. 일상에서 은근히 도움이 되는 스킬이에요.',
  '보물상자에서 꺼낸 듯한 좋은 기운이에요. 평소에 자동으로 발동하는 패시브 버프예요.',
  '길한 에너지가 항상 함께하는 수호 버프예요. 별도로 발동시킬 필요 없이 알아서 작동해요.',
];

const GENERIC_BAD_FLAVORS: readonly string[] = [
  '약간의 주의가 필요한 디버프이지만, 미리 알고 대비하면 충분히 극복할 수 있어요.',
  '도전적인 사이드 퀘스트가 추가되는 셈이에요. 클리어하면 오히려 내면이 강해져요.',
  '경고 표시가 있는 구간이지만, 조심하면 문제없이 통과할 수 있는 수준이에요.',
  '약한 디버프가 걸린 상태이지만, 인생 경험치를 쌓는 데에는 오히려 도움이 될 수 있어요.',
  '주의력을 한 단계 높이라는 알림이에요. 경계심을 가지면 오히려 더 안전해지는 역설적 스킬이에요.',
];

function getShinsalFlavor(
  type: string,
  isGood: boolean,
  rng: { pick: <T>(arr: readonly T[]) => T },
): string {
  // 먼저 전용 매핑에서 찾기
  const nameOnly = type.replace(/\s*\(.*?\)\s*/g, '').trim();
  if (isGood) {
    const pool = SHINSAL_FLAVOR_GOOD[nameOnly];
    if (pool && pool.length > 0) return rng.pick(pool);
    return rng.pick(GENERIC_GOOD_FLAVORS);
  } else {
    const pool = SHINSAL_FLAVOR_BAD[nameOnly];
    if (pool && pool.length > 0) return rng.pick(pool);
    return rng.pick(GENERIC_BAD_FLAVORS);
  }
}

function normalizeShinsalName(type: string): string {
  return type.replace(/\s*\(.*?\)\s*/g, '').trim();
}

function stableHash(input: string): number {
  let hash = 0;
  for (let i = 0; i < input.length; i += 1) {
    hash = (Math.imul(hash, 31) + input.charCodeAt(i)) | 0;
  }
  return hash >>> 0;
}

function pickStable<T>(items: readonly T[], key: string): T | null {
  if (items.length === 0) return null;
  return items[stableHash(key) % items.length] ?? null;
}

function enrichGoodShinsalFlavor(hit: { type: string; position: string }, baseFlavor: string): string {
  const entry = findShinsalEntry(hit.type);
  if (!entry || entry.category !== '길신') return baseFlavor;

  const key = `${normalizeShinsalName(hit.type)}|${hit.position || ''}`;
  const strength = pickStable(entry.strengthsOrRisks, `${key}|strength`);
  const habit = pickStable(entry.dailyHabits, `${key}|habit`);

  const details: string[] = [baseFlavor, `백과 해설: ${entry.shortMeaning}`];
  if (strength) details.push(`핵심 강점: ${strength}`);
  if (habit) details.push(`추천 습관: ${habit}`);
  return details.join(' ');
}

function buildDailyHabitHighlight(hits: readonly ClassifiedHit[]): string | null {
  for (const hit of hits) {
    const entry = findShinsalEntry(hit.type);
    if (!entry || entry.dailyHabits.length === 0) continue;

    const habit = pickStable(
      entry.dailyHabits,
      `${normalizeShinsalName(hit.type)}|${hit.position || ''}|highlight`,
    );
    if (habit) return `${entry.koreanName}: ${habit}`;
  }
  return null;
}

// ─────────────────────────────────────────────────────────────────────────────
//  길흉 분류 헬퍼
// ─────────────────────────────────────────────────────────────────────────────

interface ClassifiedHit {
  type: string;
  position: string;
  baseWeight: number;
  weightedScore: number;
  grade: string;
  category: 'good' | 'bad' | 'neutral';
}

function classifyHit(hit: {
  type: string;
  position: string;
  baseWeight: number;
  weightedScore: number;
  grade: string;
}): ClassifiedHit {
  let category: 'good' | 'bad' | 'neutral';

  // grade 기반 1차 판정
  const gradeLower = (hit.grade ?? '').toLowerCase();
  if (gradeLower === 'auspicious' || gradeLower.includes('길') || gradeLower.includes('auspicious')) {
    category = 'good';
  } else if (gradeLower === 'inauspicious' || gradeLower.includes('흉') || gradeLower.includes('inauspicious')) {
    category = 'bad';
  } else if (hit.baseWeight > 0) {
    category = 'good';
  } else if (hit.baseWeight < 0) {
    category = 'bad';
  } else {
    category = 'neutral';
  }

  return { ...hit, category };
}

// ─────────────────────────────────────────────────────────────────────────────
//  메인 생성 함수
// ─────────────────────────────────────────────────────────────────────────────

export function generateShinsalSection(input: ReportInput): ReportSection | null {
  const rng = createRng(input);
  for (let i = 0; i < 26; i++) rng.next();

  const name = safeName(input);
  const hits = input.saju.shinsalHits ?? [];
  if (hits.length === 0) return null;

  // 길흉 분류
  const classified = hits.map(classifyHit);
  const goodHits = classified.filter(h => h.category === 'good');
  const badHits = classified.filter(h => h.category === 'bad');
  const neutralHits = classified.filter(h => h.category === 'neutral');

  // 점수 합산
  let goodScore = 0;
  let badScore = 0;

  for (const h of goodHits) {
    goodScore += Math.abs(h.weightedScore || h.baseWeight || 0);
  }
  for (const h of badHits) {
    badScore += Math.abs(h.weightedScore || h.baseWeight || 0);
  }

  const paragraphs: ReportParagraph[] = [];

  // ── 도입 ──
  paragraphs.push(narrative(pickAndFill(rng, INTRO_TEMPLATES, { 이름: name })));

  // ── 길흉 비율 코멘트 ──
  if (goodScore > badScore * 1.3) {
    paragraphs.push(positive(pickAndFill(rng, RATIO_COMMENT_GOOD_DOMINANT, { 이름: name })));
  } else if (badScore > goodScore * 1.3) {
    paragraphs.push(encouraging(pickAndFill(rng, RATIO_COMMENT_BAD_DOMINANT, { 이름: name })));
  } else {
    paragraphs.push(narrative(pickAndFill(rng, RATIO_COMMENT_BALANCED, { 이름: name })));
  }

  // ── 길신 상세 분석 (최대 5개) ──
  if (goodHits.length > 0) {
    paragraphs.push(emphasis(pickAndFill(rng, GOOD_OVERVIEW_TEMPLATES, {
      이름: name,
      수: String(goodHits.length),
    })));

    const displayGood = goodHits.slice(0, 5);
    for (const hit of displayGood) {
      const flavor = enrichGoodShinsalFlavor(
        hit,
        getShinsalFlavor(hit.type, true, rng),
      );
      const text = pickAndFill(rng, GOOD_ITEM_TEMPLATES, {
        신살명: hit.type || '미상',
        위치: hit.position || '사주',
        설명: flavor,
      });
      paragraphs.push(positive(text));
    }
    if (goodHits.length > 5) {
      paragraphs.push(tip(
        `이 외에도 ${goodHits.length - 5}개의 길신이 더 있어요! 전체 목록은 아래 테이블에서 확인할 수 있어요.`,
      ));
    }
  }

  // ── 흉살 상세 분석 (최대 5개) ──
  if (badHits.length > 0) {
    paragraphs.push(emphasis(pickAndFill(rng, BAD_OVERVIEW_TEMPLATES, {
      이름: name,
      수: String(badHits.length),
    })));

    const displayBad = badHits.slice(0, 5);
    for (const hit of displayBad) {
      const flavor = getShinsalFlavor(hit.type, false, rng);
      const text = pickAndFill(rng, BAD_ITEM_TEMPLATES, {
        신살명: hit.type || '미상',
        위치: hit.position || '사주',
        설명: flavor,
      });
      paragraphs.push(caution(text));
    }
    if (badHits.length > 5) {
      paragraphs.push(tip(
        `이 외에도 ${badHits.length - 5}개의 흉살이 더 있지만, 미리 아는 것이 최강의 방어라는 걸 기억하세요!`,
      ));
    }
  }

  // ── 중립 신살이 있으면 간단히 언급 ──
  if (neutralHits.length > 0) {
    paragraphs.push(narrative(
      `그 외에 길흉이 정해지지 않은 중립 신살이 ${neutralHits.length}개 있어요. `
      + '이것들은 상황에 따라 버프가 되기도, 디버프가 되기도 하는 양면 스킬이에요.',
    ));
    // 중립 중 최대 2개만 간단 언급
    for (const hit of neutralHits.slice(0, 2)) {
      const text = pickAndFill(rng, NEUTRAL_ITEM_TEMPLATES, {
        신살명: hit.type || '미상',
        위치: hit.position || '사주',
      });
      paragraphs.push(narrative(text));
    }
  }

  // ── 마무리 ──
  paragraphs.push(encouraging(pickAndFill(rng, CLOSING_TEMPLATES, { 이름: name })));

  // ── 테이블: 전체 신살 목록 ──
  const table: ReportTable = {
    title: '적중 신살 전체 목록',
    headers: ['신살명', '위치', '길흉', '기본 가중치', '보정 점수'],
    rows: classified.map(h => [
      h.type || '미상',
      h.position || '-',
      h.category === 'good' ? '길(吉)' : h.category === 'bad' ? '흉(凶)' : '중립',
      String(Math.round((h.baseWeight ?? 0) * 100) / 100),
      String(Math.round((h.weightedScore ?? 0) * 100) / 100),
    ]),
  };

  // ── 도넛 차트: 길신 vs 흉살 점수 ──
  const chart: ReportChart = {
    type: 'donut',
    title: '길신 vs 흉살 점수 비율',
    data: {
      '길신 점수': Math.round(goodScore * 100) / 100,
      '흉살 점수': Math.round(badScore * 100) / 100,
    },
    meta: {
      goodCount: goodHits.length,
      badCount: badHits.length,
      neutralCount: neutralHits.length,
    },
  };

  // ── 하이라이트 ──
  const highlights: ReportHighlight[] = [
    {
      label: '길신 수',
      value: `${goodHits.length}개`,
      sentiment: 'good',
    },
    {
      label: '흉살 수',
      value: `${badHits.length}개`,
      sentiment: badHits.length > goodHits.length ? 'caution' : 'neutral',
    },
    {
      label: '총 신살',
      value: `${hits.length}개`,
      sentiment: 'neutral',
    },
  ];

  const dailyHabitHighlight = buildDailyHabitHighlight([...goodHits, ...badHits, ...neutralHits]);
  if (dailyHabitHighlight) {
    highlights.push({
      label: '실전 루틴',
      value: dailyHabitHighlight,
      sentiment: 'good',
    });
  }

  return {
    id: 'shinsalGood',
    title: '신살(神煞) 분석',
    subtitle: '사주 속 특수 능력 & 퀘스트 목록',
    paragraphs,
    tables: [table],
    charts: [chart],
    highlights,
  };
}
