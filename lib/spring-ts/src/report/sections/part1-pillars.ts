/**
 * part1-pillars.ts -- 사주 원국표(Four Pillars Chart) 섹션 생성기
 *
 * PART 1-1에 해당하며, 사주팔자의 네 기둥(연주/월주/일주/시주)을
 * 표와 해설 문단으로 구성합니다.
 *
 * - 모든 텍스트는 한국어, 초등/중학생도 읽을 수 있는 친근한 존댓말
 * - SeededRandom을 사용하여 동일 입력이면 동일 결과를 보장하면서도
 *   다양한 템플릿 변형을 제공합니다.
 */

import type {
  ReportInput,
  ReportSection,
  ReportTable,
  ReportHighlight,
  ReportParagraph,
} from '../types.js';

import {
  STEMS,
  BRANCHES,
  STEM_BY_CODE,
  STEM_BY_HANGUL,
  BRANCH_BY_CODE,
  BRANCH_BY_HANGUL,
  ELEMENT_KOREAN,
  ELEMENT_KOREAN_SHORT,
  ELEMENT_HANJA,
  ELEMENT_COLOR,
  elementCodeToKorean,
  yinYangToKorean,
  lookupStemInfo,
  lookupBranchInfo,
  type StemInfo,
  type BranchInfo,
} from '../common/elementMaps.js';

import {
  SeededRandom,
  createRng,
  pickAndFill,
  fillTemplate,
  narrative,
  positive,
  emphasis,
  tip,
  joinSentences,
  withParticle,
  eunNeun,
  iGa,
  eulReul,
} from '../common/sentenceUtils.js';

import {
  getBranchEncyclopediaEntry,
  type BranchEncyclopediaEntry,
} from '../knowledge/branchEncyclopedia.js';

// ---------------------------------------------------------------------------
//  상수: 기둥 이름 매핑
// ---------------------------------------------------------------------------

/** 기둥 키 순서 (시주 -> 일주 -> 월주 -> 연주, 전통 우->좌 표기) */
const PILLAR_KEYS = ['hour', 'day', 'month', 'year'] as const;
type PillarKey = (typeof PILLAR_KEYS)[number];

const PILLAR_KOREAN: Record<PillarKey, string> = {
  year: '연주(年柱)',
  month: '월주(月柱)',
  day: '일주(日柱)',
  hour: '시주(時柱)',
};

const PILLAR_KOREAN_SHORT: Record<PillarKey, string> = {
  year: '연주',
  month: '월주',
  day: '일주',
  hour: '시주',
};

const PILLAR_MEANING: Record<PillarKey, string> = {
  year: '태어난 해',
  month: '태어난 달',
  day: '태어난 날',
  hour: '태어난 시간',
};

// ---------------------------------------------------------------------------
//  오행별 자연 비유 (아이들이 이해하기 쉬운 표현)
// ---------------------------------------------------------------------------

const ELEMENT_CHILD_METAPHOR: Record<string, string> = {
  WOOD: '싱싱한 나무',
  FIRE: '활활 타는 불꽃',
  EARTH: '든든한 땅',
  METAL: '반짝이는 쇠붙이',
  WATER: '시원한 물',
};

const ELEMENT_EMOJI_DESC: Record<string, string> = {
  WOOD: '봄에 새싹이 올라오듯 자라나는 힘',
  FIRE: '여름 태양처럼 밝고 따뜻한 힘',
  EARTH: '넓은 들판처럼 모든 걸 받아주는 힘',
  METAL: '가을 하늘처럼 맑고 단단한 힘',
  WATER: '겨울 눈처럼 고요하고 깊은 힘',
};

// ---------------------------------------------------------------------------
//  템플릿 풀: 도입부 (사주팔자란 무엇인가)
// ---------------------------------------------------------------------------

const INTRO_TEMPLATES: readonly string[] = [
  '사주팔자란 태어난 해, 달, 날, 시간을 나타내는 여덟 글자예요.',
  '사주팔자는 태어난 순간의 해, 달, 날, 시간을 여덟 글자로 기록한 거예요.',
  '사주(四柱)란 네 개의 기둥이라는 뜻이고, 팔자(八字)란 여덟 글자라는 뜻이에요.',
  '우리가 태어난 해, 달, 날, 시간에는 각각 두 글자씩 숨어 있어요. 그래서 "사주팔자"라고 불러요.',
  '사주팔자는 생년, 생월, 생일, 생시를 동양의 옛 달력으로 표현한 여덟 글자랍니다.',
  '옛날부터 사람들은 태어난 시간에 특별한 비밀이 담겨 있다고 생각했어요. 그걸 여덟 글자로 적은 것이 사주팔자예요.',
  '사주팔자는 우리가 세상에 처음 나온 순간의 하늘과 땅의 기운을 여덟 글자로 적은 거예요.',
  '태어난 해, 달, 날, 시간마다 고유한 글자가 있어요. 이 여덟 글자를 모아 놓은 것이 바로 사주팔자랍니다.',
  '동양에서는 태어난 시간을 천간(하늘 글자)과 지지(땅 글자)로 적어요. 네 기둥, 여덟 글자 -- 이것이 사주팔자예요.',
  '사주팔자는 나만의 "시간 주민등록번호" 같은 거예요. 태어난 해, 달, 날, 시간이 모두 담겨 있거든요.',
  '태어난 해의 글자, 달의 글자, 날의 글자, 시간의 글자. 이 네 쌍(사주)의 여덟 글자(팔자)가 나를 설명해 준답니다.',
  '사주팔자란 나의 탄생 순간을 동양 전통 달력의 여덟 글자로 바꿔 적은 것이에요.',
  '세상에 태어난 바로 그 순간, 하늘과 땅이 어떤 기운이었는지를 여덟 글자로 표현한 것이 사주팔자예요.',
  '사주는 "네 기둥"이라는 뜻이에요. 각 기둥에 천간 한 글자, 지지 한 글자가 올라가서 합치면 여덟 글자가 돼요.',
  '사주팔자는 천 년 넘게 이어져 온 동양의 시간 표기법으로, 태어난 순간의 기운을 여덟 글자에 담아 놓은 거예요.',
  '생년, 생월, 생일, 생시 각각에 위아래 두 글자가 붙어요. 위 글자(천간)는 하늘, 아래 글자(지지)는 땅의 기운이에요.',
  '사주팔자는 마치 하늘이 내 탄생에 맞춰 적어 준 특별한 편지 같은 거예요.',
  '우리가 태어난 시간 속에 숨어 있는 여덟 개의 한자, 그것이 바로 사주팔자예요.',
  '태어난 해, 달, 날, 시간 -- 네 가지 시간 정보를 동양식 한자로 바꾸면 여덟 글자가 돼요. 이걸 사주팔자라고 해요.',
  '마치 생년월일이 나의 신분증이듯, 사주팔자는 나의 타고난 기운 증명서라고 할 수 있어요.',
  '사주팔자는 내가 태어난 순간을 하늘의 시계와 땅의 달력으로 기록한 여덟 글자 암호예요.',
  '옛 현인들은 태어난 순간의 시간 속에 그 사람의 이야기가 들어 있다고 보았어요. 그래서 사주팔자를 만들었답니다.',
];

// ---------------------------------------------------------------------------
//  템플릿 풀: 도입부 부연 (비유/격려)
// ---------------------------------------------------------------------------

const INTRO_METAPHOR_TEMPLATES: readonly string[] = [
  '마치 태어날 때 하늘이 선물해준 특별한 암호 같은 거랍니다!',
  '이 여덟 글자는 마치 나만의 보물 지도 같아요. 나의 강점과 가능성이 숨어 있거든요!',
  '사주팔자는 일종의 "나만의 레시피"예요. 어떤 재료(기운)가 섞여 있는지 알 수 있답니다.',
  '마치 게임 캐릭터의 초기 능력치처럼, 사주팔자에는 나의 타고난 특성이 담겨 있어요.',
  '밤하늘의 별자리처럼, 태어난 시간마다 독특한 기운의 조합이 만들어져요.',
  '사주팔자는 나만의 특별한 설계도예요. 어떤 잠재력이 있는지 하나하나 살펴볼 수 있답니다.',
  '꽃씨마다 피울 꽃이 다르듯이, 사주팔자마다 담긴 기운과 이야기가 모두 달라요.',
  '마치 내가 태어난 날의 날씨와 계절이 어땠는지를 글자로 기록한 것과 비슷해요.',
  '세상에 나와 똑같은 사주를 가진 사람은 아주 드물어요. 그만큼 특별한 조합이랍니다!',
  '사주팔자는 나를 이해하는 첫걸음이에요. 내가 어떤 기운을 타고났는지 알 수 있거든요.',
  '이 여덟 글자 속에는 봄, 여름, 가을, 겨울 같은 자연의 기운이 골고루 담겨 있어요.',
  '마치 나만의 DNA처럼, 사주팔자에는 내가 타고난 성격과 재능의 실마리가 들어 있어요.',
  '하늘(천간)과 땅(지지)이 만나 이 특별한 여덟 글자를 만들었어요. 정말 신비롭지요?',
  '사주팔자를 알면 나에게 어울리는 색깔, 방향, 음식까지 알 수 있답니다. 재미있지 않나요?',
  '이 여덟 글자는 나의 과거, 현재, 미래를 이어 주는 다리 같은 역할을 해요.',
  '사주팔자를 보는 건 마치 거울 속의 나를 한 발짝 떨어져서 바라보는 것과 같아요.',
  '이 암호를 하나하나 풀다 보면 "아, 내가 이래서 그랬구나!" 하고 고개를 끄덕이게 될 거예요.',
  '사주팔자는 점이 아니에요. 나의 타고난 기운을 과학적으로 분류한 동양의 지혜랍니다.',
  '마치 음악에 악보가 있듯이, 내 인생에도 사주팔자라는 악보가 있는 셈이에요.',
  '여덟 글자 하나하나에 오행(나무, 불, 흙, 쇠, 물)의 기운이 담겨 있어서, 읽으면 읽을수록 재미있어요.',
  '지금부터 함께 이 여덟 글자의 비밀을 하나씩 풀어 볼까요?',
  '자, 그럼 지금부터 이 신비로운 여덟 글자를 하나씩 살펴보겠습니다!',
];

// ---------------------------------------------------------------------------
//  템플릿 풀: 원국표 설명 (표 바로 위 또는 아래)
// ---------------------------------------------------------------------------

const TABLE_INTRO_TEMPLATES: readonly string[] = [
  '아래 표는 {{이름}}님의 사주 원국표예요. 네 기둥에 각각 하늘 글자(천간)와 땅 글자(지지)가 들어 있어요.',
  '다음은 {{이름}}님의 사주팔자를 표로 정리한 것이에요. 위 칸은 천간, 아래 칸은 지지랍니다.',
  '{{이름}}님의 네 기둥을 표로 만들어 봤어요. 한눈에 여덟 글자를 확인할 수 있답니다.',
  '아래 표에서 윗줄이 천간(하늘의 기운), 아랫줄이 지지(땅의 기운)예요. {{이름}}님만의 특별한 조합이에요.',
  '{{이름}}님이 태어난 순간의 기운을 네 기둥으로 정리하면 이런 모습이에요.',
  '여기에 {{이름}}님의 사주 원국표가 있어요. 맨 위가 천간, 그 아래가 지지예요.',
  '이제 {{이름}}님의 사주 원국표를 함께 볼까요? 총 여덟 글자가 네 기둥에 나뉘어 있어요.',
  '{{이름}}님의 사주팔자를 한눈에 보기 좋게 표로 만들었어요. 위 행은 천간, 아래 행은 지지랍니다.',
  '사주 원국표란 네 기둥의 천간과 지지를 한곳에 모아 보여 주는 표예요. {{이름}}님의 표를 확인해 보세요!',
  '아래의 표가 바로 {{이름}}님의 사주팔자 원국표예요. 위 줄은 하늘의 기운, 아래 줄은 땅의 기운이에요.',
  '{{이름}}님의 여덟 글자를 시주, 일주, 월주, 연주 순으로 배열한 원국표입니다.',
  '자, 이것이 {{이름}}님의 사주 원국 표예요. 각 칸에 적힌 한자가 어떤 기운인지 함께 알아볼게요.',
  '{{이름}}님의 탄생 시간을 동양식으로 표기하면 다음과 같은 네 기둥이 만들어져요.',
  '표에서 시주(태어난 시간), 일주(태어난 날), 월주(태어난 달), 연주(태어난 해) 순으로 왼쪽부터 배치했어요.',
  '천간은 하늘에서 내려오는 기운, 지지는 땅에서 올라오는 기운이에요. {{이름}}님의 기운 조합을 확인해 보세요.',
  '옛날에는 이 표를 직접 붓으로 써서 소중히 간직했다고 해요. {{이름}}님의 원국표도 그만큼 소중해요.',
  '다음 표에는 {{이름}}님이 가진 여덟 글자의 한글, 한자, 오행, 음양이 모두 나와 있어요.',
  '{{이름}}님의 사주 네 기둥을 보기 쉽게 정리했어요. 천간과 지지, 그리고 각각의 오행을 함께 표시했답니다.',
  '이 표는 {{이름}}님만의 고유한 사주 원국이에요. 세상에 이와 완전히 같은 조합은 매우 드물답니다.',
  '사주 원국표는 네 기둥에 천간(위)과 지지(아래)를 배치한 거예요. {{이름}}님의 표를 살펴볼까요?',
  '{{이름}}님의 사주팔자를 가장 알아보기 쉽게 정리한 것이 바로 아래 원국표예요.',
];

// ---------------------------------------------------------------------------
//  템플릿 풀: 일간(나) 설명
// ---------------------------------------------------------------------------

const DAY_MASTER_TEMPLATES: readonly string[] = [
  '사주에서 가장 중요한 글자는 일주의 천간, 즉 "일간"이에요. {{이름}}님의 일간은 {{일간한글}}({{일간한자}})로, {{오행}}의 기운을 가지고 있어요.',
  '일간은 "나 자신"을 뜻하는 글자예요. {{이름}}님은 {{일간한글}}({{일간한자}}), {{오행}} 기운을 타고났어요.',
  '네 기둥 중에서 태어난 날의 천간인 "일간"이 나를 대표해요. {{이름}}님의 일간은 {{일간한글}}({{일간한자}})이고, 오행은 {{오행}}이에요.',
  '사주팔자의 주인공은 바로 일간이에요. {{이름}}님의 일간 {{일간한글}}({{일간한자}})은 {{오행}}의 기운으로, {{오행비유}} 같은 에너지를 가지고 있어요.',
  '{{이름}}님의 일간(나를 나타내는 글자)은 {{일간한글}}({{일간한자}})이에요. {{오행}} 기운을 타고나셨답니다.',
  '일간은 사주의 중심이자 나 자신이에요. {{이름}}님은 {{일간한글}}({{일간한자}})로, {{오행}}의 성질을 지니고 계세요.',
  '태어난 날의 하늘 글자(일간)가 바로 "나"예요. {{이름}}님의 일간은 {{일간한글}}({{일간한자}}), {{오행}}에 해당해요.',
  '사주에서 나를 가장 잘 나타내는 글자는 일간이에요. {{이름}}님은 {{일간한글}}({{일간한자}})이며, {{음양}} {{오행}}의 기운이에요.',
  '{{이름}}님의 사주에서 중심이 되는 글자는 일간 {{일간한글}}({{일간한자}})이에요. 이 글자가 {{오행}}의 기운을 품고 있답니다.',
  '일간은 쉽게 말해 "사주의 주인공"이에요. {{이름}}님의 주인공 글자는 {{일간한글}}({{일간한자}})이고, {{오행}} 기운에 속해요.',
  '"나"를 대표하는 일간 {{일간한글}}({{일간한자}})은 {{오행비유}} 같은 기운이에요. {{이름}}님의 근본적인 성질을 보여 주는 글자랍니다.',
  '{{이름}}님이 타고난 기운의 핵심은 일간 {{일간한글}}({{일간한자}})이에요. {{오행}} 기운이 기본 바탕이 됩니다.',
  '일주의 천간인 {{일간한글}}({{일간한자}})이 {{이름}}님을 나타내는 글자예요. 오행으로는 {{오행}}, 음양으로는 {{음양}}에 해당해요.',
  '{{이름}}님의 사주 중심에는 일간 {{일간한글}}({{일간한자}})이 자리 잡고 있어요. {{오행비유}} 같은 성질이라고 생각하면 돼요.',
  '사주의 여덟 글자 중에서도 가장 핵심은 일간이에요. {{이름}}님의 일간은 {{음양}}의 {{오행}}인 {{일간한글}}({{일간한자}})이에요.',
  '{{이름}}님은 일간이 {{일간한글}}({{일간한자}})이에요. 이것은 {{오행}} 기운으로, {{오행설명}} 같은 에너지랍니다.',
  '사주에서 "나"에 해당하는 일간 {{일간한글}}({{일간한자}})은 {{오행}} 기운을 가졌어요. {{이름}}님의 기본 성질이 여기에 담겨 있어요.',
  '일간을 알면 나의 기본 성격과 기질을 이해할 수 있어요. {{이름}}님의 일간 {{일간한글}}({{일간한자}})은 {{오행}}에 해당해요.',
  '{{이름}}님의 일간은 {{일간한글}}({{일간한자}})이에요. {{오행}} 기운답게, {{오행비유}}의 성질을 가지고 있답니다.',
  '사주를 읽을 때 항상 일간부터 봐요. {{이름}}님의 일간 {{일간한글}}({{일간한자}})은 {{오행}} 기운으로, 이것이 나머지 일곱 글자와 어떤 관계를 맺는지 살펴보게 됩니다.',
  '내 사주의 출발점인 일간 {{일간한글}}({{일간한자}})은 {{음양}} {{오행}}이에요. {{이름}}님의 모든 사주 해석은 이 글자에서 시작됩니다.',
];

// ---------------------------------------------------------------------------
//  템플릿 풀: 기둥별 설명 도입
// ---------------------------------------------------------------------------

const PILLAR_DESC_YEAR_TEMPLATES: readonly string[] = [
  '연주는 태어난 해를 나타내요. 조상과 가문의 기운, 어린 시절의 환경을 보여 준답니다.',
  '연주(年柱)는 태어난 해의 기운이에요. 집안의 분위기와 유년기의 환경이 담겨 있어요.',
  '태어난 해를 뜻하는 연주에는 가문의 뿌리와 어린 시절의 운이 담겨 있어요.',
  '연주는 나의 뿌리예요. 부모님과 조부모님에게서 물려받은 기운이 이 기둥에 나타나요.',
  '연주는 마치 나무의 뿌리 같아요. 가문의 기운과 초년운을 알려 주는 기둥이에요.',
  '태어난 해의 기둥인 연주는 내가 자란 환경, 조상의 영향을 나타내는 기둥이에요.',
  '연주는 나의 첫 번째 기둥으로, 가족의 배경과 어린 시절 환경을 보여 준답니다.',
  '연주를 보면 내가 어떤 가정 환경에서 태어났는지, 초년기에 어떤 기운이 함께하는지 알 수 있어요.',
  '연주는 "나를 둘러싼 세상"을 나타내요. 가문의 기운과 사회적 배경이 이 기둥에 담겨 있어요.',
  '태어난 해의 글자인 연주에는 조상님들이 물려주신 기운이 고스란히 담겨 있어요.',
  '연주는 나이로 치면 1세부터 약 15~20세까지의 운을 나타낸다고 봐요.',
  '연주(年柱)는 태어난 해의 간지예요. 가문의 에너지와 성장 배경을 보여 주는 첫 기둥이에요.',
  '연주는 내 사주의 가장 바깥쪽 기둥이에요. 사회와 맞닿는 나의 배경을 알려 주지요.',
  '태어난 해를 기록한 연주는 할아버지, 할머니, 그리고 부모님의 기운이 느껴지는 기둥이에요.',
  '연주는 내가 태어난 시대와 집안의 분위기를 담고 있어요. 인생의 첫 챕터라고 할 수 있지요.',
  '연주에 어떤 오행이 있느냐에 따라 어린 시절의 환경과 분위기가 달라진다고 해요.',
  '연주를 보면 내가 어떤 시대적 기운 속에서 태어났는지를 알 수 있어요.',
  '연주는 나의 "출발선"이에요. 어디서 시작했는지에 따라 여정이 달라지듯, 연주는 인생의 출발점을 나타내요.',
  '태어난 해의 천간과 지지가 연주를 이뤄요. 이 기둥은 가문, 환경, 초년기를 총괄하는 기둥이에요.',
  '연주는 큰 틀에서 나의 인생 배경을 보여 주는 기둥이랍니다. 뿌리가 튼튼해야 나무가 잘 자라듯이요.',
  '연주는 나의 뿌리이자 조상에게서 물려받은 에너지를 나타내 줘요.',
];

const PILLAR_DESC_MONTH_TEMPLATES: readonly string[] = [
  '월주는 태어난 달을 나타내요. 부모님의 영향과 학창 시절 운이 담겨 있어요.',
  '월주(月柱)는 태어난 달의 기운이에요. 사회생활과 직업 운을 가장 많이 보여 주는 기둥이에요.',
  '태어난 달의 기둥인 월주에는 부모님의 기운과 청년기의 운이 들어 있어요.',
  '월주는 나무로 치면 줄기 같은 곳이에요. 나의 사회적 역할과 직업 적성을 알려 줘요.',
  '월주는 사주에서 아주 중요한 기둥이에요. 나의 성격 형성과 사회적 능력에 큰 영향을 미쳐요.',
  '태어난 달의 기운인 월주는 부모님의 영향력과 성장 과정을 나타내는 기둥이에요.',
  '월주에는 내가 세상과 어떻게 소통하는지, 어떤 직업이 잘 맞는지의 힌트가 담겨 있어요.',
  '월주는 나이로 치면 약 20~40세의 운을 나타낸다고 해요. 인생에서 가장 활발한 시기이지요.',
  '월주를 보면 사회에서 어떤 역할을 잘 해낼 수 있는지 알 수 있어요.',
  '월주(月柱)는 태어난 달의 간지로, 부모님과 사회 환경의 영향이 가장 짙은 기둥이에요.',
  '월주는 내 사주에서 "배움과 성장"을 담당하는 기둥이에요. 학교, 직업, 사회활동과 관련이 깊어요.',
  '태어난 달을 기록한 월주는 내가 가장 활발하게 활동하는 시기의 기운을 보여 줘요.',
  '월주는 격국(내 사주의 유형)을 정할 때 가장 중요하게 보는 기둥이에요.',
  '월주에 어떤 오행이 있느냐에 따라 나의 사회적 성향과 대인관계 스타일이 달라져요.',
  '월주는 부모님의 에너지와 사회적 성취를 함께 나타내는, 사주에서 매우 중요한 기둥이에요.',
  '월주를 보면 내가 어떤 분야에서 빛날 수 있는지 감을 잡을 수 있어요.',
  '월주는 사주의 "허리" 같은 존재예요. 기둥들 사이에서 중심을 잡아 주는 역할을 하거든요.',
  '태어난 달의 천간과 지지가 월주를 이뤄요. 학업, 진로, 사회적 관계를 두루 살필 수 있는 기둥이에요.',
  '월주는 나의 발전 가능성과 사회적 역할을 나타내 줘요. 한마디로 "성장의 기둥"이에요.',
  '월주에 담긴 기운은 나의 직업 적성과 대인 관계에 큰 영향을 미쳐요.',
  '월주는 내 사주의 계절을 결정하는 기둥이에요. 봄, 여름, 가을, 겨울 중 어느 계절에 태어났는지가 이 기둥에 나타나요.',
];

const PILLAR_DESC_DAY_TEMPLATES: readonly string[] = [
  '일주는 태어난 날을 나타내요. 나 자신과 배우자의 기운이 담긴 가장 핵심적인 기둥이에요.',
  '일주(日柱)는 태어난 날의 기운이에요. 특히 일간(위 글자)은 바로 "나"를 뜻해요.',
  '일주는 사주의 중심이에요. 위의 천간(일간)이 나 자신, 아래의 지지(일지)가 나의 내면과 배우자를 나타내요.',
  '일주는 나무로 치면 열매 같은 곳이에요. 나의 본질과 가까운 사람과의 관계가 여기에 있어요.',
  '태어난 날의 기둥인 일주는 나의 성격, 가치관, 그리고 가장 가까운 인연을 나타내요.',
  '일주의 천간(일간)은 나 자신, 지지(일지)는 나의 마음속 깊은 곳과 배우자를 의미해요.',
  '일주는 사주팔자에서 가장 중요한 기둥이에요. 모든 해석의 기준이 바로 이 기둥에서 시작돼요.',
  '일주에는 "나"라는 사람의 본질이 담겨 있어요. 성격, 취향, 인간관계의 핵심이 모두 여기에 있어요.',
  '나이로 치면 약 40~60세의 운에 해당하지만, 일간은 평생 나를 대표하는 글자예요.',
  '일주는 내 사주의 "심장" 같은 곳이에요. 이 기둥이 나머지 기둥들과 어울려 나의 이야기를 만들어요.',
  '일주(日柱)의 위 글자가 일간으로, 사주 해석의 모든 출발점이에요. 나머지 일곱 글자는 일간과의 관계로 해석돼요.',
  '태어난 날의 천간과 지지가 일주를 이뤄요. 이 기둥이 나의 정체성을 가장 잘 보여 줘요.',
  '일주는 "오늘의 나"를 나타내는 기둥이에요. 매일의 컨디션과 내면의 바탕이 여기에 있어요.',
  '일주의 일간은 나의 자아, 일지는 나의 감정과 가정 환경을 나타내요.',
  '일주를 보면 나라는 사람이 어떤 성격인지, 어떤 사람과 잘 맞는지 알 수 있어요.',
  '일주는 내 인생의 가장 깊은 곳, "진짜 나"를 보여 주는 기둥이에요.',
  '일주에 어떤 오행이 있느냐에 따라 나의 기본 성격과 가치관이 크게 달라져요.',
  '일주는 사주의 왕이라고 할 수 있어요. 다른 기둥들은 모두 이 왕을 보좌하는 역할을 하거든요.',
  '일주의 천간인 일간이야말로 사주팔자의 진정한 주인공이에요. 나머지는 모두 일간의 관계자예요.',
  '일주는 "나"의 정체성이에요. 여기서 출발해서 다른 기둥들과의 관계를 하나씩 분석하게 됩니다.',
  '일주가 사주에서 차지하는 비중은 정말 커요. 나의 핵심 성향과 배우자 운까지 이 기둥에서 읽을 수 있거든요.',
];

const PILLAR_DESC_HOUR_TEMPLATES: readonly string[] = [
  '시주는 태어난 시간을 나타내요. 자녀의 기운과 말년의 운이 담겨 있어요.',
  '시주(時柱)는 태어난 시간의 기운이에요. 인생 후반부와 자녀 운을 보여 주는 기둥이에요.',
  '태어난 시간의 기둥인 시주에는 인생의 결실과 노년기의 운이 들어 있어요.',
  '시주는 나무로 치면 꽃이나 열매 같은 곳이에요. 인생의 결과와 후반부 운을 알려 줘요.',
  '시주는 내 인생의 마무리, 즉 결실을 나타내는 기둥이에요. 자녀 운도 여기서 봐요.',
  '시주에는 나의 내면 깊은 소망과 인생의 결과물이 담겨 있어요.',
  '시주는 나이로 치면 약 60세 이후의 운을 나타내며, 자녀 및 제자와의 관계도 보여 줘요.',
  '태어난 시간의 기운인 시주는 내가 이루어 낼 결과와 후반부 인생을 보여 주는 기둥이에요.',
  '시주는 나의 미래 지향적인 기운을 담고 있어요. 어떤 결실을 맺을지 이 기둥이 알려 줘요.',
  '시주(時柱)는 태어난 시간의 간지로, 인생의 후반부와 다음 세대에 물려줄 기운이 담겨 있어요.',
  '시주는 나의 꿈과 이상, 그리고 인생의 황혼기를 나타내는 기둥이에요.',
  '시주를 보면 나의 말년운과 자녀에게 어떤 기운을 물려줄 수 있는지 알 수 있어요.',
  '시주는 내 사주의 마지막 기둥으로, 인생이라는 여행의 종착지와 같아요.',
  '시주에 좋은 기운이 있으면 인생의 후반부가 풍요롭고 편안하다고 해요.',
  '시주는 나의 "뒷이야기"를 담당하는 기둥이에요. 인생의 결말이 아름다울 수 있도록 도와줘요.',
  '태어난 시간의 천간과 지지가 시주를 이뤄요. 내 인생의 결실과 미래 세대를 보여 주는 기둥이에요.',
  '시주는 마치 책의 마지막 장 같아요. 이야기가 어떻게 마무리되는지 보여 준답니다.',
  '시주에 담긴 기운은 나의 잠재된 꿈과 말년의 행복에 영향을 미쳐요.',
  '시주는 나의 내적인 소원과 인생 후반부의 방향을 알려 주는 기둥이에요.',
  '시주를 보면 나의 창의력, 표현력, 그리고 자녀와의 인연까지 읽을 수 있어요.',
  '시주는 인생이라는 나무에서 마지막으로 맺히는 열매를 뜻하는 기둥이에요.',
];

const PILLAR_DESC_MAP: Record<PillarKey, readonly string[]> = {
  year: PILLAR_DESC_YEAR_TEMPLATES,
  month: PILLAR_DESC_MONTH_TEMPLATES,
  day: PILLAR_DESC_DAY_TEMPLATES,
  hour: PILLAR_DESC_HOUR_TEMPLATES,
};

// ---------------------------------------------------------------------------
//  템플릿 풀: 기둥별 세부 속성 설명
// ---------------------------------------------------------------------------

const PILLAR_DETAIL_TEMPLATES: readonly string[] = [
  '{{기둥이름}}의 천간은 {{천간한글}}({{천간한자}})이에요. {{천간오행}}의 기운으로, {{음양}} 성질을 가지고 있어요.',
  '{{기둥이름}} 위 칸의 글자는 {{천간한글}}({{천간한자}})이에요. 이 글자는 {{음양}} {{천간오행}} 기운이에요.',
  '{{기둥이름}}의 하늘 글자(천간)인 {{천간한글}}({{천간한자}})은 {{천간오행}} 기운이며, 성질은 {{음양}}이에요.',
  '{{기둥이름}} 천간 {{천간한글}}({{천간한자}})은 {{천간오행}}에 해당하고, {{음양}}의 성질을 지니고 있어요.',
  '{{기둥이름}} 위 글자 {{천간한글}}({{천간한자}}): {{음양}} {{천간오행}} 기운이에요.',
  '{{기둥이름}}의 천간인 {{천간한글}}({{천간한자}})은 {{천간오행}} 기운을 품고 있어요. {{음양}}의 성질이랍니다.',
  '{{기둥이름}}의 하늘 기운은 {{천간한글}}({{천간한자}})이에요. {{음양}}의 {{천간오행}} 에너지를 나타내요.',
  '{{기둥이름}} 천간은 {{천간한글}}({{천간한자}}) -- {{음양}}의 {{천간오행}}이에요.',
  '{{기둥이름}}에서 위 칸에 자리한 {{천간한글}}({{천간한자}})은 {{천간오행}} 기운, {{음양}} 성질이에요.',
  '{{기둥이름}} 윗줄의 {{천간한글}}({{천간한자}})은 {{음양}} {{천간오행}}에 해당하는 글자예요.',
  '{{기둥이름}}의 하늘 글자 {{천간한글}}({{천간한자}})은 {{천간오행}} 기운이에요. 성질은 {{음양}}이고요.',
  '{{기둥이름}}의 첫 번째 글자인 {{천간한글}}({{천간한자}})은 {{음양}}의 {{천간오행}} 에너지를 담고 있어요.',
  '{{기둥이름}}의 천간, {{천간한글}}({{천간한자}})은 {{음양}} {{천간오행}} 기운이랍니다.',
  '{{기둥이름}} 위 자리의 {{천간한글}}({{천간한자}})은 {{천간오행}} 기운으로, {{음양}} 성질을 가져요.',
  '{{기둥이름}}의 천간은 {{천간한글}}({{천간한자}}), {{음양}} {{천간오행}}이에요.',
  '{{기둥이름}}에서 천간(위 글자)은 {{천간한글}}({{천간한자}})이에요. {{천간오행}} 기운이며, {{음양}} 성질이에요.',
  '{{기둥이름}}의 하늘의 기운을 나타내는 {{천간한글}}({{천간한자}})은 {{음양}} {{천간오행}} 에너지예요.',
  '{{기둥이름}} 천간 {{천간한글}}({{천간한자}})은 {{천간오행}} 계열이며, {{음양}} 성질을 가지고 있어요.',
  '{{기둥이름}}의 위 글자인 {{천간한글}}({{천간한자}})은 오행으로 {{천간오행}}, 음양으로 {{음양}}에 해당해요.',
  '{{기둥이름}} 천간은 {{천간한글}}({{천간한자}})인데, 이것은 {{음양}}의 {{천간오행}} 기운이에요.',
  '{{기둥이름}}의 천간 {{천간한글}}({{천간한자}})은 {{천간오행}} 기운을 가진 {{음양}} 성질의 글자예요.',
];

const BRANCH_DETAIL_TEMPLATES: readonly string[] = [
  '{{기둥이름}}의 지지는 {{지지한글}}({{지지한자}})이에요. {{지지오행}}의 기운이며, 띠 동물로는 {{띠}}에 해당해요.',
  '{{기둥이름}} 아래 칸의 글자는 {{지지한글}}({{지지한자}})이에요. {{지지오행}} 기운이고, {{띠}}띠와 관련 있어요.',
  '{{기둥이름}}의 땅 글자(지지)인 {{지지한글}}({{지지한자}})은 {{지지오행}} 기운이에요. 띠로는 {{띠}}에 해당하지요.',
  '{{기둥이름}} 지지 {{지지한글}}({{지지한자}})은 {{지지오행}}에 해당하고, {{띠}}띠의 기운을 가지고 있어요.',
  '{{기둥이름}} 아래 글자 {{지지한글}}({{지지한자}}): {{지지오행}} 기운, {{띠}}띠예요.',
  '{{기둥이름}}의 지지인 {{지지한글}}({{지지한자}})은 {{지지오행}} 기운이에요. 동물로는 {{띠}}에 해당합니다.',
  '{{기둥이름}}의 땅 기운은 {{지지한글}}({{지지한자}})이에요. {{지지오행}} 에너지를 나타내며, {{띠}}와 연결돼요.',
  '{{기둥이름}} 지지는 {{지지한글}}({{지지한자}}) -- {{지지오행}} 기운이며, {{띠}}띠예요.',
  '{{기둥이름}}에서 아래 칸에 자리한 {{지지한글}}({{지지한자}})은 {{지지오행}} 기운, {{띠}}에 해당해요.',
  '{{기둥이름}} 아랫줄의 {{지지한글}}({{지지한자}})은 {{지지오행}} 기운이에요. 동물 상징은 {{띠}}이지요.',
  '{{기둥이름}}의 땅 글자 {{지지한글}}({{지지한자}})은 {{지지오행}} 기운이며, {{띠}}를 상징해요.',
  '{{기둥이름}}의 두 번째 글자인 {{지지한글}}({{지지한자}})은 {{지지오행}} 에너지를 담고 있고, {{띠}}에 해당해요.',
  '{{기둥이름}}의 지지, {{지지한글}}({{지지한자}})은 {{지지오행}} 기운이에요. 띠 동물은 {{띠}}랍니다.',
  '{{기둥이름}} 아래 자리의 {{지지한글}}({{지지한자}})은 {{지지오행}} 기운으로, {{띠}}에 대응해요.',
  '{{기둥이름}}의 지지는 {{지지한글}}({{지지한자}}), {{지지오행}} 기운이고, {{띠}} 동물이에요.',
  '{{기둥이름}}에서 지지(아래 글자)는 {{지지한글}}({{지지한자}})이에요. {{지지오행}} 기운이며, {{띠}}띠에요.',
  '{{기둥이름}}의 땅의 기운을 나타내는 {{지지한글}}({{지지한자}})은 {{지지오행}} 에너지에, {{띠}}의 상징이에요.',
  '{{기둥이름}} 지지 {{지지한글}}({{지지한자}})은 {{지지오행}} 계열이며, {{띠}}띠와 관련이 있어요.',
  '{{기둥이름}}의 아래 글자인 {{지지한글}}({{지지한자}})은 오행으로 {{지지오행}}, 동물로는 {{띠}}에 해당해요.',
  '{{기둥이름}} 지지는 {{지지한글}}({{지지한자}})인데, 이것은 {{지지오행}} 기운이고 {{띠}}띠를 나타내요.',
  '{{기둥이름}}의 지지 {{지지한글}}({{지지한자}})은 {{지지오행}} 기운을 가진 글자로, {{띠}} 동물과 연결돼요.',
];

// ---------------------------------------------------------------------------
//  템플릿 풀: 천간과 지지 개념 설명 (하위 섹션용)
// ---------------------------------------------------------------------------

const CHEONGAN_CONCEPT_TEMPLATES: readonly string[] = [
  '천간(天干)은 "하늘의 줄기"라는 뜻이에요. 갑, 을, 병, 정, 무, 기, 경, 신, 임, 계 -- 총 열 글자가 있어요.',
  '천간은 하늘의 기운을 열 글자로 나눈 것이에요. 하늘에서 내려오는 에너지의 종류를 나타내요.',
  '하늘의 열 글자(천간)는 각각 나무(목), 불(화), 흙(토), 쇠(금), 물(수)의 기운을 양과 음으로 나눈 거예요.',
  '천간은 "하늘의 기둥"이라는 뜻이에요. 10개의 글자가 돌아가면서 하늘의 기운을 나타내요.',
  '천간은 오행(나무, 불, 흙, 쇠, 물)을 양과 음으로 나눈 열 가지 하늘 기운이에요.',
  '천간이란 하늘에서 흘러내려 오는 기운을 열 글자로 분류한 것이에요. 갑부터 계까지 있답니다.',
  '하늘의 기운을 열 갈래로 나눈 것이 천간이에요. 각 글자마다 고유한 오행과 음양이 있어요.',
  '천간은 10개의 한자로 이루어져 있어요. 오행 다섯 가지에 양과 음이 하나씩, 합쳐서 열 글자예요.',
  '천간(天干)은 글자 그대로 "하늘의 줄기"를 뜻해요. 열 글자가 순환하면서 하늘의 기운을 표현해요.',
  '천간은 하늘의 에너지를 오행과 음양으로 세분화한 열 가지 코드예요.',
  '천간의 열 글자는 갑(甲), 을(乙), 병(丙), 정(丁), 무(戊), 기(己), 경(庚), 신(辛), 임(壬), 계(癸)예요.',
  '하늘의 기운을 나타내는 천간은 오행 각각을 양과 음으로 나누어 총 10개의 글자를 만들었어요.',
  '천간은 동양 철학에서 하늘의 변화를 나타내는 10개의 상징이에요.',
  '천간은 "하늘이 세상에 내려보내는 에너지의 종류"라고 이해하면 쉬워요.',
  '갑을병정무기경신임계, 이 열 글자가 바로 천간이에요. 각각 오행과 음양이 정해져 있어요.',
  '천간은 마치 열 가지 색깔의 하늘빛처럼, 각기 다른 에너지를 나타내요.',
  '천간이라는 이름에서 "천"은 하늘, "간"은 줄기라는 뜻이에요. 하늘 기운의 뿌리가 되는 글자들이에요.',
  '천간의 열 글자는 목(갑, 을), 화(병, 정), 토(무, 기), 금(경, 신), 수(임, 계)로 이루어져 있어요.',
  '천간은 보이지 않는 하늘의 기운을 사람이 이해할 수 있도록 열 글자로 정리한 것이에요.',
  '천간은 2,000년 이상 동양에서 사용해 온 시간 표기 방법의 일부예요. 하늘의 기운을 담고 있답니다.',
  '천간은 하늘에서 내려오는 기운의 열 가지 모습이에요. 사주에서는 각 기둥의 위 칸에 자리해요.',
];

const JIJI_CONCEPT_TEMPLATES: readonly string[] = [
  '지지(地支)는 "땅의 가지"라는 뜻이에요. 자, 축, 인, 묘, 진, 사, 오, 미, 신, 유, 술, 해 -- 총 열두 글자가 있어요.',
  '지지는 땅의 기운을 열두 글자로 나눈 것이에요. 우리가 잘 아는 12띠 동물과 연결되어 있어요.',
  '땅의 열두 글자(지지)는 각각 12마리 동물과 짝지어져 있어요. 쥐, 소, 호랑이, 토끼, 용, 뱀, 말, 양, 원숭이, 닭, 개, 돼지랍니다.',
  '지지는 "땅의 가지"라는 뜻이에요. 12개의 글자가 돌아가면서 땅의 기운을 나타내요.',
  '지지는 땅에서 올라오는 기운을 열두 갈래로 나눈 것이에요. 12달, 12시간, 12띠 동물과 연결돼요.',
  '지지란 땅에서 솟아오르는 기운을 열두 글자로 분류한 것이에요. 자부터 해까지 있답니다.',
  '땅의 기운을 열두 갈래로 나눈 것이 지지예요. 각 글자마다 오행, 음양, 그리고 동물이 있어요.',
  '지지는 12개의 한자로 이루어져 있어요. 12달과 12시진, 12띠 동물에 각각 대응해요.',
  '지지(地支)는 글자 그대로 "땅의 가지"를 뜻해요. 열두 글자가 순환하면서 땅의 기운을 표현해요.',
  '지지는 땅의 에너지를 열두 가지 동물 상징으로 표현한 코드예요.',
  '지지의 열두 글자는 자(子), 축(丑), 인(寅), 묘(卯), 진(辰), 사(巳), 오(午), 미(未), 신(申), 유(酉), 술(戌), 해(亥)예요.',
  '땅의 기운을 나타내는 지지는 열두 글자로, 각각에 띠 동물이 배정되어 있어요.',
  '지지는 동양 철학에서 땅의 변화를 나타내는 12개의 상징이에요.',
  '지지는 "땅이 품고 있는 에너지의 종류"라고 이해하면 쉬워요.',
  '자축인묘진사오미신유술해, 이 열두 글자가 바로 지지예요. 12달과 12띠 동물에 대응하지요.',
  '지지는 마치 열두 가지 계절의 리듬처럼, 각기 다른 땅의 에너지를 나타내요.',
  '지지라는 이름에서 "지"는 땅, "지"는 가지라는 뜻이에요. 땅 기운이 가지처럼 뻗어 나간다는 의미예요.',
  '지지의 열두 글자는 수(자, 해), 토(축, 진, 미, 술), 목(인, 묘), 화(사, 오), 금(신, 유)으로 구분돼요.',
  '지지는 보이지 않는 땅의 기운을 사람이 이해할 수 있도록 열두 글자로 정리한 것이에요.',
  '지지는 2,000년 이상 동양에서 사용해 온 시간 표기 방법의 일부예요. 땅의 기운을 담고 있답니다.',
  '지지는 땅에서 올라오는 기운의 열두 가지 모습이에요. 사주에서는 각 기둥의 아래 칸에 자리해요.',
];

const CHEONGAN_JIJI_RELATIONSHIP_TEMPLATES: readonly string[] = [
  '천간(하늘)과 지지(땅)가 만나서 하나의 기둥을 이루어요. 하늘과 땅이 합쳐져야 비로소 완전한 기운이 되는 거예요.',
  '천간 10개와 지지 12개가 번갈아 짝을 이루면, 60가지 조합(60갑자)이 만들어져요. 이것이 동양 달력의 기본이에요.',
  '하늘의 열 글자(천간)와 땅의 열두 글자(지지)가 위아래로 짝을 이루어 한 기둥이 돼요.',
  '천간과 지지는 마치 하늘과 땅이 만나는 것처럼, 서로 어울려야 완전한 기운이 됩니다.',
  '천간 10개와 지지 12개를 순서대로 짝지으면 60번 만에 처음으로 돌아와요. 그래서 60갑자라고 해요.',
  '천간이 하늘에서 기운을 내려보내면, 지지가 땅에서 그 기운을 받아들여요. 이 둘의 조화가 사주의 핵심이에요.',
  '하늘(천간)은 방향을 제시하고, 땅(지지)은 실제로 그 방향을 실현해 주는 역할을 해요.',
  '천간과 지지가 한 쌍으로 어울리면 고유한 에너지가 만들어져요. 네 기둥이면 네 쌍의 독특한 에너지가 생기는 거예요.',
  '하늘 글자와 땅 글자가 위아래로 짝지어져 하나의 기둥을 만들어요. 이것이 사주의 기본 구조예요.',
  '천간은 겉으로 드러나는 성질, 지지는 속에 숨어 있는 성질을 나타내요. 둘을 함께 봐야 온전한 그림이 보여요.',
  '천간과 지지의 만남은 마치 씨앗(천간)이 토양(지지)을 만나 싹을 틔우는 것과 같아요.',
  '동양에서는 천간과 지지를 조합하여 연도, 달, 날짜, 시간을 표기했어요. 이 방법이 2,000년 넘게 이어져 왔답니다.',
  '천간은 기운의 종류를, 지지는 기운의 시기와 환경을 알려 줘요. 둘이 합쳐져야 온전한 뜻이 됩니다.',
  '하늘(천간)은 보이는 성격, 땅(지지)은 보이지 않는 잠재력이에요. 사주에서 두 가지를 함께 분석해요.',
  '천간과 지지가 만들어 내는 60가지 조합이 60년마다 한 바퀴를 돌아요. "환갑"이 바로 이 60년이에요.',
  '천간은 빠르게 변하는 에너지(10주기), 지지는 천천히 변하는 에너지(12주기)예요. 이 둘의 리듬이 합쳐져 인생의 흐름을 만들어요.',
  '천간은 "내가 어떤 사람인지"를, 지지는 "내가 어떤 환경에 있는지"를 나타내요.',
  '천간 열 글자와 지지 열두 글자가 톱니바퀴처럼 맞물려 돌아가는 것이 동양 달력의 원리예요.',
  '사주에서 천간은 위(하늘)에, 지지는 아래(땅)에 놓여요. 이 상하 구조가 하나의 기둥을 이루는 거예요.',
  '천간과 지지의 관계를 이해하면 사주팔자 전체를 읽는 눈이 생겨요. 이것이 사주 공부의 첫걸음이에요.',
  '하늘(천간)과 땅(지지)이 조화를 이룰 때 가장 좋은 기운이 만들어진다고 해요.',
];

// ---------------------------------------------------------------------------
//  템플릿 풀: 마무리 문장
// ---------------------------------------------------------------------------

const CLOSING_TEMPLATES: readonly string[] = [
  '이 네 기둥이 서로 어떻게 어울리는지에 따라 나의 성격, 적성, 운세가 달라진답니다. 하나씩 자세히 살펴볼게요!',
  '사주 원국표를 알았으니, 이제부터 각 기둥의 의미와 관계를 차근차근 알아보겠습니다.',
  '여기까지가 사주팔자의 기본 구성이에요. 이제 이 글자들이 서로 어떤 관계를 맺고 있는지 하나씩 풀어 볼게요.',
  '네 기둥의 여덟 글자가 모두 모였어요. 다음 단계에서는 이 글자들의 숨겨진 이야기를 더 깊이 알아볼 거예요.',
  '이렇게 네 기둥을 세우면 사주 분석의 기본 준비가 끝나요. 이제 본격적인 해석이 시작됩니다!',
  '사주 원국표는 모든 분석의 출발점이에요. 이제 이 여덟 글자가 어떤 이야기를 들려주는지 함께 들어볼까요?',
  '이것으로 사주팔자의 기본 틀을 모두 살펴봤어요. 다음에는 오행의 분포와 균형을 분석해 볼게요.',
  '여덟 글자를 모두 확인했으니, 이제 이 글자들이 만들어내는 오행의 하모니를 분석할 차례예요.',
  '사주의 기본 구조를 이해했으니, 이제 더 깊은 이야기로 들어가 볼까요? 기대되지 않나요?',
  '이 네 기둥이 바로 사주 분석의 기초예요. 앞으로의 분석이 모두 이 기둥들에서 출발한답니다.',
  '이 여덟 글자 속에 어떤 보물이 숨어 있는지 궁금하지 않나요? 하나씩 찾아볼게요!',
  '사주 원국을 다 살펴봤어요. 이제 오행 분포, 십성, 격국 등을 차근차근 분석해 보겠습니다.',
  '이렇게 네 기둥의 기본 정보를 확인하면 사주 분석의 첫 단추가 끼워지는 거예요.',
  '앞으로 이어질 분석에서 이 원국표를 자주 참고하게 될 거예요. 꼭 기억해 두세요!',
  '여기까지가 사주의 기초 구조예요. 이 바탕 위에서 오행, 십성, 용신 등 다양한 분석이 펼쳐집니다.',
  '이 표가 앞으로의 모든 사주 분석의 출발선이에요. 자, 이제 본격적으로 시작해 볼까요?',
  '기본 정보를 모두 확인했으니, 다음에는 이 글자들의 관계와 균형을 살펴볼 거예요.',
  '사주 원국표를 읽는 법을 알게 되셨죠? 이제 이 표를 바탕으로 더 재미있는 분석이 이어집니다.',
  '이 네 기둥은 나의 일생을 관통하는 기본 에너지예요. 앞으로 이 에너지가 어떻게 작용하는지 알아볼게요.',
  '사주 원국의 기본을 이해하셨다면, 다음 단계로 넘어갈 준비가 된 거예요!',
  '여기서 소개한 네 기둥의 여덟 글자가 앞으로 펼쳐질 모든 분석의 단단한 기반이 되어 줄 거예요.',
];

// ---------------------------------------------------------------------------
//  유틸 함수
// ---------------------------------------------------------------------------

/** StemInfo를 코드 또는 한글로 안전하게 조회합니다. */
function resolveStem(pillarStemCode: string, pillarStemHangul: string): StemInfo | null {
  return lookupStemInfo(pillarStemCode) ?? lookupStemInfo(pillarStemHangul);
}

/** BranchInfo를 코드 또는 한글로 안전하게 조회합니다. */
function resolveBranch(pillarBranchCode: string, pillarBranchHangul: string): BranchInfo | null {
  return lookupBranchInfo(pillarBranchCode) ?? lookupBranchInfo(pillarBranchHangul);
}

/**
 * 지지 백과 엔트리를 코드/한글 기준으로 안전하게 조회합니다.
 * 매칭이 실패하면 null을 반환합니다.
 */
function resolveBranchEncyclopediaEntry(
  pillarBranchCode: string | undefined,
  pillarBranchHangul: string | undefined,
): BranchEncyclopediaEntry | null {
  const codeFromCode = pillarBranchCode ? BRANCH_BY_CODE[pillarBranchCode]?.code : undefined;
  const codeFromHangul = pillarBranchHangul ? BRANCH_BY_HANGUL[pillarBranchHangul]?.code : undefined;
  const normalizedCode = codeFromCode ?? codeFromHangul;
  if (!normalizedCode) return null;

  return getBranchEncyclopediaEntry(normalizedCode as import('../types.js').BranchCode) ?? null;
}

/** 배열의 첫 번째 항목을 안전하게 꺼내고, 없으면 fallback을 반환합니다. */
function pickFirst(values: readonly string[] | undefined, fallback: string): string {
  if (!values || values.length === 0) return fallback;
  return values[0] ?? fallback;
}

/** 이름이 없거나 빈 문자열일 때 기본값을 반환합니다. */
function safeName(input: ReportInput): string {
  return input.name?.trim() || '회원';
}

/** 천간/지지 오행 코드를 한글 2글자(예: "목", "화")로 변환합니다. */
function elShort(code: string | undefined): string {
  if (!code) return '?';
  return ELEMENT_KOREAN_SHORT[code as keyof typeof ELEMENT_KOREAN_SHORT] ?? code;
}

/** 천간/지지 오행 코드를 한글+한자(예: "목(木)")로 변환합니다. */
function elFull(code: string | undefined): string {
  if (!code) return '?';
  return ELEMENT_KOREAN[code as keyof typeof ELEMENT_KOREAN] ?? code;
}

/** 음양 코드를 짧은 한글("양" 또는 "음")로 변환합니다. */
function yyShort(code: string | undefined): string {
  if (code === 'YANG') return '양';
  if (code === 'YIN') return '음';
  return code ?? '?';
}

// ---------------------------------------------------------------------------
//  원국표 테이블 빌더
// ---------------------------------------------------------------------------

/**
 * 사주 원국표(ReportTable)를 구성합니다.
 *
 * 열 순서: 시주 | 일주 | 월주 | 연주 (전통 우측→좌측 배치를 좌측→우측으로)
 *
 * 각 셀에는 "한글(한자) / 오행 / 음양" 형식으로 최대한 많은 정보를 담습니다.
 */
function buildPillarsTable(input: ReportInput): ReportTable {
  const { pillars } = input.saju;

  const headers = ['', '시주(時柱)', '일주(日柱)', '월주(月柱)', '연주(年柱)'];

  const stemRow: string[] = ['천간'];
  const branchRow: string[] = ['지지'];
  const elementRow: string[] = ['오행'];
  const yyRow: string[] = ['음양'];

  for (const key of PILLAR_KEYS) {
    const pillar = pillars[key];
    const stemInfo = resolveStem(pillar.stem.code, pillar.stem.hangul);
    const branchInfo = resolveBranch(pillar.branch.code, pillar.branch.hangul);

    // 천간: 한글(한자)
    stemRow.push(`${pillar.stem.hangul}(${pillar.stem.hanja})`);

    // 지지: 한글(한자)
    branchRow.push(`${pillar.branch.hangul}(${pillar.branch.hanja})`);

    // 오행: 천간오행 / 지지오행
    const stemEl = stemInfo ? elFull(stemInfo.element) : '?';
    const branchEl = branchInfo ? elFull(branchInfo.element) : '?';
    elementRow.push(`${stemEl} / ${branchEl}`);

    // 음양: 천간음양 / 지지음양
    const stemYy = stemInfo ? yinYangToKorean(stemInfo.yinYang) : '?';
    const branchYy = branchInfo ? yinYangToKorean(branchInfo.yinYang) : '?';
    yyRow.push(`${stemYy} / ${branchYy}`);
  }

  return {
    title: '사주 원국표',
    headers,
    rows: [stemRow, branchRow, elementRow, yyRow],
  };
}

// ---------------------------------------------------------------------------
//  하이라이트 빌더
// ---------------------------------------------------------------------------

function buildHighlights(input: ReportInput): ReportHighlight[] {
  const highlights: ReportHighlight[] = [];
  const { pillars, dayMaster } = input.saju;

  // 일간 하이라이트
  const dmStem = resolveStem(dayMaster.stem, dayMaster.stem);
  highlights.push({
    label: '일간 (나)',
    value: dmStem
      ? `${dmStem.hangul}(${dmStem.hanja}) - ${elFull(dmStem.element)} ${yinYangToKorean(dmStem.yinYang)}`
      : `${dayMaster.stem} - ${elShort(dayMaster.element)}`,
    element: (dayMaster.element || dmStem?.element) as import('../types.js').ElementCode | undefined,
    sentiment: 'neutral',
  });

  // 연주 지지 (띠) 하이라이트
  const yearBranch = resolveBranch(pillars.year.branch.code, pillars.year.branch.hangul);
  if (yearBranch) {
    highlights.push({
      label: '띠 (연지)',
      value: `${yearBranch.hangul}(${yearBranch.hanja}) - ${yearBranch.animal}띠`,
      element: yearBranch.element as import('../types.js').ElementCode,
      sentiment: 'neutral',
    });
  }

  // 월지 지지 백과 하이라이트 (계절/시간/분위기)
  const monthBranchEntry = resolveBranchEncyclopediaEntry(
    pillars.month.branch.code,
    pillars.month.branch.hangul,
  );
  const monthBranchInfo = resolveBranch(pillars.month.branch.code, pillars.month.branch.hangul);
  if (monthBranchEntry) {
    highlights.push({
      label: '월지 분위기',
      value: `${monthBranchEntry.vibe} (${monthBranchEntry.season}, ${monthBranchEntry.time})`,
      element: monthBranchInfo?.element as import('../types.js').ElementCode | undefined,
      sentiment: 'neutral',
    });
  }

  // 각 기둥 오행 간결 하이라이트
  for (const key of PILLAR_KEYS) {
    const p = pillars[key];
    const sInfo = resolveStem(p.stem.code, p.stem.hangul);
    const bInfo = resolveBranch(p.branch.code, p.branch.hangul);
    if (sInfo && bInfo) {
      highlights.push({
        label: PILLAR_KOREAN_SHORT[key],
        value: `${sInfo.hangul}${bInfo.hangul}(${sInfo.hanja}${bInfo.hanja}) - ${elShort(sInfo.element)}/${elShort(bInfo.element)}`,
        element: sInfo.element as import('../types.js').ElementCode,
        sentiment: 'neutral',
      });
    }
  }

  return highlights;
}

// ---------------------------------------------------------------------------
//  서술 단락 빌더
// ---------------------------------------------------------------------------

function buildNarrativeParagraphs(input: ReportInput, rng: SeededRandom): ReportParagraph[] {
  const paragraphs: ReportParagraph[] = [];
  const name = safeName(input);
  const { pillars, dayMaster } = input.saju;

  // 1) 도입: 사주팔자란 무엇인가
  const intro = rng.pick(INTRO_TEMPLATES);
  const metaphor = rng.pick(INTRO_METAPHOR_TEMPLATES);
  paragraphs.push(narrative(joinSentences(intro, metaphor)));

  // 2) 원국표 소개
  const tableIntro = pickAndFill(rng, TABLE_INTRO_TEMPLATES, { 이름: name });
  paragraphs.push(narrative(tableIntro));

  // 3) 일간(나) 설명
  const dmStem = resolveStem(dayMaster.stem, dayMaster.stem);
  const dmElement = dayMaster.element || dmStem?.element || '';
  const dmPolarity = dayMaster.polarity || dmStem?.yinYang || '';

  const dayMasterVars: Record<string, string> = {
    이름: name,
    일간한글: dmStem?.hangul ?? dayMaster.stem,
    일간한자: dmStem?.hanja ?? '?',
    오행: elFull(dmElement),
    오행짧게: elShort(dmElement),
    음양: yinYangToKorean(dmPolarity),
    오행비유: ELEMENT_CHILD_METAPHOR[dmElement] ?? '특별한 기운',
    오행설명: ELEMENT_EMOJI_DESC[dmElement] ?? '독특한 에너지',
  };

  const dayMasterText = pickAndFill(rng, DAY_MASTER_TEMPLATES, dayMasterVars);
  paragraphs.push(
    emphasis(dayMasterText, dmElement as import('../types.js').ElementCode | undefined),
  );

  // 4) 각 기둥별 설명 (연주, 월주, 일주, 시주 순서로 -- 읽기 편한 순서)
  const readOrder: PillarKey[] = ['year', 'month', 'day', 'hour'];

  for (const key of readOrder) {
    const pillar = pillars[key];
    const stemInfo = resolveStem(pillar.stem.code, pillar.stem.hangul);
    const branchInfo = resolveBranch(pillar.branch.code, pillar.branch.hangul);

    // 기둥 개요 문장
    const pillarOverview = rng.pick(PILLAR_DESC_MAP[key]);
    paragraphs.push(narrative(pillarOverview));

    // 천간 상세
    if (stemInfo) {
      const stemVars: Record<string, string> = {
        기둥이름: PILLAR_KOREAN_SHORT[key],
        천간한글: stemInfo.hangul,
        천간한자: stemInfo.hanja,
        천간오행: elFull(stemInfo.element),
        음양: yinYangToKorean(stemInfo.yinYang),
      };
      paragraphs.push(narrative(pickAndFill(rng, PILLAR_DETAIL_TEMPLATES, stemVars)));
    }

    // 지지 상세
    if (branchInfo) {
      const branchVars: Record<string, string> = {
        기둥이름: PILLAR_KOREAN_SHORT[key],
        지지한글: branchInfo.hangul,
        지지한자: branchInfo.hanja,
        지지오행: elFull(branchInfo.element),
        띠: branchInfo.animal,
      };
      paragraphs.push(narrative(pickAndFill(rng, BRANCH_DETAIL_TEMPLATES, branchVars)));
    }
  }

  // 5) 마무리
  const closing = rng.pick(CLOSING_TEMPLATES);
  paragraphs.push(positive(closing));

  return paragraphs;
}

// ---------------------------------------------------------------------------
//  하위 섹션: 천간과 지지 개념 설명
// ---------------------------------------------------------------------------

function buildConceptSubsection(rng: SeededRandom): import('../types.js').ReportSubsection {
  const paragraphs: ReportParagraph[] = [];

  // 천간 개념
  paragraphs.push(narrative(rng.pick(CHEONGAN_CONCEPT_TEMPLATES)));

  // 천간 표
  const stemTable: ReportTable = {
    title: '천간 10글자',
    headers: ['순서', '한글', '한자', '오행', '음양'],
    rows: STEMS.map((s, i) => [
      String(i + 1),
      s.hangul,
      s.hanja,
      elFull(s.element),
      yinYangToKorean(s.yinYang),
    ]),
  };

  // 지지 개념
  paragraphs.push(narrative(rng.pick(JIJI_CONCEPT_TEMPLATES)));

  // 지지 표
  const branchTable: ReportTable = {
    title: '지지 12글자',
    headers: ['순서', '한글', '한자', '오행', '음양', '동물'],
    rows: BRANCHES.map((b, i) => [
      String(i + 1),
      b.hangul,
      b.hanja,
      elFull(b.element),
      yinYangToKorean(b.yinYang),
      b.animal,
    ]),
  };

  // 천간-지지 관계 설명
  paragraphs.push(narrative(rng.pick(CHEONGAN_JIJI_RELATIONSHIP_TEMPLATES)));

  // 팁 문단
  paragraphs.push(
    tip('천간은 사주에서 위 칸, 지지는 아래 칸에 배치돼요. 위 칸(천간)은 겉으로 드러나는 성격, 아래 칸(지지)은 내면에 숨어 있는 성격이라고 생각하면 이해하기 쉬워요.'),
  );

  return {
    title: '천간과 지지란?',
    paragraphs,
    tables: [stemTable, branchTable],
  };
}

// ---------------------------------------------------------------------------
//  하위 섹션: 네 기둥의 시간적 의미
// ---------------------------------------------------------------------------

const PILLAR_LIFESPAN_TEMPLATES: readonly string[] = [
  '사주의 네 기둥은 인생의 네 시기와 대응해요. 연주는 유년기(0~15세), 월주는 청년기(15~30세), 일주는 장년기(30~50세), 시주는 노년기(50세 이후)를 나타낸답니다.',
  '네 기둥은 인생의 흐름을 시간 순서대로 보여 줘요. 연주(어린 시절), 월주(학생~직장 초기), 일주(한창 때), 시주(은퇴 이후)로 나뉘어요.',
  '사주의 네 기둥을 인생의 4막이라고 생각해 보세요. 제1막(연주)은 어린 시절, 제2막(월주)은 청년기, 제3막(일주)은 전성기, 제4막(시주)은 인생의 마무리예요.',
  '연주부터 시주까지, 각 기둥은 인생의 서로 다른 시기를 대표해요. 마치 봄, 여름, 가을, 겨울처럼 각각의 역할이 있답니다.',
  '네 기둥은 인생의 타임라인이기도 해요. 연주가 뿌리라면, 월주는 줄기, 일주는 꽃, 시주는 열매에 비유할 수 있어요.',
  '사주에서 연주는 초년, 월주는 청년, 일주는 중년, 시주는 말년의 운을 보여 준다고 알려져 있어요.',
  '네 기둥은 단순한 시간 기록이 아니에요. 각 기둥이 인생의 서로 다른 무대를 나타내며, 그 무대에서의 운과 환경을 보여 줘요.',
  '연주에서 시주까지, 네 기둥은 내 인생의 기승전결을 담고 있어요. 기(연주), 승(월주), 전(일주), 결(시주)이라고 생각하면 되죠.',
  '네 기둥 중 어느 기둥이 강하냐에 따라 인생에서 빛나는 시기가 달라질 수 있어요.',
  '각 기둥은 인생의 특정 시기뿐 아니라, 가족 관계도 나타내요. 연주는 조상, 월주는 부모, 일주는 나와 배우자, 시주는 자녀를 상징해요.',
  '네 기둥이 골고루 좋은 기운을 가지고 있으면 인생 전체가 안정적이라고 해요.',
  '연주는 나를 둘러싼 큰 환경, 월주는 사회적 관계, 일주는 나 자신, 시주는 나의 내면과 후세를 나타내요.',
  '네 기둥의 관계를 살펴보면 인생의 어느 시기에 어떤 기운이 강한지 알 수 있어요.',
  '마치 나무의 뿌리(연주), 줄기(월주), 가지(일주), 열매(시주)처럼, 네 기둥은 유기적으로 연결되어 있어요.',
  '네 기둥의 오행이 서로 조화를 이루면 인생의 흐름도 부드럽고 안정적이에요.',
  '연주, 월주, 일주, 시주 -- 이 네 기둥이 마치 사계절처럼 인생의 리듬을 만들어 간답니다.',
  '네 기둥 사이의 기운이 서로 도와주면(상생) 인생이 순탄하고, 부딪히면(상극) 도전이 따르기도 해요.',
  '인생을 하나의 드라마라고 하면, 네 기둥은 그 드라마의 시놉시스 같은 거예요.',
  '네 기둥은 인생의 지도예요. 어디서 출발하여 어디로 향하는지를 보여 준답니다.',
  '사주의 네 기둥을 이해하면 나의 과거, 현재, 미래를 아우르는 큰 그림을 볼 수 있어요.',
  '연주, 월주, 일주, 시주가 각각 어떤 기운인지 알면, 인생 전체의 큰 흐름을 한눈에 파악할 수 있답니다.',
];

function buildLifespanSubsection(rng: SeededRandom): import('../types.js').ReportSubsection {
  const paragraphs: ReportParagraph[] = [];

  // 네 기둥과 인생 시기 설명
  paragraphs.push(narrative(rng.pick(PILLAR_LIFESPAN_TEMPLATES)));

  // 요약 표
  const lifespanTable: ReportTable = {
    title: '네 기둥과 인생의 시기',
    headers: ['기둥', '인생 시기', '관련 인물', '자연 비유'],
    rows: [
      ['연주(年柱)', '유년기 (0~15세)', '조부모, 가문', '뿌리'],
      ['월주(月柱)', '청년기 (15~30세)', '부모, 선생님', '줄기'],
      ['일주(日柱)', '장년기 (30~50세)', '나 자신, 배우자', '꽃'],
      ['시주(時柱)', '노년기 (50세~)', '자녀, 제자', '열매'],
    ],
  };

  paragraphs.push(
    tip('기둥별 나이 구분은 대략적인 가이드예요. 실제로는 대운(大運)과 세운(歲運)에 따라 더 세밀하게 분석한답니다.'),
  );

  return {
    title: '네 기둥과 인생의 시기',
    paragraphs,
    tables: [lifespanTable],
  };
}

// ---------------------------------------------------------------------------
//  하위 섹션: 연지/월지/일지/시지 분위기 요약
// ---------------------------------------------------------------------------

function buildBranchVibeSubsection(input: ReportInput): import('../types.js').ReportSubsection {
  const { pillars } = input.saju;
  const paragraphs: ReportParagraph[] = [];
  const readOrder: PillarKey[] = ['year', 'month', 'day', 'hour'];

  const snapshots = readOrder.map((key) => {
    const pillar = pillars[key];
    const branchInfo = resolveBranch(pillar.branch.code, pillar.branch.hangul);
    const entry = resolveBranchEncyclopediaEntry(pillar.branch.code, pillar.branch.hangul);

    const branchHangul = entry?.hangul ?? branchInfo?.hangul ?? pillar.branch.hangul;
    const branchHanja = entry?.hanja ?? branchInfo?.hanja ?? pillar.branch.hanja;
    const animal = entry?.animal ?? branchInfo?.animal ?? '?';
    const season = entry?.season ?? '계절 정보 없음';
    const time = entry?.time ?? '시간 정보 없음';
    const vibe = entry?.vibe ?? '기본 분위기 정보 없음';
    const easyTip = entry
      ? pickFirst(entry.relationshipTips, '마음을 짧게라도 자주 표현해 보세요.')
      : '마음을 짧게라도 자주 표현해 보세요.';

    return {
      key,
      pillarLabel: PILLAR_KOREAN[key],
      pillarShort: PILLAR_KOREAN_SHORT[key],
      branchLabel: `${branchHangul}(${branchHanja})`,
      animalLabel: `${animal}띠`,
      season,
      time,
      vibe,
      easyTip,
    };
  });

  paragraphs.push(
    narrative('연지·월지·일지·시지는 각각 다른 계절감과 시간대의 리듬을 담고 있어요. 아래에서 쉬운 말로 핵심 분위기를 정리해 드릴게요.'),
  );

  for (const snapshot of snapshots) {
    paragraphs.push(
      narrative(
        `${snapshot.pillarShort}의 지지 ${snapshot.branchLabel}는 "${snapshot.vibe}" 느낌이 강해요. ` +
          `${snapshot.season}의 흐름, ${snapshot.time} 시간대와 닮았고 ` +
          `관계 팁으로는 "${snapshot.easyTip}"를 기억하면 좋아요.`,
      ),
    );
  }

  const vibeTable: ReportTable = {
    title: '연지·월지·일지·시지 핵심 분위기',
    headers: ['기둥', '지지', '동물', '계절감', '시간대', '한 줄 분위기'],
    rows: snapshots.map((snapshot) => [
      snapshot.pillarLabel,
      snapshot.branchLabel,
      snapshot.animalLabel,
      snapshot.season,
      snapshot.time,
      snapshot.vibe,
    ]),
  };

  paragraphs.push(
    tip('지지 분위기는 기본 성향 요약이에요. 실제 해석은 천간/오행/합충 관계를 함께 볼 때 더 정확해집니다.'),
  );

  return {
    title: '지지 분위기 한눈에 보기',
    paragraphs,
    tables: [vibeTable],
  };
}

// ---------------------------------------------------------------------------
//  메인 섹션 생성 함수
// ---------------------------------------------------------------------------

/**
 * 사주 원국표(Four Pillars Chart) 섹션을 생성합니다.
 *
 * 반환값에는 다음이 포함됩니다:
 *  - 사주 원국 테이블 (시주 | 일주 | 월주 | 연주)
 *  - 도입 서술 단락 (사주팔자 개념 설명)
 *  - 일간 및 각 기둥 해설 단락
 *  - 핵심 하이라이트 (일간, 띠, 기둥별 오행 등)
 *  - 하위 섹션: 천간과 지지 개념 / 네 기둥과 인생 시기
 */
export function generatePillarsSection(input: ReportInput): ReportSection {
  const rng = createRng(input);

  // 시드를 섹션 고유 오프셋만큼 진행하여 다른 섹션과 템플릿 충돌을 방지
  for (let i = 0; i < 3; i++) rng.next();

  const table = buildPillarsTable(input);
  const highlights = buildHighlights(input);
  const paragraphs = buildNarrativeParagraphs(input, rng);

  const conceptSub = buildConceptSubsection(rng);
  const lifespanSub = buildLifespanSubsection(rng);
  const branchVibeSub = buildBranchVibeSubsection(input);

  return {
    id: 'pillars',
    title: '사주 원국표',
    subtitle: '나를 이루는 여덟 글자의 비밀',
    paragraphs,
    tables: [table],
    highlights,
    subsections: [conceptSub, lifespanSub, branchVibeSub],
  };
}
