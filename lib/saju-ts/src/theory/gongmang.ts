/**
 * 공망론(空亡論) — 60갑자(六十甲子)에서의 공망(空亡) 이론
 *
 * 공망(空亡)이란 60갑자(六十甲子)를 10천간(十天干)과 12지지(十二地支)로
 * 순서대로 짝지을 때, 10천간이 먼저 소진되어 짝을 얻지 못하는 두 지지(地支)를
 * 가리킨다. 이를 공망(空亡) 또는 순공(旬空)이라 한다.
 *
 * 원리:
 *   60갑자는 갑자(甲子)에서 시작하여 癸亥(계해)로 끝난다.
 *   10천간과 12지지를 순서대로 짝지으면 천간은 6번 반복되고,
 *   지지는 5번 반복되어 총 60쌍이 만들어진다.
 *   각 순(旬)은 甲으로 시작하여 癸로 끝나며, 10쌍이 한 순을 이룬다.
 *   이때 지지는 12개인데 천간은 10개뿐이므로 각 순마다 두 지지가 남게 된다.
 *   남은 두 지지가 그 순의 공망이 된다.
 *
 * 공망의 종류:
 *   - 진공(眞空): 공망 지지가 원국에서 충(冲)·합(合)·형(刑) 등 어떠한
 *     구제(救濟)도 받지 못하는 순수한 공망. 공망의 작용이 완전하게 발현된다.
 *   - 가공(假空): 공망 지지가 충(冲)·합(合)·형(刑) 등으로 구제되어
 *     실질적 공망 작용이 약화되거나 소멸하는 상태. 이름만 공망이지
 *     실질적 작용은 거의 없다.
 *   - 순공(旬空): 같은 순(旬) 내의 공망. 일반적 공망을 의미한다.
 *   - 절대공망(絶對空亡): 일주와 시주의 공망이 동시에 같은 지지를 가리킬 때
 *     성립하는 가장 강력한 공망. 해소가 매우 어렵다.
 *
 * 공망의 해소:
 *   - 충공(冲空, 冲則實): 공망 지지를 충(冲)하면 오히려 공망이 깨져
 *     실(實)해진다. 단, 충공은 "해소"이되 동시에 변동을 수반한다.
 *     공망 지지가 흉신이면 충으로 발동(發動)하여 오히려 흉이 드러나기도 한다.
 *   - 합공(合空): 공망 지지가 육합(六合)·삼합(三合)에 참여하여
 *     합화(合化)가 이루어지면 공망의 작용이 소멸한다.
 *   - 전공(填空): 대운·세운에서 공망 지지가 직접 오면(채워지면)
 *     해당 시기에 공망이 해소되고 그 오행의 작용이 비로소 발현된다.
 *     전공의 시기에 인생의 전환점이 오는 경우가 많다.
 *
 * 공망의 적용:
 *   - 일주(日柱)를 기준으로 공망을 계산한다 (일공, 日空 — 가장 중요).
 *   - 시주(時柱) 기준 공망도 참고한다 (시공, 時空 — 보조적 판단).
 *   - 년주·월주·일주·시주 모두에 대한 공망을 각각 계산할 수 있다.
 *   - 공망된 지지(또는 그 지지의 지장간 오행)는 힘이 약해진다.
 *   - 대운·세운에서 공망이 오면 해당 시기의 길흉이 공(空)으로 돌아갈 수 있다.
 *   - 공망 지지에 해당하는 십신이 공망되면 그 십신의 작용이 약해진다.
 *   - 흉한 신살이 공망이면 오히려 흉의 작용이 줄어든다 (이공제흉, 以空制凶).
 *   - 태원(胎元)·명궁(命宮)의 지지도 공망 여부를 확인한다.
 *
 * 근거 문헌: 淵海子平(연해자평), 三命通會(삼명통회), 子平眞詮(자평진전)
 */

import type { StemIdx, BranchIdx } from '../core/cycle.js';

// ---------------------------------------------------------------------------
// 기본 타입
// ---------------------------------------------------------------------------

/**
 * 공망 그룹 데이터
 *
 * 60갑자의 6개 순(旬) 각각에 대한 공망 정보를 담는다.
 */
export interface GongmangGroup {
  /** 순 명칭 (로마자). 예: GAPJA_SUN (甲子旬) */
  sunName: string;
  /** 순 명칭 한자. 예: 甲子旬 */
  sunHanja: string;
  /** 순 시작 천간 인덱스. 모든 순은 甲(0)으로 시작한다. */
  startStemIdx: StemIdx;
  /** 순 시작 지지 인덱스. 예: 甲子旬은 子(0)에서 시작. */
  startBranchIdx: BranchIdx;
  /** 순 시작 간지 로마자. 예: GAPJA (甲子) */
  startGanzhi: string;
  /** 공망 지지 인덱스 배열 (항상 2개). 예: 甲子旬 공망 [10, 11] (戌·亥) */
  gongmangBranchIdx: [BranchIdx, BranchIdx];
  /** 공망 지지 로마자 배열. 예: SUL, HAE */
  gongmangNames: [string, string];
  /** 공망 지지 한자 배열. 예: 戌, 亥 */
  gongmangHanja: [string, string];
  /** 해당 순의 공망 이유와 의미 설명 */
  description: string;
}

/**
 * 공망 종류(種類) 분류
 *
 * JIN_GONG  : 진공(眞空) — 충·합·형 등 구제 없는 순수 공망
 * GA_GONG   : 가공(假空) — 충·합 등으로 구제되어 실질적 작용 소멸
 * JEOLDAE   : 절대공망(絶對空亡) — 일공·시공 동시 공망 (가장 강력)
 * SANGDAE   : 상대공망(相對空亡) — 일공 또는 시공 단독 공망 (일반적)
 */
export type GongmangJongryu = 'JIN_GONG' | 'GA_GONG' | 'JEOLDAE' | 'SANGDAE';

/**
 * 공망 해소(解消) 유형
 *
 * CHUNG_GONG : 충공(冲空) — 공망 지지와 육충 관계로 해소 (冲則實)
 * HAP_GONG   : 합공(合空) — 공망 지지가 육합·삼합에 참여하여 해소
 * JEON_GONG  : 전공(填空) — 대운·세운에서 공망 지지가 직접 와서 해소
 * MI_HAESO   : 미해소(未解消) — 해소 조건 없음 (진공 상태 유지)
 */
export type GongmangHaeso = 'CHUNG_GONG' | 'HAP_GONG' | 'JEON_GONG' | 'MI_HAESO';

/**
 * 주(柱) 위치 식별자
 *
 * NYEONJU : 년주(年柱)
 * WOLJU   : 월주(月柱)
 * ILJU    : 일주(日柱)
 * SIJU    : 시주(時柱)
 */
export type JuWichi = 'NYEONJU' | 'WOLJU' | 'ILJU' | 'SIJU';

/**
 * 공망 기준 구분
 *
 * IL_GONG : 일공(日空) — 일주 기준 공망 (가장 중요, 실무 표준)
 * SI_GONG : 시공(時空) — 시주 기준 공망 (보조적 참고)
 */
export type GongmangGijun = 'IL_GONG' | 'SI_GONG';

/**
 * 주(柱)별 공망 분석 결과
 */
export interface JuByeolGongmangResult {
  /** 어떤 주(柱)가 공망인지 */
  juWichi: JuWichi;
  /** 공망 기준 (일공/시공) */
  gijun: GongmangGijun;
  /** 해당 주(柱)의 지지 인덱스 */
  branchIdx: BranchIdx;
  /** 공망 여부 */
  isGongmang: boolean;
  /** 해당 주(柱)의 공망 의미 설명 */
  meaning: string;
}

/**
 * 공망·십신(十神) 관계 결과
 */
export interface GongmangSipsinResult {
  /** 공망된 십신 식별자 (로마자) */
  sipsin: string;
  /** 공망된 십신 한글명 */
  sipsinHangul: string;
  /** 공망이 해당 십신에 미치는 영향 */
  effect: string;
}

/**
 * 공망·신살(神殺) 관계 결과
 */
export interface GongmangSinsalResult {
  /** 공망된 신살명 */
  sinsalName: string;
  /** 신살의 길흉 분류 (GIL / HYUNG / GIL_HYUNG) */
  gilhyung: string;
  /** 공망이 해당 신살에 미치는 영향 */
  effect: string;
}

/**
 * 전공(填空) 시기 정보 — 대운·세운에서 공망이 채워지는 시기
 */
export interface JeonGongInfo {
  /** 전공 대상 지지 인덱스 */
  branchIdx: BranchIdx;
  /** 전공 대상 지지 한자 */
  branchHanja: string;
  /** 전공 시기의 의미 */
  meaning: string;
}

// ---------------------------------------------------------------------------
// 공망 테이블
// ---------------------------------------------------------------------------

/**
 * 60갑자 6순(六旬)의 공망 테이블
 *
 * 각 순(旬)은 甲부터 시작하는 10개의 간지(干支) 쌍으로 구성되며,
 * 남는 두 지지가 공망이 된다.
 *
 * 계산 근거:
 *   甲子旬: 甲子·乙丑·丙寅·丁卯·戊辰·己巳·庚午·辛未·壬申·癸酉 → 戌·亥 공망
 *   甲戌旬: 甲戌·乙亥·丙子·丁丑·戊寅·己卯·庚辰·辛巳·壬午·癸未 → 申·酉 공망
 *   甲申旬: 甲申·乙酉·丙戌·丁亥·戊子·己丑·庚寅·辛卯·壬辰·癸巳 → 午·未 공망
 *   甲午旬: 甲午·乙未·丙申·丁酉·戊戌·己亥·庚子·辛丑·壬寅·癸卯 → 辰·巳 공망
 *   甲辰旬: 甲辰·乙巳·丙午·丁未·戊申·己酉·庚戌·辛亥·壬子·癸丑 → 寅·卯 공망
 *   甲寅旬: 甲寅·乙卯·丙辰·丁巳·戊午·己未·庚申·辛酉·壬戌·癸亥 → 子·丑 공망
 *
 * 검증:
 *   6순 x 10쌍 = 60쌍 (60갑자 전체)
 *   각 순의 시작 지지: 0(子), 10(戌), 8(申), 6(午), 4(辰), 2(寅)
 *   시작 지지에서 10개를 차지하면 남는 2개가 공망:
 *     子순: 0~9 차지 → 10,11 공망 (戌,亥) ✓
 *     戌순: 10,11,0~7 차지 → 8,9 공망 (申,酉) ✓
 *     申순: 8~11,0~5 차지 → 6,7 공망 (午,未) ✓
 *     午순: 6~11,0~3 차지 → 4,5 공망 (辰,巳) ✓
 *     辰순: 4~11,0,1 차지 → 2,3 공망 (寅,卯) ✓
 *     寅순: 2~11 차지 → 0,1 공망 (子,丑) ✓
 *
 *   수학적 일반식: 순 시작 지지를 S라 하면
 *     공망1 = (S + 10) mod 12
 *     공망2 = (S + 11) mod 12
 *   이는 getGongmang() 함수에서 사용하는 공식과 동일하다.
 */
export const GONGMANG_TABLE: GongmangGroup[] = [
  // -- 甲子旬
  {
    sunName:           'GAPJA_SUN',
    sunHanja:          '甲子旬',
    startStemIdx:      0,   // 甲
    startBranchIdx:    0,   // 子
    startGanzhi:       'GAPJA',
    gongmangBranchIdx: [10, 11], // 戌·亥
    gongmangNames:     ['SUL', 'HAE'],
    gongmangHanja:     ['戌', '亥'],
    description:
      '甲子旬(갑자순): 甲子~癸酉의 10간지로 구성된다. ' +
      '子(0)부터 酉(9)까지 10개의 지지가 천간과 짝을 이루고, ' +
      '戌(10)·亥(11)는 짝을 얻지 못해 공망이 된다. ' +
      '이 순에 태어난 사람은 戌·亥에 해당하는 십신이 공망되어 ' +
      '해당 오행(火庫·水)의 기운이 약해진다.',
  },
  // -- 甲戌旬
  {
    sunName:           'GAPSUL_SUN',
    sunHanja:          '甲戌旬',
    startStemIdx:      0,   // 甲
    startBranchIdx:    10,  // 戌
    startGanzhi:       'GAPSUL',
    gongmangBranchIdx: [8, 9], // 申·酉
    gongmangNames:     ['SHIN', 'YU'],
    gongmangHanja:     ['申', '酉'],
    description:
      '甲戌旬(갑술순): 甲戌~癸未의 10간지로 구성된다. ' +
      '戌(10)부터 未(7)까지 순환하며 10개의 지지가 천간과 짝을 이루고, ' +
      '申(8)·酉(9)는 짝을 얻지 못해 공망이 된다. ' +
      '申·酉는 金의 기운으로, 이 순에 태어난 사람은 金 관련 십신이 공망된다.',
  },
  // -- 甲申旬
  {
    sunName:           'GAPSHIN_SUN',
    sunHanja:          '甲申旬',
    startStemIdx:      0,  // 甲
    startBranchIdx:    8,  // 申
    startGanzhi:       'GAPSHIN',
    gongmangBranchIdx: [6, 7], // 午·未
    gongmangNames:     ['O', 'MI'],
    gongmangHanja:     ['午', '未'],
    description:
      '甲申旬(갑신순): 甲申~癸巳의 10간지로 구성된다. ' +
      '申(8)부터 巳(5)까지 순환하며 10개의 지지가 천간과 짝을 이루고, ' +
      '午(6)·未(7)는 짝을 얻지 못해 공망이 된다. ' +
      '午·未는 火·土의 기운으로, 이 순에서 火·土 관련 십신이 공망된다.',
  },
  // -- 甲午旬
  {
    sunName:           'GAPO_SUN',
    sunHanja:          '甲午旬',
    startStemIdx:      0,  // 甲
    startBranchIdx:    6,  // 午
    startGanzhi:       'GAPO',
    gongmangBranchIdx: [4, 5], // 辰·巳
    gongmangNames:     ['JIN', 'SA'],
    gongmangHanja:     ['辰', '巳'],
    description:
      '甲午旬(갑오순): 甲午~癸卯의 10간지로 구성된다. ' +
      '午(6)부터 卯(3)까지 순환하며 10개의 지지가 천간과 짝을 이루고, ' +
      '辰(4)·巳(5)는 짝을 얻지 못해 공망이 된다. ' +
      '辰·巳는 土·火의 기운으로, 이 순에서 土·火 관련 십신이 공망된다.',
  },
  // -- 甲辰旬
  {
    sunName:           'GAPJIN_SUN',
    sunHanja:          '甲辰旬',
    startStemIdx:      0,  // 甲
    startBranchIdx:    4,  // 辰
    startGanzhi:       'GAPJIN',
    gongmangBranchIdx: [2, 3], // 寅·卯
    gongmangNames:     ['IN', 'MYO'],
    gongmangHanja:     ['寅', '卯'],
    description:
      '甲辰旬(갑진순): 甲辰~癸丑의 10간지로 구성된다. ' +
      '辰(4)부터 丑(1)까지 순환하며 10개의 지지가 천간과 짝을 이루고, ' +
      '寅(2)·卯(3)는 짝을 얻지 못해 공망이 된다. ' +
      '寅·卯는 木의 기운으로, 이 순에서 木 관련 십신이 공망된다.',
  },
  // -- 甲寅旬
  {
    sunName:           'GAPIN_SUN',
    sunHanja:          '甲寅旬',
    startStemIdx:      0,  // 甲
    startBranchIdx:    2,  // 寅
    startGanzhi:       'GAPIN',
    gongmangBranchIdx: [0, 1], // 子·丑
    gongmangNames:     ['JA', 'CHUK'],
    gongmangHanja:     ['子', '丑'],
    description:
      '甲寅旬(갑인순): 甲寅~癸亥의 10간지로 구성된다. ' +
      '寅(2)부터 亥(11)까지 순환하며 10개의 지지가 천간과 짝을 이루고, ' +
      '子(0)·丑(1)은 짝을 얻지 못해 공망이 된다. ' +
      '子·丑은 水·土의 기운으로, 이 순에서 水·土 관련 십신이 공망된다.',
  },
];

// ---------------------------------------------------------------------------
// 공망 특성 설명 상수
// ---------------------------------------------------------------------------

/** 공망(空亡) 이론의 핵심 개념 설명 */
export const GONGMANG_THEORY = {
  /**
   * 진공(眞空)
   *
   * 원국(原局) 내에서 공망 지지가 충(冲)·합(合)·형(刑) 등 어떠한
   * 구제(救濟)도 받지 못하는 순수한 공망.
   * 해당 오행·십신의 작용이 실질적으로 소멸하거나 무력화된다.
   *
   * 진공 성립 조건:
   *   1. 공망 지지가 사주 원국 4개 지지 중 어느 것과도 육합(六合)을 이루지 않음
   *   2. 공망 지지가 사주 원국 4개 지지 중 어느 것과도 삼합(三合)을 이루지 않음
   *   3. 공망 지지가 사주 원국 4개 지지 중 어느 것과도 육충(六冲)을 이루지 않음
   *   4. 공망 지지가 대운·세운에서도 합·충으로 채워지지 않은 시기
   *
   * 진공은 사주 원국에서 가장 무력한 상태이므로,
   * 해당 십신의 작용을 사실상 "없는 것"에 가깝게 본다.
   */
  jinGong:
    '진공(眞空): 공망 지지가 합(合)이나 충(冲)으로 해소되지 않는 완전한 공망. ' +
    '해당 오행·십신의 작용이 실질적으로 소멸하거나 무력화된다. ' +
    '사주 원국 내에서 공망 지지와 육합·삼합·육충 관계가 전혀 없을 때 성립한다.',

  /**
   * 가공(假空)
   *
   * 공망 지지가 원국 또는 운(運)에서 충(冲)·합(合)·형(刑) 등으로
   * 구제되어 실질적 공망 작용이 약화 또는 소멸한 상태.
   *
   * 가공 성립 조건:
   *   1. 공망 지지가 원국 내 다른 지지와 육합(六合)을 이루는 경우
   *   2. 공망 지지가 원국 내 다른 지지들과 삼합(三合)을 이루는 경우
   *   3. 공망 지지가 원국 내 다른 지지와 육충(六冲)을 이루는 경우 (충공)
   *   4. 대운·세운에서 공망 지지가 직접 오는 경우 (전공)
   *
   * 가공일 때 해당 십신은 공망이 아닌 것처럼 작용하되,
   * 완전한 정상 상태보다는 약간 약한 것으로 본다.
   */
  gaGong:
    '가공(假空): 공망 지지가 충(冲)·합(合)·형(刑) 등으로 구제되어 ' +
    '실질적 공망 작용이 소멸하거나 크게 약화된 상태. ' +
    '이름만 공망이지 실제 작용은 거의 없다. ' +
    '원국 내에서 육합·삼합·육충 관계가 있으면 가공으로 본다.',

  /**
   * 순공(旬空)
   *
   * 일반적인 공망. 같은 순(旬) 안에서 짝을 얻지 못한 지지를 가리킨다.
   * 실무에서는 일주(日柱)를 기준으로 순공을 계산한다.
   */
  sunGong:
    '순공(旬空): 60갑자의 각 순(旬)에서 천간과 짝을 이루지 못해 ' +
    '남겨진 두 지지. 일주(日柱) 기준으로 계산하는 것이 원칙이다.',

  /**
   * 충공(冲空)
   *
   * 공망 지지를 충(冲)하면 오히려 공망이 채워져(實) 공망 작용이 해소된다.
   * 冲則實(충즉실)의 원리.
   *
   * 단서:
   *   - 충공은 해소이면서 동시에 변동을 수반한다.
   *   - 길신이 공망일 때 충공이 되면 길한 작용이 되살아나지만,
   *     충의 변동성(이동·충격)도 함께 나타난다.
   *   - 흉한 신살이 공망일 때 충공이 되면 흉이 발동(發動)하여
   *     오히려 흉사가 현실화될 수 있다 (충공발동, 冲空發動).
   */
  chungGong:
    '충공(冲空, 冲則實): 공망 지지를 충(冲)하면 공망이 깨져 실(實)해진다. ' +
    '공망 지지와 육충(六冲) 관계에 있는 지지가 사주에 있으면 공망이 해소된다. ' +
    '단, 충공은 변동을 수반하며, 흉한 공망이 충으로 발동하면 오히려 흉사가 현실화될 수 있다.',

  /**
   * 합공(合空)
   *
   * 공망 지지가 삼합(三合)·육합(六合)에 참여하면 공망이 해소된다.
   * 합은 결합·조화의 작용이므로, 충공에 비해 안정적으로 해소된다.
   *
   * 세부:
   *   - 육합(六合): 子丑, 寅亥, 卯戌, 辰酉, 巳申, 午未
   *   - 삼합(三合): 申子辰(수국), 寅午戌(화국), 巳酉丑(금국), 亥卯未(목국)
   *   - 합화(合化)가 완성되면 공망이 완전히 해소된다.
   *   - 반합(半合)만으로는 해소 여부에 학파별 견해 차이가 있으나,
   *     일반적으로 반합도 부분적 해소로 본다.
   */
  hapGong:
    '합공(合空): 공망 지지가 육합(六合) 또는 삼합(三合)에 참여하여 ' +
    '합화(合化)가 이루어지면 공망의 작용이 소멸한다. ' +
    '합에 의한 해소는 충공보다 안정적이며, 해당 십신의 작용이 자연스럽게 회복된다.',

  /**
   * 전공(填空)
   *
   * 대운(大運)·세운(歲運)에서 공망 지지가 직접 와서 빈자리를 채우는 것.
   * 원국에서 공망이었던 오행·십신의 작용이 비로소 발현되는 시기이다.
   *
   * 전공의 의미:
   *   - 원국에서 진공(眞空)이었던 것이 대운·세운에서 전공이 되면
   *     인생의 큰 전환점이 될 수 있다.
   *   - 재성(財星)이 공망이었다가 전공이 되면 재물운이 살아난다.
   *   - 관성(官星)이 공망이었다가 전공이 되면 직업·명예운이 살아난다.
   *   - 전공의 시기에 원국의 "잠자던" 기운이 깨어나므로 변화가 크다.
   */
  jeonGong:
    '전공(填空): 대운·세운에서 공망 지지가 직접 오면(채워지면) ' +
    '해당 시기에 공망이 해소되고 그 오행의 작용이 비로소 발현된다. ' +
    '전공의 시기에 인생의 전환점이 오는 경우가 많으며, ' +
    '원국에서 억눌려 있던 기운이 한꺼번에 발동하여 큰 변화를 일으킨다.',

  /**
   * 절대공망(絶對空亡)
   *
   * 일주(日柱)와 시주(時柱)의 공망이 동시에 같은 지지를 가리킬 때
   * 성립하는 가장 강력한 공망.
   *
   * 조건:
   *   일주 기준 공망 지지와 시주 기준 공망 지지가 겹칠 때,
   *   그 겹치는 지지는 절대공망이 된다.
   *
   * 특성:
   *   - 진공보다 더 강한 공망으로, 해소가 매우 어렵다.
   *   - 해당 오행·십신의 작용이 극도로 약화된다.
   *   - 대운·세운에서 전공(填空)이 되더라도 효과가 제한적이다.
   *   - 단, 절대공망이 흉신·흉살에 해당하면 오히려 흉이 완전히 제거되어
   *     길하게 작용하기도 한다.
   */
  jeoldaeGongmang:
    '절대공망(絶對空亡): 일주와 시주의 공망이 동시에 같은 지지를 가리킬 때 성립. ' +
    '6순 체계에서 가장 강력한 공망으로, 해소가 매우 어렵다. ' +
    '해당 십신의 작용이 극도로 약화되나, 흉신이 절대공망이면 오히려 흉이 완전히 제거될 수 있다.',

  /**
   * 상대공망(相對空亡)
   *
   * 일공(日空) 또는 시공(時空) 중 하나에만 해당하는 일반적 공망.
   * 대부분의 공망은 상대공망이며, 충·합·전공으로 해소 가능하다.
   *
   * 절대공망과 대비되는 개념으로, 상대적으로 가볍고 해소가 용이하다.
   */
  sangdaeGongmang:
    '상대공망(相對空亡): 일공(日空) 또는 시공(時空) 중 하나에만 해당하는 일반적 공망. ' +
    '절대공망에 비해 작용이 약하며, 충(冲)·합(合)·전공(填空)으로 해소가 가능하다.',

  /**
   * 일공(日空) vs 시공(時空)
   *
   * 일공(日空): 일주(日柱)의 천간·지지를 기준으로 계산한 공망.
   *   사주명리학에서 가장 중요하게 다루는 공망이다.
   *   일간(日干)은 "나" 자체를 뜻하므로, 일주 기준의 공망은
   *   명주(命主)의 인생 전반에 가장 직접적인 영향을 미친다.
   *
   * 시공(時空): 시주(時柱)의 천간·지지를 기준으로 계산한 공망.
   *   시주는 말년(末年)과 자녀(子女)를 상징하므로,
   *   시공은 말년운·자녀운에 주로 영향을 미친다.
   *   실무에서는 일공에 비해 보조적으로 참고하되,
   *   시공과 일공이 겹치면 절대공망으로 격상된다.
   */
  ilGongVsSiGong:
    '일공(日空): 일주 기준 공망. 명주의 인생 전반에 가장 직접적 영향. ' +
    '사주명리학에서 가장 중요한 공망이다.\n' +
    '시공(時空): 시주 기준 공망. 말년운·자녀운에 주로 영향. ' +
    '일공에 비해 보조적이나, 일공과 겹치면 절대공망이 된다.',

  /** 공망의 실무 적용 원칙 */
  application:
    '적용 원칙: ' +
    '(1) 일주(日柱) 천간·지지를 기준으로 공망을 계산한다 (일공, 최우선). ' +
    '(2) 시주(時柱) 기준 공망도 보조적으로 확인한다 (시공). ' +
    '(3) 공망된 지지 자체와 그 지지의 지장간(藏干)이 모두 약해진다. ' +
    '(4) 공망된 십신은 작용이 미약하거나 공허해진다. ' +
    '(5) 운(運)에서 공망 지지가 오면 전공(填空)이 되어 해당 기운이 발현된다. ' +
    '(6) 공망 지지가 충(冲)으로 해소되면 변동과 함께 발현된다 (충공). ' +
    '(7) 공망 지지가 합(合)으로 해소되면 안정적으로 발현된다 (합공). ' +
    '(8) 흉한 신살이 공망이면 오히려 흉의 작용이 줄어든다 (이공제흉). ' +
    '(9) 태원(胎元)·명궁(命宮)의 지지도 공망 여부를 확인한다. ' +
    '(10) 일공과 시공이 겹치면 절대공망(絶對空亡)으로 매우 강력하다.',
} as const;

// ---------------------------------------------------------------------------
// 주(柱)별 공망 의미 상수
// ---------------------------------------------------------------------------

/**
 * 각 주(柱)에 공망이 걸렸을 때의 의미
 *
 * 년주·월주·일주(일지)·시주 각각에 대해 공망의 영향을 기술한다.
 * 여기서 "주(柱)가 공망"이라 함은 해당 주(柱)의 지지가
 * 일주(日柱) 기준 공망 지지에 해당한다는 뜻이다.
 */
export const JU_BYEOL_GONGMANG_MEANING: Record<JuWichi, string> = {
  /**
   * 년주(年柱) 공망
   *
   * 년주는 조상·부모·유년기(0~15세 전후)를 상징한다.
   * 년주가 공망이면:
   *   - 조상·부모의 덕(德)이 약하거나 부모의 도움을 받기 어렵다.
   *   - 유년기에 고생하거나 부모와 일찍 이별하는 경우가 있다.
   *   - 가문(家門)의 재산·사회적 지위에 의지하기 어렵다.
   *   - 독립심이 일찍 발달하여 자수성가(自手成家) 성향을 보인다.
   *   - 고향을 떠나 타지에서 성공하는 경우가 많다.
   */
  NYEONJU:
    '년주(年柱) 공망: 조상·부모 덕이 약하다. ' +
    '유년기(0~15세)에 어려움이 있거나 부모와의 인연이 박하다. ' +
    '가문·부모의 재산에 의지하기 어려워 일찍 독립하는 성향을 보인다. ' +
    '고향을 떠나 타지에서 자수성가(自手成家)하는 경우가 많다.',

  /**
   * 월주(月柱) 공망
   *
   * 월주는 형제·자매·청년기(15~30세 전후)를 상징한다.
   * 또한 월주는 사회적 활동의 기반으로, 직업의 초기 형태를 나타내기도 한다.
   * 월주가 공망이면:
   *   - 형제·자매 간의 정(情)이 박하거나 형제 덕이 약하다.
   *   - 청년기에 방황하거나 진로 결정이 늦어질 수 있다.
   *   - 직업 초기에 불안정하거나 잦은 변동이 있다.
   *   - 가업(家業)을 이어받기 어렵다.
   */
  WOLJU:
    '월주(月柱) 공망: 형제·자매 덕이 약하다. ' +
    '청년기(15~30세)에 방황하거나 진로가 늦게 확정되는 경향이 있다. ' +
    '형제간 정이 박하고, 직업 초기에 불안정할 수 있다. ' +
    '가업을 이어받기보다 독자적 길을 개척하게 된다.',

  /**
   * 일주(日柱) — 일지(日支) 공망
   *
   * 일지는 배우자·중년기(30~50세 전후)·내면을 상징한다.
   * 일지 자체가 공망이 되는 것은 구조상 불가능하다.
   * (일주가 속한 순 안에서 일지는 반드시 짝을 이루므로)
   * 따라서 이 항목은 이론적 참고용으로만 둔다.
   *
   * 다만 "일지의 공망" 대신 "일주 기준 공망이 다른 주에 미치는 영향"이
   * 실무에서의 핵심이다.
   */
  ILJU:
    '일주(日柱) 일지는 구조상 자기 순(旬)의 공망에 해당할 수 없다. ' +
    '(일주 자체가 공망 계산의 기준이므로, 일지는 반드시 순 내에 포함됨) ' +
    '실무에서는 일주 기준 공망이 다른 주(柱)의 지지에 미치는 영향을 본다.',

  /**
   * 시주(時柱) 공망
   *
   * 시주는 자녀·말년(50세 이후)·결실을 상징한다.
   * 시주가 공망이면:
   *   - 자녀 덕이 약하거나 자녀와의 인연이 박하다.
   *   - 자녀가 적거나 자녀로 인한 걱정이 있을 수 있다.
   *   - 말년에 외로움을 느끼거나 자녀의 부양을 받기 어렵다.
   *   - 단, 시주 공망이 흉신에 해당하면 오히려 흉이 줄어 길하게 작용한다.
   *   - 말년의 결실이 공허해지므로 중년까지의 준비가 중요하다.
   */
  SIJU:
    '시주(時柱) 공망: 자녀 덕이 약하다. ' +
    '말년(50세 이후)에 자녀의 도움을 받기 어렵거나 자녀와의 인연이 박하다. ' +
    '자녀가 적거나 자녀로 인한 근심이 있을 수 있다. ' +
    '말년의 결실이 공허해질 수 있으므로 중년까지의 준비가 중요하다.',
};

// ---------------------------------------------------------------------------
// 공망·십신 관계 상수
// ---------------------------------------------------------------------------

/**
 * 십신(十神)이 공망되었을 때의 의미
 *
 * 일간(日干) 기준으로 공망 지지의 지장간(藏干)이 어떤 십신에 해당하느냐에 따라
 * 해당 십신의 작용이 약화된다.
 *
 * 키: 십신 식별자(TenGod), 값: 공망 시 영향 설명
 */
export const GONGMANG_SIPSIN_EFFECT: Record<string, {
  hangul: string;
  effect: string;
}> = {
  BI_GYEON: {
    hangul: '비견',
    effect:
      '비견(比肩) 공망: 형제·친구·동료의 도움이 약해진다. ' +
      '독립적이지만 외로운 구조가 되며, 공동사업에서 동업자의 기여가 미미하다.',
  },
  GEOB_JAE: {
    hangul: '겁재',
    effect:
      '겁재(劫財) 공망: 재물 탈취의 흉이 줄어들어 오히려 길하게 작용할 수 있다. ' +
      '단, 겁재의 추진력·결단력도 함께 약해지므로 적극성이 부족해질 수 있다.',
  },
  SIK_SHIN: {
    hangul: '식신',
    effect:
      '식신(食神) 공망: 식복(食福)과 재능 발휘가 약해진다. ' +
      '의식주(衣食住)가 불안정하거나 창의적 재능이 발휘되기 어렵다. ' +
      '편인(도식)의 폐해는 줄어들 수 있으나, 기본적 먹복이 약화된다.',
  },
  SANG_GWAN: {
    hangul: '상관',
    effect:
      '상관(傷官) 공망: 상관의 흉작용(관재구설, 직업 불안)이 줄어든다. ' +
      '동시에 상관의 재능·표현력도 약해지므로, 예술적·창의적 발현이 억제된다. ' +
      '여명(女命)에서 상관 공망은 자녀 인연이 약해질 수 있다.',
  },
  PYEON_JAE: {
    hangul: '편재',
    effect:
      '편재(偏財) 공망: 재물운이 불안정하다. ' +
      '유동자금·사업자금의 흐름이 원활하지 않고, 횡재를 기대하기 어렵다. ' +
      '남명(男命)에서 편재 공망은 아버지와의 인연이 박하거나 이성 관계가 공허해질 수 있다.',
  },
  JEONG_JAE: {
    hangul: '정재',
    effect:
      '정재(正財) 공망: 안정적 재산 축적이 어렵다. ' +
      '봉급·고정 수입이 불안정하거나 절약·저축이 잘 되지 않는다. ' +
      '남명(男命)에서 정재 공망은 처(妻) 덕이 약하거나 배우자 인연이 늦을 수 있다.',
  },
  PYEON_GWAN: {
    hangul: '편관',
    effect:
      '편관(偏官/칠살) 공망: 편관의 흉작용(압박·형액)이 크게 줄어든다. ' +
      '칠살이 공망이면 "무해한 칠살"이 되어 오히려 길하다. ' +
      '단, 권위·통솔력도 약화되므로 리더십이 요구되는 직업에서 불리할 수 있다.',
  },
  JEONG_GWAN: {
    hangul: '정관',
    effect:
      '정관(正官) 공망: 직업운·명예운이 불안정하다. ' +
      '공직·사회적 지위가 공허해지거나 승진·출세가 더딜 수 있다. ' +
      '여명(女命)에서 정관 공망은 남편 인연이 약하거나 결혼이 늦을 수 있다.',
  },
  PYEON_IN: {
    hangul: '편인',
    effect:
      '편인(偏印/도식) 공망: 편인의 도식(倒食) 흉작용이 줄어든다. ' +
      '식신이 보호되어 식복(食福)이 오히려 보전될 수 있다. ' +
      '단, 편인의 학문적·종교적 탐구력도 약화되어 전문성이 떨어질 수 있다.',
  },
  JEONG_IN: {
    hangul: '정인',
    effect:
      '정인(正印) 공망: 학문·자격·어머니의 보호가 약해진다. ' +
      '학업 성취가 더디거나 자격증·명예 취득이 늦을 수 있다. ' +
      '어머니와의 인연이 박하거나 어머니의 건강이 우려될 수 있다.',
  },
};

// ---------------------------------------------------------------------------
// 공망·신살 관계 상수
// ---------------------------------------------------------------------------

/**
 * 공망과 신살(神殺)의 관계 원칙
 *
 * 핵심 원리: "이공제흉(以空制凶), 공중유길(空中有吉)"
 *   흉한 신살이 공망에 빠지면 흉의 작용이 줄어들어 오히려 길하게 작용할 수 있다.
 *   반대로 길한 신살이 공망에 빠지면 길의 작용이 줄어들어 아쉬운 구조가 된다.
 */
export const GONGMANG_SINSAL_PRINCIPLES = {
  /**
   * 흉살(凶殺) + 공망
   *
   * 흉한 신살이 공망이면 그 흉작용이 크게 약화된다.
   * 예: 도화살(桃花煞)이 공망 → 이성 문제·색정의 화가 줄어듦
   *     양인(羊刃)이 공망 → 과격함·부상의 위험이 줄어듦
   *     원진살(怨嗔煞)이 공망 → 인간관계 반목이 약화됨
   *
   * 단, 충공(冲空)이 되면 흉살이 다시 발동하므로 주의해야 한다.
   */
  hyungsalGongmang:
    '흉살(凶殺) + 공망: 흉한 신살이 공망에 빠지면 흉의 작용이 줄어든다. ' +
    '양인·도화살·원진살 등이 공망이면 해당 흉의 폐해가 약화된다. ' +
    '단, 충공(冲空)이 되면 흉살이 다시 발동하여 흉사가 현실화될 수 있으므로 주의한다.',

  /**
   * 길신(吉神) + 공망
   *
   * 길한 신살이 공망이면 그 길작용이 약화된다.
   * 예: 천을귀인(天乙貴人)이 공망 → 귀인의 도움이 미미해짐
   *     문창귀인(文昌貴人)이 공망 → 학문적 성취가 약화됨
   *     학당귀인(學堂貴人)이 공망 → 학업 능력이 발휘되기 어려움
   *
   * 길신 공망은 "있으나 마나 한" 상태가 된다.
   * 대운·세운에서 전공(填空)이 되면 그때 비로소 길신의 작용이 살아난다.
   */
  gilsinGongmang:
    '길신(吉神) + 공망: 길한 신살이 공망에 빠지면 길의 작용이 약화된다. ' +
    '천을귀인·문창귀인 등이 공망이면 귀인의 도움이나 학문적 혜택을 받기 어렵다. ' +
    '대운·세운에서 전공(填空)이 되면 비로소 길신의 작용이 살아난다.',

  /**
   * 역마살(驛馬煞) + 공망
   *
   * 역마살이 공망이면 이동·변동은 하나 성과가 없는 구조.
   * "빈 수레가 달리는 형상"이라 하여,
   * 활동은 많지만 실질적 결과가 없는 상태를 나타낸다.
   * 삼명통회(三命通會)에서 특히 강조하는 조합이다.
   */
  yeokmasalGongmang:
    '역마살(驛馬煞) + 공망: 이동·변화는 있으나 성과가 없다. ' +
    '"빈 수레가 달리는 형상"으로, 활동은 많지만 실질적 결과가 미미하다. ' +
    '해외 이동·잦은 출장은 있으되 실적·수익이 따르지 않는다.',
} as const;

// ---------------------------------------------------------------------------
// 태원·명궁 공망 상수
// ---------------------------------------------------------------------------

/**
 * 태원(胎元)·명궁(命宮)의 공망
 *
 * 태원(胎元): 수태월(受胎月)의 간지. 월주 기준으로 역산.
 * 명궁(命宮): 생월(生月)과 생시(生時)로 산출하는 보조 궁위(宮位).
 *
 * 태원·명궁의 지지도 일주 기준 공망 여부를 확인하며,
 * 공망일 경우 각각의 의미가 약화된다.
 */
export const TAEWON_MYEONGGUNG_GONGMANG = {
  /**
   * 태원(胎元) 공망
   *
   * 태원 지지가 일주 기준 공망이면:
   *   - 수태(受胎) 환경이 불안정했거나 임신 과정에 어려움이 있었을 수 있다.
   *   - 선천적 체질이 약하거나 유아기 건강에 유의해야 한다.
   *   - 부모와의 인연이 박하거나 태어난 환경이 불안정할 수 있다.
   *   - 태원 공망은 원국 공망에 비해 작용이 약하므로 보조적으로 참고한다.
   */
  taeWyeonGongmang:
    '태원(胎元) 공망: 태원 지지가 일주 기준 공망이면 ' +
    '수태 환경의 불안정, 선천적 체질 약화, 유아기 건강 문제가 우려된다. ' +
    '부모와의 인연이 박하거나 태어난 환경이 불안정할 수 있다. ' +
    '원국 공망에 비해 작용이 약하므로 보조적으로 참고한다.',

  /**
   * 명궁(命宮) 공망
   *
   * 명궁 지지가 일주 기준 공망이면:
   *   - 인생의 큰 방향성이 불분명하거나 정체성 혼란이 있을 수 있다.
   *   - 잠재된 재능·성격이 발현되기 어렵거나 늦게 나타난다.
   *   - 명궁이 나타내는 궁위(宮位)의 기운이 약화된다.
   *   - 대운·세운에서 전공(填空)이 되면 비로소 인생의 방향이 잡힌다.
   */
  myeonggungGongmang:
    '명궁(命宮) 공망: 명궁 지지가 일주 기준 공망이면 ' +
    '인생의 방향성이 불분명하거나 잠재된 재능이 늦게 발현된다. ' +
    '정체성 혼란이 있을 수 있으나, 대운·세운에서 전공(填空)이 되면 ' +
    '비로소 인생의 방향이 잡히고 재능이 꽃피운다.',
} as const;

// ---------------------------------------------------------------------------
// 대운·세운에서의 공망 영향
// ---------------------------------------------------------------------------

/**
 * 대운(大運)·세운(歲運)에서의 공망 영향 원칙
 */
export const DAEWUN_SEWUN_GONGMANG = {
  /**
   * 대운에서 공망 지지가 오는 경우 (전공, 填空)
   *
   * 원국에서 공망이었던 지지가 대운의 지지로 와서 "빈자리를 채우는" 것.
   * 10년간 해당 오행·십신의 기운이 비로소 활성화된다.
   *
   * 의미:
   *   - 원국에서 진공(眞空)이었던 것이 대운에서 전공이 되면
   *     인생의 큰 전환점이 온다. 새로운 시작·변화의 시기.
   *   - 재성 공망이 전공이 되면 10년간 재물운이 살아난다.
   *   - 관성 공망이 전공이 되면 10년간 직업·명예운이 활성화된다.
   *   - 인성 공망이 전공이 되면 10년간 학문·자격 운이 열린다.
   *   - 단, 전공 시기의 "갑작스러운 활성화"는 변동을 동반하므로
   *     준비가 부족하면 오히려 혼란이 올 수 있다.
   */
  daewunJeonGong:
    '대운 전공(填空): 원국에서 공망이었던 지지가 대운의 지지로 오면 ' +
    '10년간 해당 오행·십신의 기운이 활성화된다. 인생의 전환점이 되는 시기로, ' +
    '그동안 억눌려 있던 기운이 한꺼번에 발현된다. ' +
    '재성 전공 → 재물운 활성화, 관성 전공 → 명예·직업운 활성화, ' +
    '인성 전공 → 학문·자격운 개방.',

  /**
   * 세운에서 공망 지지가 오는 경우 (세운 전공)
   *
   * 세운(歲運, 매년 태세)에서 공망 지지가 오면 그해에 한하여 전공이 발생한다.
   * 대운 전공에 비해 기간이 짧으나(1년), 해당 해에 집중적 변화가 온다.
   *
   * 의미:
   *   - 세운에서 전공이 되는 해에 중요한 결정·변화가 일어나기 쉽다.
   *   - 대운과 세운이 동시에 전공이 되면 효과가 극대화된다.
   */
  sewunJeonGong:
    '세운 전공(填空): 매년 태세에서 공망 지지가 오면 그해에 한하여 ' +
    '해당 기운이 활성화된다. 대운 전공에 비해 기간은 짧으나 ' +
    '집중적 변화가 오며, 대운과 세운 전공이 겹치면 효과가 극대화된다.',

  /**
   * 대운·세운 자체의 공망 여부
   *
   * 대운의 천간·지지를 하나의 간지로 보고, 그 간지가 속한 순(旬)의 공망을
   * 계산하여 원국 지지가 해당 공망에 포함되는지 확인하는 방법도 있다.
   * 이를 "운에서의 역공망(逆空亡)"이라 하며, 일부 학파에서 사용한다.
   *
   * 그러나 주류 실무에서는 일주 기준 공망이 가장 중요하며,
   * 운에서의 역공망은 참고 수준으로만 다룬다.
   */
  unEseoGongmang:
    '운(運)에서의 공망: 대운·세운의 간지가 속한 순(旬)의 공망을 ' +
    '계산하여 원국 지지와 대조하는 방법(역공망). ' +
    '일부 학파에서 사용하나, 주류 실무에서는 일주 기준 공망을 최우선으로 본다.',
} as const;

// ---------------------------------------------------------------------------
// 핵심 함수
// ---------------------------------------------------------------------------

/**
 * 일주(日柱)의 천간·지지 인덱스로 공망 지지 배열을 반환한다.
 *
 * 계산 원리:
 *   순 시작 지지 = (branchIdx - stemIdx + 12) % 12
 *   공망 지지 1  = (순 시작 지지 + 10) % 12
 *   공망 지지 2  = (순 시작 지지 + 11) % 12
 *
 * 수학적 증명:
 *   간지(干支) 쌍에서 순 내 위치(offset) = stemIdx (0~9).
 *   순의 첫 지지 S = (branchIdx - stemIdx) mod 12.
 *   순은 S, S+1, ..., S+9 (mod 12)의 10개 지지를 사용하므로
 *   남는 지지 = S+10, S+11 (mod 12).
 *
 * 간지 유효성:
 *   60갑자에서 유효한 간지 쌍은 stemIdx와 branchIdx의 음양(홀짝)이 같아야 한다.
 *   stemIdx % 2 !== branchIdx % 2 이면 무효한 간지이므로 null을 반환한다.
 *
 * @param stemIdx   - 일간 인덱스 (0=甲 ~ 9=癸)
 * @param branchIdx - 일지 인덱스 (0=子 ~ 11=亥)
 * @returns 공망 지지 인덱스 배열 (2개), 유효하지 않은 간지면 null
 *
 * @example
 * getGongmang(0, 0)  // 甲子일주 → [10, 11] (戌·亥 공망)
 * getGongmang(0, 2)  // 甲寅일주 → [0, 1]  (子·丑 공망)
 * getGongmang(1, 1)  // 乙丑일주 → [10, 11] (戌·亥 공망, 甲子旬 소속)
 * getGongmang(0, 1)  // 甲丑 → null (음양 불일치: 甲은 양, 丑은 음 — 무효)
 */
export function getGongmang(
  stemIdx: StemIdx,
  branchIdx: BranchIdx,
): [BranchIdx, BranchIdx] | null {
  const s = ((stemIdx   % 10) + 10) % 10;
  const b = ((branchIdx % 12) + 12) % 12;

  // 유효성 검사: 60갑자에서 천간·지지의 음양(홀짝)이 같아야 유효한 간지
  if (s % 2 !== b % 2) return null;

  // 순(旬) 시작 지지 역산: 순 내 위치 = s, 시작 지지 = (b - s + 12) % 12
  const sunStartBranch = ((b - s) % 12 + 12) % 12;

  const gm1 = (sunStartBranch + 10) % 12;
  const gm2 = (sunStartBranch + 11) % 12;

  return [gm1 as BranchIdx, gm2 as BranchIdx];
}

/**
 * 특정 지지가 일주 기준 공망인지 확인한다.
 *
 * @param stemIdx         - 일간 인덱스 (0=甲 ~ 9=癸)
 * @param branchIdx       - 일지 인덱스 (0=子 ~ 11=亥)
 * @param targetBranchIdx - 공망 여부를 확인할 지지 인덱스
 * @returns 공망 여부 (true: 공망, false: 공망 아님 또는 유효하지 않은 간지)
 *
 * @example
 * isGongmang(0, 0, 10) // 甲子일주에서 戌(10)이 공망인가? → true
 * isGongmang(0, 0, 11) // 甲子일주에서 亥(11)이 공망인가? → true
 * isGongmang(0, 0, 9)  // 甲子일주에서 酉(9)가 공망인가?  → false
 * isGongmang(0, 2, 0)  // 甲寅일주에서 子(0)이 공망인가?  → true
 */
export function isGongmang(
  stemIdx: StemIdx,
  branchIdx: BranchIdx,
  targetBranchIdx: BranchIdx,
): boolean {
  const gm = getGongmang(stemIdx, branchIdx);
  if (gm === null) return false;
  const target = ((targetBranchIdx % 12) + 12) % 12;
  return gm[0] === target || gm[1] === target;
}

/**
 * 일주가 속하는 순(旬) 그룹 데이터를 반환한다.
 *
 * @param stemIdx   - 일간 인덱스 (0=甲 ~ 9=癸)
 * @param branchIdx - 일지 인덱스 (0=子 ~ 11=亥)
 * @returns GongmangGroup 또는 null (유효하지 않은 간지)
 *
 * @example
 * getGongmangGroup(0, 0)  // 甲子일주 → GONGMANG_TABLE[0] (甲子旬)
 * getGongmangGroup(1, 1)  // 乙丑일주 → GONGMANG_TABLE[0] (甲子旬)
 * getGongmangGroup(0, 2)  // 甲寅일주 → GONGMANG_TABLE[5] (甲寅旬)
 */
export function getGongmangGroup(
  stemIdx: StemIdx,
  branchIdx: BranchIdx,
): GongmangGroup | null {
  const gm = getGongmang(stemIdx, branchIdx);
  if (gm === null) return null;

  return (
    GONGMANG_TABLE.find(
      (g) =>
        g.gongmangBranchIdx[0] === gm[0] &&
        g.gongmangBranchIdx[1] === gm[1],
    ) ?? null
  );
}

// ---------------------------------------------------------------------------
// 시공(時空) 함수
// ---------------------------------------------------------------------------

/**
 * 시주(時柱) 기준 공망 지지 배열을 반환한다 (시공, 時空).
 *
 * 시공은 일공(日空)과 같은 계산 원리를 사용하되,
 * 기준 간지가 시주(時柱)가 된다.
 *
 * @param siganIdx   - 시간(時干) 인덱스 (0=甲 ~ 9=癸)
 * @param sijiIdx    - 시지(時支) 인덱스 (0=子 ~ 11=亥)
 * @returns 시공 지지 인덱스 배열 (2개), 유효하지 않으면 null
 *
 * @example
 * getSiGong(0, 0) // 甲子시주 → [10, 11] (戌·亥 시공)
 */
export function getSiGong(
  siganIdx: StemIdx,
  sijiIdx: BranchIdx,
): [BranchIdx, BranchIdx] | null {
  return getGongmang(siganIdx, sijiIdx);
}

// ---------------------------------------------------------------------------
// 절대공망(絶對空亡) 판별
// ---------------------------------------------------------------------------

/**
 * 절대공망(絶對空亡) 여부를 판별한다.
 *
 * 일공(日空)과 시공(時空)의 공망 지지가 겹치는 경우 절대공망이 성립한다.
 * 겹치는 지지 인덱스 배열을 반환한다 (0~2개).
 *
 * @param ilganIdx  - 일간(日干) 인덱스
 * @param iljiIdx   - 일지(日支) 인덱스
 * @param siganIdx  - 시간(時干) 인덱스
 * @param sijiIdx   - 시지(時支) 인덱스
 * @returns 절대공망 지지 인덱스 배열 (겹치는 것들). 빈 배열이면 절대공망 없음.
 *
 * @example
 * // 일주 甲子(일공: 戌亥), 시주 甲戌(시공: 申酉) → 겹침 없음 → []
 * getJeoldaeGongmang(0, 0, 0, 10) // []
 *
 * // 일주와 시주의 공망이 같은 경우 → 절대공망
 * // 일주 甲子(일공: 戌亥), 시주 壬申(시공: 戌亥) → 戌亥 모두 겹침 → [10, 11]
 * getJeoldaeGongmang(0, 0, 8, 8) // [10, 11]
 */
export function getJeoldaeGongmang(
  ilganIdx: StemIdx,
  iljiIdx: BranchIdx,
  siganIdx: StemIdx,
  sijiIdx: BranchIdx,
): BranchIdx[] {
  const ilGong = getGongmang(ilganIdx, iljiIdx);
  const siGong = getSiGong(siganIdx, sijiIdx);

  if (ilGong === null || siGong === null) return [];

  const siGongSet = new Set(siGong);
  return ilGong.filter((b) => siGongSet.has(b));
}

// ---------------------------------------------------------------------------
// 진공(眞空) vs 가공(假空) 판별
// ---------------------------------------------------------------------------

/** 육합(六合) 상대 지지 계산: (1 - idx) mod 12 */
function yukhapPartner(idx: BranchIdx): BranchIdx {
  return (((1 - idx) % 12) + 12) % 12 as BranchIdx;
}

/** 육충(六冲) 상대 지지 계산: (idx + 6) mod 12 */
function chungPartner(idx: BranchIdx): BranchIdx {
  return ((idx + 6) % 12) as BranchIdx;
}

/**
 * 삼합(三合) 그룹 멤버 배열 반환.
 * 지지 idx가 속한 삼합국의 세 멤버를 반환한다.
 *
 * 삼합국:
 *   申子辰(수국, 0-4-8), 寅午戌(화국, 2-6-10),
 *   巳酉丑(금국, 1-5-9), 亥卯未(목국, 3-7-11)
 *
 * 모든 지지는 정확히 하나의 삼합국에 속한다.
 * 삼합국의 정점(旺支)을 기준으로: 점(旺)+4, 점(旺)+8 (mod 12).
 */
function samhapMembers(idx: BranchIdx): [BranchIdx, BranchIdx, BranchIdx] {
  const b = ((idx % 12) + 12) % 12;
  // 삼합은 4간격: b, b+4, b+8 (mod 12) 중 하나가 이 idx.
  // 어떤 삼합 그룹에 속하는지: b mod 4 로 기점(base) 결정
  // base 그룹: {0,4,8}, {1,5,9}, {2,6,10}, {3,7,11}
  const base = b % 4;
  return [base as BranchIdx, (base + 4) as BranchIdx, (base + 8) as BranchIdx];
}

/**
 * 공망 지지가 원국(原局) 4개 지지와의 관계에서
 * 진공(眞空)인지 가공(假空)인지 판별한다.
 *
 * 판별 기준:
 *   - 공망 지지가 원국 내 어느 지지와 육합(六合)을 이루면 → 가공 (합공 해소)
 *   - 공망 지지가 원국 내 어느 지지와 육충(六冲)을 이루면 → 가공 (충공 해소)
 *   - 공망 지지가 원국 내 지지들과 삼합(三合)을 완성하면 → 가공 (합공 해소)
 *   - 위 조건 모두 해당 없으면 → 진공
 *
 * @param gongmangBranch - 공망 지지 인덱스
 * @param wonGukBranches - 원국 4개 지지 인덱스 배열 [년지, 월지, 일지, 시지]
 * @returns 'JIN_GONG' (진공) 또는 'GA_GONG' (가공)
 *
 * @example
 * // 甲子일주 공망 = 戌(10), 원국 지지에 辰(4)이 있으면 戌辰 충 → 가공
 * isJinGongOrGaGong(10, [0, 2, 0, 4]) // 'GA_GONG'
 *
 * // 甲子일주 공망 = 亥(11), 원국에 합·충 대상 없으면 → 진공
 * isJinGongOrGaGong(11, [0, 2, 0, 6]) // 'JIN_GONG'
 */
export function isJinGongOrGaGong(
  gongmangBranch: BranchIdx,
  wonGukBranches: BranchIdx[],
): GongmangJongryu {
  const gmb = ((gongmangBranch % 12) + 12) % 12 as BranchIdx;
  const branches = wonGukBranches.map((b) => (((b % 12) + 12) % 12) as BranchIdx);

  // 1. 육합(六合) 확인: 공망 지지의 육합 상대가 원국에 있는지
  const hapPartner = yukhapPartner(gmb);
  if (branches.includes(hapPartner)) return 'GA_GONG';

  // 2. 육충(六冲) 확인: 공망 지지의 충 상대가 원국에 있는지
  const chPartner = chungPartner(gmb);
  if (branches.includes(chPartner)) return 'GA_GONG';

  // 3. 삼합(三合) 확인: 공망 지지를 포함한 삼합 3인방이 모두 원국에 있는지
  const [a, b, c] = samhapMembers(gmb);
  const allPresent = new Set([...branches, gmb]);
  if (allPresent.has(a) && allPresent.has(b) && allPresent.has(c)) {
    // 공망 지지 자체는 이미 포함, 나머지 2개가 원국에 있으면 삼합 완성
    const othersInWonGuk = [a, b, c]
      .filter((x) => x !== gmb)
      .every((x) => branches.includes(x));
    if (othersInWonGuk) return 'GA_GONG';
  }

  return 'JIN_GONG';
}

// ---------------------------------------------------------------------------
// 공망 해소(解消) 유형 판별
// ---------------------------------------------------------------------------

/**
 * 공망 지지의 해소 유형을 판별한다.
 *
 * @param gongmangBranch - 공망 지지 인덱스
 * @param wonGukBranches - 원국 4개 지지 인덱스 배열
 * @returns 해소 유형. 해소되지 않으면 'MI_HAESO'.
 *
 * 우선순위:
 *   1. 합(合)으로 해소 → 'HAP_GONG' (가장 안정적)
 *   2. 충(冲)으로 해소 → 'CHUNG_GONG' (변동 수반)
 *   3. 해소 없음 → 'MI_HAESO' (진공 상태)
 *
 * 전공(填空)은 대운·세운 지지와 비교해야 하므로
 * 별도 함수(isJeonGong)에서 판별한다.
 */
export function getHaesoYuhyeong(
  gongmangBranch: BranchIdx,
  wonGukBranches: BranchIdx[],
): GongmangHaeso {
  const gmb = ((gongmangBranch % 12) + 12) % 12 as BranchIdx;
  const branches = wonGukBranches.map((b) => (((b % 12) + 12) % 12) as BranchIdx);

  // 육합 확인
  if (branches.includes(yukhapPartner(gmb))) return 'HAP_GONG';

  // 삼합 확인
  const [a, b, c] = samhapMembers(gmb);
  const others = [a, b, c].filter((x) => x !== gmb);
  if (others.every((x) => branches.includes(x))) return 'HAP_GONG';

  // 육충 확인
  if (branches.includes(chungPartner(gmb))) return 'CHUNG_GONG';

  return 'MI_HAESO';
}

/**
 * 대운·세운 지지가 전공(填空)에 해당하는지 확인한다.
 *
 * 전공(填空): 대운·세운의 지지가 원국의 공망 지지와 동일할 때 성립.
 * 해당 시기에 공망이 채워져 그 오행·십신의 작용이 발현된다.
 *
 * @param ilganIdx      - 일간 인덱스
 * @param iljiIdx       - 일지 인덱스
 * @param unBranchIdx   - 대운 또는 세운의 지지 인덱스
 * @returns 전공 여부 (true: 전공, false: 전공 아님)
 *
 * @example
 * // 甲子일주(공망: 戌·亥), 대운 지지 戌(10) → 전공
 * isJeonGong(0, 0, 10) // true
 *
 * // 甲子일주(공망: 戌·亥), 대운 지지 子(0) → 전공 아님
 * isJeonGong(0, 0, 0)  // false
 */
export function isJeonGong(
  ilganIdx: StemIdx,
  iljiIdx: BranchIdx,
  unBranchIdx: BranchIdx,
): boolean {
  return isGongmang(ilganIdx, iljiIdx, unBranchIdx);
}

// ---------------------------------------------------------------------------
// 주(柱)별 공망 분석
// ---------------------------------------------------------------------------

/**
 * 사주 4개 주(柱)에 대한 공망 분석을 수행한다.
 *
 * 일주(日柱) 기준으로 년지·월지·시지의 공망 여부를 확인하고,
 * 각 주(柱)별 공망의 의미를 반환한다.
 *
 * 참고: 일지(日支) 자체는 자기 순(旬)에 반드시 포함되므로 공망이 될 수 없다.
 *
 * @param ilganIdx  - 일간(日干) 인덱스
 * @param iljiIdx   - 일지(日支) 인덱스
 * @param nyeonjiIdx - 년지(年支) 인덱스
 * @param woljiIdx  - 월지(月支) 인덱스
 * @param sijiIdx   - 시지(時支) 인덱스
 * @returns 주(柱)별 공망 분석 결과 배열
 */
export function analyzeJuByeolGongmang(
  ilganIdx: StemIdx,
  iljiIdx: BranchIdx,
  nyeonjiIdx: BranchIdx,
  woljiIdx: BranchIdx,
  sijiIdx: BranchIdx,
): JuByeolGongmangResult[] {
  const targets: Array<{ juWichi: JuWichi; branchIdx: BranchIdx }> = [
    { juWichi: 'NYEONJU', branchIdx: nyeonjiIdx },
    { juWichi: 'WOLJU',   branchIdx: woljiIdx },
    { juWichi: 'ILJU',    branchIdx: iljiIdx },
    { juWichi: 'SIJU',    branchIdx: sijiIdx },
  ];

  return targets.map(({ juWichi, branchIdx }) => ({
    juWichi,
    gijun: 'IL_GONG' as GongmangGijun,
    branchIdx,
    isGongmang: isGongmang(ilganIdx, iljiIdx, branchIdx),
    meaning: JU_BYEOL_GONGMANG_MEANING[juWichi],
  }));
}

// ---------------------------------------------------------------------------
// 공망 종합 분석 인터페이스 및 함수
// ---------------------------------------------------------------------------

/**
 * 공망 종합 분석 결과
 */
export interface GongmangAnalysis {
  /** 일주가 속한 순(旬) 그룹 */
  sunGroup: GongmangGroup | null;
  /** 일공(日空) 공망 지지 [2개] */
  ilGong: [BranchIdx, BranchIdx] | null;
  /** 시공(時空) 공망 지지 [2개] (시주 정보가 제공된 경우) */
  siGong: [BranchIdx, BranchIdx] | null;
  /** 절대공망 지지 (일공·시공 겹침) */
  jeoldaeGongmang: BranchIdx[];
  /** 주(柱)별 공망 분석 */
  juByeol: JuByeolGongmangResult[];
  /** 각 공망 지지의 진공/가공 판별 */
  jinGongGaGong: Array<{
    branchIdx: BranchIdx;
    jongryu: GongmangJongryu;
    haeso: GongmangHaeso;
  }>;
}

/**
 * 사주 전체에 대한 공망 종합 분석을 수행한다.
 *
 * @param ilganIdx   - 일간 인덱스
 * @param iljiIdx    - 일지 인덱스
 * @param nyeonjiIdx - 년지 인덱스
 * @param woljiIdx   - 월지 인덱스
 * @param siganIdx   - 시간 인덱스 (선택)
 * @param sijiIdx    - 시지 인덱스 (선택)
 * @returns 공망 종합 분석 결과
 *
 * @example
 * const result = analyzeGongmang(0, 0, 2, 4, 6, 8);
 * // 甲子일주, 년지=寅, 월지=辰, 시간=庚, 시지=申
 * // ilGong: [10, 11] (戌·亥)
 * // result.jinGongGaGong 에서 각 공망 지지의 진공/가공 여부 확인 가능
 */
export function analyzeGongmang(
  ilganIdx: StemIdx,
  iljiIdx: BranchIdx,
  nyeonjiIdx: BranchIdx,
  woljiIdx: BranchIdx,
  siganIdx?: StemIdx,
  sijiIdx?: BranchIdx,
): GongmangAnalysis {
  const sunGroup = getGongmangGroup(ilganIdx, iljiIdx);
  const ilGong = getGongmang(ilganIdx, iljiIdx);
  const wonGukBranches = [nyeonjiIdx, woljiIdx, iljiIdx];

  let siGong: [BranchIdx, BranchIdx] | null = null;
  let jeoldae: BranchIdx[] = [];

  if (sijiIdx !== undefined) {
    wonGukBranches.push(sijiIdx);
  }

  if (siganIdx !== undefined && sijiIdx !== undefined) {
    siGong = getSiGong(siganIdx, sijiIdx);
    jeoldae = getJeoldaeGongmang(ilganIdx, iljiIdx, siganIdx, sijiIdx);
  }

  const juByeol = sijiIdx !== undefined
    ? analyzeJuByeolGongmang(ilganIdx, iljiIdx, nyeonjiIdx, woljiIdx, sijiIdx)
    : analyzeJuByeolGongmang(ilganIdx, iljiIdx, nyeonjiIdx, woljiIdx, 0 as BranchIdx);

  // 각 공망 지지에 대한 진공/가공 판별
  const jinGongGaGong: GongmangAnalysis['jinGongGaGong'] = [];
  if (ilGong !== null) {
    for (const gmBranch of ilGong) {
      const jongryu = isJinGongOrGaGong(gmBranch, wonGukBranches);
      const haeso = getHaesoYuhyeong(gmBranch, wonGukBranches);
      jinGongGaGong.push({ branchIdx: gmBranch, jongryu, haeso });
    }
  }

  return {
    sunGroup,
    ilGong,
    siGong,
    jeoldaeGongmang: jeoldae,
    juByeol,
    jinGongGaGong,
  };
}

// ---------------------------------------------------------------------------
// 공망·십신 관계 조회
// ---------------------------------------------------------------------------

/**
 * 공망된 십신의 영향을 조회한다.
 *
 * @param sipsinName - 십신 식별자 (TenGod 문자열)
 * @returns 공망·십신 관계 결과 또는 null
 */
export function getGongmangSipsinEffect(
  sipsinName: string,
): GongmangSipsinResult | null {
  const data = GONGMANG_SIPSIN_EFFECT[sipsinName];
  if (!data) return null;

  return {
    sipsin: sipsinName,
    sipsinHangul: data.hangul,
    effect: data.effect,
  };
}

// ---------------------------------------------------------------------------
// 공망 6순 완전 검증 테이블
// ---------------------------------------------------------------------------

/**
 * 6순(六旬) 각각의 완전한 간지-공망 대응 검증 테이블.
 *
 * 검증 목적: getGongmang() 함수의 수학적 결과가
 * 전통 이론의 6순 공망 배치와 정확히 일치하는지 확인하는 데 사용한다.
 *
 * 각 항목은 순의 이름, 10개 간지 목록(stemIdx + branchIdx 쌍), 공망 지지 쌍.
 *
 * 검증 방법:
 *   각 간지 쌍에 대해 getGongmang(stemIdx, branchIdx)를 호출하면
 *   해당 순의 공망 지지와 동일한 결과가 나와야 한다.
 */
export const GONGMANG_VERIFICATION_TABLE: ReadonlyArray<{
  sunName: string;
  /** 10개 간지: [stemIdx, branchIdx] 쌍 */
  ganzhi: ReadonlyArray<readonly [StemIdx, BranchIdx]>;
  /** 공망 지지 쌍 [첫째, 둘째] */
  gongmang: readonly [BranchIdx, BranchIdx];
}> = [
  {
    sunName: '甲子旬',
    ganzhi: [[0,0],[1,1],[2,2],[3,3],[4,4],[5,5],[6,6],[7,7],[8,8],[9,9]],
    gongmang: [10, 11], // 戌·亥
  },
  {
    sunName: '甲戌旬',
    ganzhi: [[0,10],[1,11],[2,0],[3,1],[4,2],[5,3],[6,4],[7,5],[8,6],[9,7]],
    gongmang: [8, 9], // 申·酉
  },
  {
    sunName: '甲申旬',
    ganzhi: [[0,8],[1,9],[2,10],[3,11],[4,0],[5,1],[6,2],[7,3],[8,4],[9,5]],
    gongmang: [6, 7], // 午·未
  },
  {
    sunName: '甲午旬',
    ganzhi: [[0,6],[1,7],[2,8],[3,9],[4,10],[5,11],[6,0],[7,1],[8,2],[9,3]],
    gongmang: [4, 5], // 辰·巳
  },
  {
    sunName: '甲辰旬',
    ganzhi: [[0,4],[1,5],[2,6],[3,7],[4,8],[5,9],[6,10],[7,11],[8,0],[9,1]],
    gongmang: [2, 3], // 寅·卯
  },
  {
    sunName: '甲寅旬',
    ganzhi: [[0,2],[1,3],[2,4],[3,5],[4,6],[5,7],[6,8],[7,9],[8,10],[9,11]],
    gongmang: [0, 1], // 子·丑
  },
];
