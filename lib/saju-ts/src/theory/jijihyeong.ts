/**
 * 지지형론(地支刑論) — 지지 삼형(三刑)·이형(二刑)·자형(自刑) 이론
 *
 * 형(刑)이란 두 지지 또는 세 지지가 서로 충돌하여
 * 형벌·재해·변화의 기운을 발생시키는 관계이다.
 *
 * 분류:
 * - 삼형(三刑): 세 지지가 형하는 관계
 *   - 인사신 무은지형(寅巳申 無恩之刑): 은혜를 모르는 형
 *   - 축술미 지세지형(丑戌未 持勢之刑): 세력을 믿는 형
 * - 이형(二刑): 두 지지의 형
 *   - 자묘 무례지형(子卯 無禮之刑): 예의 없는 형
 * - 자형(自刑): 같은 지지끼리의 형
 *   - 진진·오오·유유·해해 (辰辰·午午·酉酉·亥亥)
 *
 * 형살(刑殺) 강도 순서 (가장 강한 것부터):
 *   삼형(三刑) 전체 > 반삼형(半三刑) > 이형(二刑) > 자형(自刑)
 *
 * 삼형 내부 강도 비교:
 *   무은지형(寅巳申) >= 지세지형(丑戌未) > 무례지형(子卯)
 *   - 무은지형은 木·火·金의 삼각 상극으로 파괴력이 가장 강하다.
 *   - 지세지형은 土끼리의 충돌로 완고한 마찰이지만 오행 극은 없다.
 *   - 무례지형은 이형으로, 삼형에 비해 관여 지지가 적어 상대적으로 약하다.
 */

import type { BranchIdx } from '../core/cycle.js';

// ---------------------------------------------------------------------------
// 지지 이름 타입 (jiji.ts 와 동일한 표기)
// ---------------------------------------------------------------------------

export type BranchName =
  | 'JA' | 'CHUK' | 'IN' | 'MYO' | 'JIN' | 'SA'
  | 'O' | 'MI' | 'SHIN' | 'YU' | 'SUL' | 'HAE';

export const BRANCH_NAME_TO_IDX: Record<BranchName, BranchIdx> = {
  JA: 0, CHUK: 1, IN: 2, MYO: 3, JIN: 4, SA: 5,
  O: 6, MI: 7, SHIN: 8, YU: 9, SUL: 10, HAE: 11,
} as const;

// ---------------------------------------------------------------------------
// 형(刑)의 종류 분류
// ---------------------------------------------------------------------------

/**
 * 형(刑)의 종류를 나타내는 유니온 타입
 *
 * - SAMHYEONG: 삼형(三刑) — 세 지지가 모두 있는 완전한 형
 * - BAN_SAMHYEONG: 반삼형(半三刑) — 삼형 그룹의 두 지지만 있는 불완전한 형
 * - IHYEONG: 이형(二刑) — 두 지지의 형
 * - JAHYEONG: 자형(自刑) — 같은 지지 두 개 이상의 형
 */
export type HyeongType = 'SAMHYEONG' | 'BAN_SAMHYEONG' | 'IHYEONG' | 'JAHYEONG';

// ---------------------------------------------------------------------------
// 삼형(三刑)
// ---------------------------------------------------------------------------

/**
 * 삼형(三刑) 그룹 인터페이스
 */
export interface SamhyeongGroup {
  /** 세 지지 로마자 */
  branches: [BranchName, BranchName, BranchName];
  /** 형의 명칭 */
  name: string;
  /** 형의 성질 설명 */
  nature: string;
  /** 형의 작용 — 사주에서의 영향 */
  effect: string;
  /** 건강 영향 */
  health: string;
  /** 성격 영향 */
  personality: string;
  /** 관계 영향 */
  relationship: string;
  /** 반삼형(半刑) 조합별 해석 — 세 지지 중 두 지지만 있을 때 */
  banHyeong: Array<{
    pair: [BranchName, BranchName];
    /** 한자 표기 */
    hanja: string;
    /** 반형 해석 */
    interpretation: string;
  }>;
}

/**
 * 삼형(三刑) 그룹 목록
 *
 * 삼형은 세 지지가 서로 형(刑)의 관계를 맺어 강한 변동·재해를 일으키는 구조다.
 */
export const SAMHYEONG_GROUPS: SamhyeongGroup[] = [
  {
    branches: ['IN', 'SA', 'SHIN'],     // 寅巳申
    name:     '인사신 무은지형(寅巳申 無恩之刑)',
    nature:
      '은혜를 모르는 형. 인목(寅)·사화(巳)·신금(申)이 각각 서로를 형한다. ' +
      '寅의 甲목이 巳의 庚금을 극하고(木剋金은 아니나 寅 중 戊가 巳의 庚을 생하여 배은), ' +
      '巳의 丙화가 申의 庚금을 극하며(火剋金), 申의 庚금이 寅의 甲목을 극하는(金剋木) ' +
      '삼각 상극 관계가 형으로 발현된다. ' +
      '세 지지가 각각 생지(生地)에 해당하여 에너지가 강하고 변동력이 크다.',
    effect:
      '형법·관재(官災)·수술·교통사고·배은망덕 등의 사건과 연관. ' +
      '세 지지가 모두 있을 때 형의 작용이 가장 강하고, 두 지지만 있어도 반형(半刑)으로 작용한다. ' +
      '대운(大運)·세운(歲運)에서 나머지 한 지지가 들어오면 삼형이 완성되어 큰 변동이 온다.',
    health:
      '간담(肝膽, 寅-木)·심장·소장(巳-火)·폐·대장(申-金) 관련 질환에 주의. ' +
      '교통사고, 수술, 외상 등 급성 질환·사고와 관련이 깊다. ' +
      '특히 寅巳의 반형은 간·심장, 巳申의 반형은 심장·폐, 寅申의 반형은 간·폐 질환에 유의해야 한다.',
    personality:
      '은혜를 갚지 못하는 성향, 배은망덕으로 오해받기 쉽다. ' +
      '독립심이 강하고 남에게 의지하지 않으려 하며, 관계에서 보은(報恩)의 의식이 약하다. ' +
      '결단력은 강하나 인정에 약하여 냉정하다는 평가를 받을 수 있다.',
    relationship:
      '부모·스승·은인과의 관계에서 갈등이 생기기 쉽다. ' +
      '받은 도움에 대한 감사의 표현이 부족하여 관계가 소원해진다. ' +
      '직장 상사·선배와의 관계에서 마찰이 생길 수 있으며, ' +
      '특히 년주와 월주에 있으면 부모와의 인연이 박하고, ' +
      '일주와 시주에 있으면 자녀·배우자와의 갈등 소지가 있다.',
    banHyeong: [
      {
        pair: ['IN', 'SA'],               // 寅巳
        hanja: '寅巳',
        interpretation:
          '인사(寅巳) 반형: 寅(木)이 巳(火)를 생하지만 巳 속의 庚금이 寅의 甲목을 극한다. ' +
          '도움을 주었으나 되려 해를 당하는 형상. 은인에게 배신당하는 일, ' +
          '사업에서 투자했으나 손해를 보는 일과 연관된다. 형벌·관재의 기운이 강하다.',
      },
      {
        pair: ['SA', 'SHIN'],             // 巳申
        hanja: '巳申',
        interpretation:
          '사신(巳申) 반형: 巳申은 육합(合水) 관계이면서 동시에 형을 이루는 이중적 구조. ' +
          '합하면서 형하므로 겉으로는 친밀하나 내면에서 갈등이 끓는다. ' +
          '巳(火)가 申(金)을 극하는 화극금(火剋金)의 작용으로 ' +
          '계약·사업·파트너십에서 예상치 못한 파국이 올 수 있다.',
      },
      {
        pair: ['IN', 'SHIN'],             // 寅申
        hanja: '寅申',
        interpretation:
          '인신(寅申) 반형: 寅과 申은 충(沖) 관계이면서 반삼형도 성립한다. ' +
          '충과 형이 겹치므로 작용력이 매우 강하다. 申(金)이 寅(木)을 극하는 금극목(金剋木)의 작용. ' +
          '급격한 변동, 이사, 직업 변동, 교통사고 등 물리적 충격과 관련이 깊다.',
      },
    ],
  },
  {
    branches: ['CHUK', 'SUL', 'MI'],    // 丑戌未
    name:     '축술미 지세지형(丑戌未 持勢之刑)',
    nature:
      '세력을 믿는 형. 축토(丑)·술토(戌)·미토(未)는 모두 토(土) 오행이지만 ' +
      '서로 세력 다툼으로 형을 이룬다. 토(土)끼리의 충돌이므로 완고·고집·다툼의 성질이 있다. ' +
      '丑은 습토(濕土, 겨울), 戌은 조토(燥土, 가을), 未는 조토(燥土, 여름)로 ' +
      '같은 토이지만 성질이 달라 충돌한다. ' +
      '세 지지가 모두 사고지(四庫地)에 해당하여 저장·고집·집착의 기운이 삼중으로 작용한다.',
    effect:
      '관재(官災)·구설·고집으로 인한 손실·신체 비장·위장 질환과 연관. ' +
      '세 지지가 모두 있을 때 형의 작용이 최대로 발현된다. ' +
      '권력 다툼, 조직 내 세력 갈등, 재산 분쟁 등 "힘"과 관련된 문제가 많다. ' +
      '토(土)의 과다로 인해 체증, 부종, 비만 등 정체 현상이 두드러진다.',
    health:
      '비장(脾臟)·위(胃)·복부 질환이 주된 영향. 토(土)의 과다로 ' +
      '소화불량, 위장병, 비만, 당뇨, 부종, 피부 질환에 유의해야 한다. ' +
      '丑의 습토와 戌·未의 조토가 충돌하여 체내 수분 균형이 깨지기 쉽다.',
    personality:
      '자기 세력과 입장을 굽히지 않는 고집스러운 성향. ' +
      '한번 정한 것은 끝까지 밀어붙이며 타인의 의견을 잘 수용하지 않는다. ' +
      '의지가 강하고 끈기가 있지만, 유연성이 부족하여 주변과 마찰이 잦다. ' +
      '자존심이 강하고 체면을 중시한다.',
    relationship:
      '조직 내 세력 다툼, 권력 투쟁에 휘말리기 쉽다. ' +
      '동료·형제와의 다툼, 재산 분쟁, 상속 갈등과 관련이 깊다. ' +
      '서로 양보하지 않아 관계가 교착 상태에 빠지기 쉬우며, ' +
      '특히 년주·월주에 있으면 가문·집안 내 분쟁, ' +
      '일주·시주에 있으면 부부 간 고집 대립이 발생한다.',
    banHyeong: [
      {
        pair: ['CHUK', 'SUL'],            // 丑戌
        hanja: '丑戌',
        interpretation:
          '축술(丑戌) 반형: 丑(습토)과 戌(조토)의 충돌. 丑과 戌은 충(沖) 관계이기도 하다. ' +
          '충과 형이 겹치므로 작용이 강하며, 습기와 건조함의 대립으로 ' +
          '비장·위장 질환, 토지·부동산 분쟁, 상속 갈등과 연관된다.',
      },
      {
        pair: ['SUL', 'MI'],              // 戌未
        hanja: '戌未',
        interpretation:
          '술미(戌未) 반형: 戌(조토)과 未(조토)의 충돌. 같은 조토끼리의 대립으로 ' +
          '화기(火氣)가 과다해지기 쉽다(戌 속 丁, 未 속 丁). ' +
          '열성 질환, 피부병, 구설, 소송과 연관. 파(破) 관계이기도 하여 이중으로 작용한다.',
      },
      {
        pair: ['CHUK', 'MI'],             // 丑未
        hanja: '丑未',
        interpretation:
          '축미(丑未) 반형: 丑과 未는 충(沖) 관계이면서 반삼형도 성립한다. ' +
          '충과 형이 동시에 작용하므로 변동이 크다. 습토(丑)와 조토(未)의 정면 대결로 ' +
          '재산 분쟁, 부동산 문제, 이사, 위장·소화기 질환과 강하게 연관된다.',
      },
    ],
  },
];

// ---------------------------------------------------------------------------
// 이형(二刑)
// ---------------------------------------------------------------------------

/**
 * 이형(二刑) 항목 인터페이스
 */
export interface Ihyeong {
  /** 두 지지 로마자 */
  branches: [BranchName, BranchName];
  /** 형의 명칭 */
  name: string;
  /** 형의 성질 */
  nature: string;
  /** 형의 작용 */
  effect: string;
  /** 건강 영향 */
  health: string;
  /** 성격 영향 */
  personality: string;
  /** 관계 영향 */
  relationship: string;
}

/**
 * 이형(二刑) 목록
 *
 * 두 지지가 서로 형(刑)의 관계를 맺는다.
 */
export const IHYEONG_PAIRS: Ihyeong[] = [
  {
    branches: ['JA', 'MYO'],            // 子卯
    name:     '자묘 무례지형(子卯 無禮之刑)',
    nature:
      '예의 없는 형. 자수(子水)와 묘목(卯木)은 수생목(水生木)의 상생 관계이지만 ' +
      '형(刑)을 이루어 예의와 예절을 모르는 형으로 불린다. ' +
      '子가 卯를 생하지만 卯가 그 은혜를 모르고 무례하게 행동하는 형상이다. ' +
      '상생 관계에서 형이 발생하는 것은 "과도한 생(生)"이 오히려 해가 되는 원리다. ' +
      '子(水왕지)와 卯(木왕지)가 모두 왕지(旺地)로서 기운이 과다하여 예를 잃는다.',
    effect:
      '관재·색정(色情)·방종·무례로 인한 화(禍)·신체 신장·방광 문제와 연관. ' +
      '법도를 어기는 일, 성적 문란, 예절 결여로 인한 사회적 문제가 발생하기 쉽다. ' +
      '특히 도화(桃花)와 겹치면 색정 문제가 두드러지고, ' +
      '관성(官星)과 겹치면 법률 문제로 이어질 수 있다.',
    health:
      '신장(腎臟)·방광(子-水)과 간(肝)·담(卯-木) 관련 질환. ' +
      '과음·과식 등 방종으로 인한 건강 손상, 간 질환, 비뇨기 질환에 유의. ' +
      '정신적으로 불안정하여 신경성 질환이 동반될 수 있다.',
    personality:
      '예의와 격식을 지키기 어려운 성향. 자유분방하고 격식에 얽매이지 않으나, ' +
      '그것이 무례함으로 표출되기 쉽다. 충동적이고 즉흥적인 행동이 많으며, ' +
      '감정 표현이 직설적이라 주위 사람에게 불편을 줄 수 있다. ' +
      '규범과 규율을 가볍게 여기는 경향이 있다.',
    relationship:
      '윗사람에게 무례하여 관계가 틀어지기 쉽다. ' +
      '연장자·상급자에 대한 예우가 부족하여 사회적 마찰이 발생하며, ' +
      '부부 관계에서 상대방에 대한 배려가 부족하여 갈등이 생긴다. ' +
      '색정 문제로 인한 관계 파탄의 위험이 있다. ' +
      '월주·일주에 자묘형이 있으면 직장에서 상급자와의 마찰이 잦다.',
  },
];

// ---------------------------------------------------------------------------
// 자형(自刑)
// ---------------------------------------------------------------------------

/**
 * 자형(自刑) 항목 인터페이스
 *
 * 동일한 지지가 두 개 이상 있을 때 스스로를 형하는 관계.
 */
export interface Jahyeong {
  /** 자형하는 지지 */
  branch: BranchName;
  /** 한자 */
  hanja: string;
  /** 자형의 성질 설명 */
  nature: string;
  /** 건강 영향 */
  health: string;
  /** 성격 영향 */
  personality: string;
  /** 관계 영향 */
  relationship: string;
}

/**
 * 자형(自刑) 목록
 *
 * 진·오·유·해(辰·午·酉·亥) 지지가 사주에 같은 지지가 두 개 이상 있으면 자형이 성립한다.
 *
 * 자형은 네 가지 형 중 작용력이 가장 약하지만,
 * 자기 자신을 해치는 내면적 갈등이므로 외부에서 잘 드러나지 않아 해결이 어렵다.
 * 자형의 네 지지는 辰(土)·午(火)·酉(金)·亥(水)로, 木을 제외한 네 오행이다.
 * 이들은 각각 자기 오행의 성질이 극에 달해 스스로를 훼손하는 구조를 가진다.
 */
export const JAHYEONG_BRANCHES: Jahyeong[] = [
  {
    branch: 'JIN',
    hanja: '辰',
    nature:
      '진토(辰土) 자형 — 자기 스스로를 해치는 기운. 강박·집착·과욕과 연관. ' +
      '辰은 수고(水庫)이자 봄의 습토(濕土)로, 많은 것을 품으려 하다가 ' +
      '과부하가 걸려 스스로 무너지는 형상이다.',
    health:
      '위장·비장 질환, 체증, 부종. 辰의 습기가 중복되어 습담(濕痰)이 쌓이기 쉽다. ' +
      '만성 소화불량, 부종, 습진 등 습(濕) 관련 질환에 유의.',
    personality:
      '완벽하게 모든 것을 통제하려는 강박 성향. 과도한 욕심으로 스스로를 몰아세운다. ' +
      '이상이 높지만 현실과의 괴리에 괴로워하며, 자기 비판이 심하다.',
    relationship:
      '타인에게 기대하는 기준이 높아 실망하기 쉽고, ' +
      '그 실망이 자기 자신에게로 향하여 자책하는 패턴이 반복된다.',
  },
  {
    branch: 'O',
    hanja: '午',
    nature:
      '오화(午火) 자형 — 과도한 열정이 자신을 태우는 기운. 급화·흥분·심장 문제와 연관. ' +
      '午는 화(火)의 왕지로 양기(陽氣)가 극에 달하는 자리. ' +
      '두 개의 午가 겹치면 열기가 과도하여 스스로를 소진시킨다.',
    health:
      '심장·심혈관·혈액 질환. 고혈압, 심근경색, 뇌졸중 등 열성 질환에 유의. ' +
      '과도한 흥분·스트레스로 인한 화병(火病), 불면증, 두통 등.',
    personality:
      '열정이 과도하여 번아웃(소진)에 빠지기 쉽다. 급하고 성미가 불같으며, ' +
      '한번 달아오르면 스스로 멈추지 못한다. 충동적 행동이 자신에게 해가 된다.',
    relationship:
      '과도한 열정이 상대를 지치게 하거나, 자기 소진으로 인해 ' +
      '관계를 유지할 에너지가 남지 않는다. 감정 기복이 심하여 주변이 불안해한다.',
  },
  {
    branch: 'YU',
    hanja: '酉',
    nature:
      '유금(酉金) 자형 — 지나친 완벽주의가 자신을 자르는 기운. 예리함이 역방향으로 작용. ' +
      '酉는 금(金)의 왕지로 순수한 금기가 응축된 자리. ' +
      '두 개의 酉가 겹치면 날카로움이 과도하여 자기 자신을 상처 입힌다.',
    health:
      '폐·대장·피부·이빨 관련 질환. 호흡기 질환, 피부 알러지, 자해 충동에 유의. ' +
      '금(金)의 과다로 기관지, 편도선, 치과 질환이 올 수 있다.',
    personality:
      '완벽주의가 극에 달하여 자기 비판이 끊이지 않는다. 타인에게도 날카롭지만 ' +
      '가장 날카로운 칼날은 자기 자신을 향한다. 예민하고 신경질적이며, ' +
      '작은 실수도 용납하지 못하여 스스로를 괴롭힌다.',
    relationship:
      '타인에게 비판적이고 까다로워 친밀한 관계를 유지하기 어렵다. ' +
      '자기 자신도 힘들지만 주변 사람도 지치게 만든다. ' +
      '고독해지기 쉬우며, 특히 일주에 酉가 중복되면 부부 관계에 냉기가 흐른다.',
  },
  {
    branch: 'HAE',
    hanja: '亥',
    nature:
      '해수(亥水) 자형 — 넘치는 감성·욕망이 자신을 잠기게 하는 기운. 방종·감정 과잉과 연관. ' +
      '亥는 수(水)의 시작이자 만물이 귀장(歸藏)하는 자리. ' +
      '두 개의 亥가 겹치면 감정·욕망의 물결이 넘쳐 스스로 빠져든다.',
    health:
      '신장(腎臟)·방광·비뇨기 질환, 수분 대사 이상. 부종, 방광염, 전립선 질환에 유의. ' +
      '정신적으로는 우울증, 감정 조절 장애, 중독(알코올·도박 등)의 위험.',
    personality:
      '감성이 지나치게 풍부하여 현실과 환상의 경계가 흐려진다. ' +
      '욕망의 제어가 어렵고, 한번 빠져들면 헤어나오기 힘든 중독적 성향. ' +
      '자유로움을 추구하지만 그 자유가 방종으로 전락하기 쉽다.',
    relationship:
      '감정적 의존이 심하여 상대방에게 부담을 준다. ' +
      '이상적인 관계를 꿈꾸지만 현실의 관계에 만족하지 못해 방황한다. ' +
      '특히 시주에 亥가 중복되면 말년의 외로움, 자녀와의 소원함이 우려된다.',
  },
];

// ---------------------------------------------------------------------------
// 형의 길흉 작용 원칙
// ---------------------------------------------------------------------------

/**
 * 형(刑) 작용 원칙
 *
 * 형은 충(沖)에 비해 느리지만 더 오래 지속되는 변동을 일으킨다.
 * 길흉 판단은 형에 관여된 십신(十神)과 격국(格局)의 관계에 따라 달라진다.
 */
export const HYEONG_PRINCIPLES: {
  general: string;
  strengthOrder: string;
  gilhyung: Array<{ situation: string; judgment: string }>;
} = {
  general:
    '형(刑)은 두 지지 또는 세 지지가 상호 충돌·마찰하는 관계로, ' +
    '충(沖)보다 서서히 나타나지만 변화의 파급력이 크다. ' +
    '원국(原局)에 형이 있으면 평생 그 기운의 영향이 지속되며, ' +
    '운(運)에서 형이 발동하면 해당 기간에 집중적으로 그 영향이 나타난다. ' +
    '형은 "벌(罰)"의 의미가 있어, 법률·규범·제도와 관련된 문제로 표출되기 쉽다.',

  strengthOrder:
    '형살(刑殺)의 강도는 삼형 전체(三刑全) > 반삼형(半三刑) > 이형(二刑) > 자형(自刑) 순이다. ' +
    '삼형 내부에서는 무은지형(寅巳申) >= 지세지형(丑戌未)이며, ' +
    '이형인 무례지형(子卯)은 삼형보다 약하다. ' +
    '자형(自刑)은 외부 충돌이 아닌 내부 갈등이므로 작용이 가장 미약하다. ' +
    '단, 형과 충이 겹치는 경우(예: 寅申, 丑未)에는 작용력이 크게 증폭된다.',

  gilhyung: [
    {
      situation: '기신(忌神) 지지가 형을 받는 경우',
      judgment:  '기신이 형으로 억제되어 사주가 균형을 찾는다 → 길(吉)',
    },
    {
      situation: '용신(用神) 지지가 형을 받는 경우',
      judgment:  '용신의 기운이 손상되어 격국이 흔들린다 → 흉(凶)',
    },
    {
      situation: '관성(官星)이 형을 받는 경우',
      judgment:  '관재(官災)·법률문제·직장 변동의 위험이 있다 → 흉(凶)',
    },
    {
      situation: '인성(印星)이 형을 받는 경우',
      judgment:  '어머니·문서 관련 문제, 학업 손상 → 흉(凶)',
    },
    {
      situation: '재성(財星)이 형을 받는 경우',
      judgment:  '재물 손실·배우자와의 마찰 → 흉(凶)',
    },
    {
      situation: '식상(食傷)이 형을 받는 경우',
      judgment:  '자녀 문제, 표현력 저하, 식신이면 건강 악화, 상관이면 구설·소송 → 흉(凶)',
    },
    {
      situation: '비겁(比劫)이 형을 받는 경우',
      judgment:  '형제·동료와의 갈등, 경쟁에서의 손해 → 흉(凶). 단 비겁이 기신이면 길(吉)',
    },
  ],
};

// ---------------------------------------------------------------------------
// 형의 해소 조건(解消條件)
// ---------------------------------------------------------------------------

/**
 * 형(刑)의 해소 조건
 *
 * 형이 성립하더라도 특정 조건에 의해 형의 작용이 약화되거나 해소될 수 있다.
 */
export const HYEONG_RESOLUTION: {
  general: string;
  conditions: Array<{ condition: string; explanation: string }>;
} = {
  general:
    '형(刑)은 합(合)에 의해 해소(解消)되거나 약화될 수 있다. ' +
    '형에 관여된 지지 중 하나가 다른 지지와 합(육합·삼합·방합)을 이루면, ' +
    '합의 기운이 형의 충돌을 완화시킨다. 이를 합해형(合解刑)이라 한다. ' +
    '단, 합의 강도가 형의 강도보다 커야 완전히 해소되며, ' +
    '합이 약하면 형이 완전히 풀리지 않고 반감되는 데 그친다.',

  conditions: [
    {
      condition: '육합(六合)에 의한 해소',
      explanation:
        '형에 관여된 지지가 사주 내 다른 지지와 육합을 이루면 형이 약화된다. ' +
        '예: 寅巳申 삼형에서 寅이 亥와 육합(寅亥合木)하면 寅의 형 작용이 약화된다. ' +
        '子卯 이형에서 子가 丑과 육합(子丑合土)하면 자묘형의 무례한 기운이 눌린다. ' +
        '단, 육합이 성립하려면 합하는 두 지지가 서로 인접(年月, 月日, 日時)해야 효과가 크다.',
    },
    {
      condition: '삼합(三合)에 의한 해소',
      explanation:
        '형 지지가 삼합국(三合局)에 포함되면 삼합의 합력이 형을 누른다. ' +
        '삼합은 에너지의 방향을 하나로 모아주므로 형의 마찰을 상쇄한다. ' +
        '예: 丑戌未 지세지형에서 丑이 巳酉와 함께 巳酉丑 금국(金局)을 이루면 ' +
        '丑의 형 작용이 삼합에 흡수되어 약화된다.',
    },
    {
      condition: '방합(方合)에 의한 해소',
      explanation:
        '같은 방위의 세 지지가 모두 있으면 방합의 결속력이 형을 완화한다. ' +
        '방합은 삼합보다 단순한 구조이므로 해소력은 삼합보다 약하다.',
    },
    {
      condition: '공망(空亡)에 의한 약화',
      explanation:
        '형 지지가 공망(空亡)에 해당하면 그 지지의 기운이 약해져 형의 작용도 약화된다. ' +
        '공망은 지지의 에너지를 비우므로 형의 충돌 에너지도 줄어든다.',
    },
    {
      condition: '형 지지의 원진(原嗔) 및 통근(通根) 상태',
      explanation:
        '형 지지가 천간에 통근(通根)하지 않으면 형의 발현력이 약하다. ' +
        '천간에 해당 오행이 투출(透出)되어 있어야 형의 영향이 현실에서 크게 나타난다.',
    },
  ],
};

// ---------------------------------------------------------------------------
// 형의 주(柱) 위치별 해석
// ---------------------------------------------------------------------------

/**
 * 형이 사주 어느 주(柱)에 위치하느냐에 따른 영향 차이
 */
export const HYEONG_BY_POSITION: Array<{
  position: string;
  interpretation: string;
}> = [
  {
    position: '년주(年柱)와 월주(月柱) 사이',
    interpretation:
      '어린 시절, 가정환경, 부모와의 관계에서 형의 기운이 작용한다. ' +
      '부모 간 불화, 가정의 변동, 어린 시절 고생 등과 연관.',
  },
  {
    position: '월주(月柱)와 일주(日柱) 사이',
    interpretation:
      '청년기~중년기, 사회생활, 형제·동료 관계에서 형이 작용한다. ' +
      '직장 내 갈등, 사업상 마찰, 관재·소송 등과 연관.',
  },
  {
    position: '일주(日柱)와 시주(時柱) 사이',
    interpretation:
      '중년기~말년, 배우자·자녀 관계에서 형이 작용한다. ' +
      '부부 불화, 자녀 문제, 말년의 건강 악화 등과 연관.',
  },
  {
    position: '원국(原局)과 대운(大運)·세운(歲運)',
    interpretation:
      '원국에 형의 요소가 잠재되어 있다가 대운·세운에서 나머지 지지가 들어오면 발동한다. ' +
      '예: 원국에 寅巳가 있고 대운에서 申이 오면 무은지형 삼형이 완성되어 큰 변동이 온다.',
  },
];

// ---------------------------------------------------------------------------
// 유틸리티 함수
// ---------------------------------------------------------------------------

/**
 * 두 지지 이름이 이형(二刑) 또는 삼형(三刑) 관계인지 확인한다
 *
 * 삼형의 경우 두 지지만 있어도 반형(半刑)으로 true를 반환한다.
 *
 * @param a - 첫 번째 지지 로마자
 * @param b - 두 번째 지지 로마자
 * @returns 형 관계이면 true
 *
 * @example
 * isHyeong('IN', 'SA')   // true  — 인사 반삼형
 * isHyeong('JA', 'MYO')  // true  — 자묘 무례지형
 * isHyeong('JA', 'IN')   // false — 형 관계 아님
 */
export function isHyeong(a: BranchName, b: BranchName): boolean {
  // 이형 확인
  for (const pair of IHYEONG_PAIRS) {
    const [x, y] = pair.branches;
    if ((x === a && y === b) || (x === b && y === a)) return true;
  }
  // 삼형 반형 확인 (두 지지가 같은 삼형 그룹에 속하면 반형)
  for (const group of SAMHYEONG_GROUPS) {
    const bs = group.branches as BranchName[];
    if (bs.includes(a) && bs.includes(b) && a !== b) return true;
  }
  return false;
}

/**
 * 자형(自刑) 지지인지 확인한다
 *
 * @param branch - 지지 로마자
 * @returns 자형 지지이면 true
 */
export function isJahyeong(branch: BranchName): boolean {
  return JAHYEONG_BRANCHES.some(j => j.branch === branch);
}

/**
 * 두 지지 사이의 형(刑) 종류를 반환한다
 *
 * @param a - 첫 번째 지지 로마자
 * @param b - 두 번째 지지 로마자
 * @returns 형의 종류. 형 관계가 아니면 null
 *
 * @example
 * getHyeongType('IN', 'SA')   // 'BAN_SAMHYEONG'
 * getHyeongType('JA', 'MYO')  // 'IHYEONG'
 * getHyeongType('JIN', 'JIN') // 'JAHYEONG'
 * getHyeongType('JA', 'IN')   // null
 */
export function getHyeongType(a: BranchName, b: BranchName): HyeongType | null {
  // 자형 확인 (같은 지지)
  if (a === b && isJahyeong(a)) return 'JAHYEONG';

  // 이형 확인
  for (const pair of IHYEONG_PAIRS) {
    const [x, y] = pair.branches;
    if ((x === a && y === b) || (x === b && y === a)) return 'IHYEONG';
  }

  // 삼형 반형 확인
  for (const group of SAMHYEONG_GROUPS) {
    const bs = group.branches as BranchName[];
    if (bs.includes(a) && bs.includes(b) && a !== b) return 'BAN_SAMHYEONG';
  }

  return null;
}

/**
 * 세 지지가 삼형(三刑)을 완전히 이루는지 확인한다
 *
 * @param a - 첫 번째 지지 로마자
 * @param b - 두 번째 지지 로마자
 * @param c - 세 번째 지지 로마자
 * @returns 삼형이면 해당 SamhyeongGroup, 아니면 null
 *
 * @example
 * checkSamhyeong('IN', 'SA', 'SHIN')    // SamhyeongGroup (무은지형)
 * checkSamhyeong('CHUK', 'MI', 'SUL')   // SamhyeongGroup (지세지형)
 * checkSamhyeong('IN', 'SA', 'JA')      // null
 */
export function checkSamhyeong(
  a: BranchName,
  b: BranchName,
  c: BranchName,
): SamhyeongGroup | null {
  const input = new Set([a, b, c]);
  if (input.size !== 3) return null;

  for (const group of SAMHYEONG_GROUPS) {
    const groupSet = new Set(group.branches);
    if (input.size === groupSet.size && [...input].every(x => groupSet.has(x))) {
      return group;
    }
  }
  return null;
}

/**
 * 주어진 지지의 형(刑) 상대 지지 목록을 반환한다
 *
 * @param branch - 지지 로마자
 * @returns 형 관계에 있는 지지 배열 (이형, 반삼형 포함). 자형은 포함하지 않는다.
 *
 * @example
 * getHyeongPartners('IN')   // ['SA', 'SHIN']
 * getHyeongPartners('JA')   // ['MYO']
 * getHyeongPartners('SUL')  // ['CHUK', 'MI']
 */
export function getHyeongPartners(branch: BranchName): BranchName[] {
  const partners: BranchName[] = [];

  // 이형 파트너
  for (const pair of IHYEONG_PAIRS) {
    const [x, y] = pair.branches;
    if (x === branch) partners.push(y);
    else if (y === branch) partners.push(x);
  }

  // 삼형 그룹 내 파트너
  for (const group of SAMHYEONG_GROUPS) {
    const bs = group.branches;
    if (bs.includes(branch)) {
      for (const b of bs) {
        if (b !== branch && !partners.includes(b)) partners.push(b);
      }
    }
  }

  return partners;
}
