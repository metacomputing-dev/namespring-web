/**
 * 지지형론(地支刑論) — 지지 삼형(三刑)·이형(二刑)·자형(自刑) 이론
 *
 * 형(刑)이란 두 지지 또는 세 지지가 서로 충돌하여
 * 형벌·재해·변화의 기운을 발생시키는 관계이다.
 *
 * 분류:
 * - 삼형(三刑): 세 지지가 형하는 관계
 *   - 인사신 무은지형(寅巳申 無恩之刑): 은혜를 모르는 형
 *   - 축술미 지세지형(丑戌未 持勢之刑): 세력을 믿는 형
 * - 이형(二刑): 두 지지의 형
 *   - 자묘 무례지형(子卯 無禮之刑): 예의 없는 형
 * - 자형(自刑): 같은 지지끼리의 형
 *   - 진진·오오·유유·해해 (辰辰·午午·酉酉·亥亥)
 */

import type { BranchIdx } from '../core/cycle.js';

// ---------------------------------------------------------------------------
// 지지 이름 타입 (jiji.ts 와 동일한 표기)
// ---------------------------------------------------------------------------

export type BranchName =
  | 'JA' | 'CHUK' | 'IN' | 'MYO' | 'JIN' | 'SA'
  | 'O' | 'MI' | 'SHIN' | 'YU' | 'SUL' | 'HAE';

export const BRANCH_NAME_TO_IDX: Record<BranchName, BranchIdx> = {
  JA: 0, CHUK: 1, IN: 2, MYO: 3, JIN: 4, SA: 5,
  O: 6, MI: 7, SHIN: 8, YU: 9, SUL: 10, HAE: 11,
} as const;

// ---------------------------------------------------------------------------
// 삼형(三刑)
// ---------------------------------------------------------------------------

/**
 * 삼형(三刑) 그룹 인터페이스
 */
export interface SamhyeongGroup {
  /** 세 지지 로마자 */
  branches: [BranchName, BranchName, BranchName];
  /** 형의 명칭 */
  name: string;
  /** 형의 성질 설명 */
  nature: string;
  /** 형의 작용 — 사주에서의 영향 */
  effect: string;
}

/**
 * 삼형(三刑) 그룹 목록
 *
 * 삼형은 세 지지가 서로 형(刑)의 관계를 맺어 강한 변동·재해를 일으키는 구조다.
 */
export const SAMHYEONG_GROUPS: SamhyeongGroup[] = [
  {
    branches: ['IN', 'SA', 'SHIN'],     // 寅巳申
    name:     '인사신 무은지형(寅巳申 無恩之刑)',
    nature:   '은혜를 모르는 형. 인목(寅)·사화(巳)·신금(申)이 각각 서로를 형한다. ' +
              '목극토(木剋土), 화극금(火剋金), 금극목(金剋木)의 삼각 극 관계가 형으로 발현된다.',
    effect:   '형법·관재(官災)·수술·교통사고·배은망덕 등의 사건과 연관. ' +
              '세 지지가 모두 있을 때 형의 작용이 가장 강하고, 두 지지만 있어도 반형(半刑)으로 작용한다.',
  },
  {
    branches: ['CHUK', 'SUL', 'MI'],    // 丑戌未
    name:     '축술미 지세지형(丑戌未 持勢之刑)',
    nature:   '세력을 믿는 형. 축토(丑)·술토(戌)·미토(未)는 모두 토(土) 오행이지만 ' +
              '서로 세력 다툼으로 형을 이룬다. 토(土)끼리의 충돌이므로 완고·고집·다툼의 성질이 있다.',
    effect:   '관재(官災)·구설·고집으로 인한 손실·신체 비장·위장 질환과 연관. ' +
              '세 지지가 모두 있을 때 형의 작용이 최대로 발현된다.',
  },
];

// ---------------------------------------------------------------------------
// 이형(二刑)
// ---------------------------------------------------------------------------

/**
 * 이형(二刑) 항목 인터페이스
 */
export interface Ihyeong {
  /** 두 지지 로마자 */
  branches: [BranchName, BranchName];
  /** 형의 명칭 */
  name: string;
  /** 형의 성질 */
  nature: string;
  /** 형의 작용 */
  effect: string;
}

/**
 * 이형(二刑) 목록
 *
 * 두 지지가 서로 형(刑)의 관계를 맺는다.
 */
export const IHYEONG_PAIRS: Ihyeong[] = [
  {
    branches: ['JA', 'MYO'],            // 子卯
    name:     '자묘 무례지형(子卯 無禮之刑)',
    nature:   '예의 없는 형. 자수(子水)와 묘목(卯木)은 수생목(水生木)의 상생 관계이지만 ' +
              '형(刑)을 이루어 예의와 예절을 모르는 형으로 불린다. ' +
              '관계에서 무례함, 법도를 어기는 일, 성적(性的) 문란과 연관되기도 한다.',
    effect:   '관재·색정(色情)·방종·무례로 인한 화(禍)·신체 신장·방광 문제와 연관.',
  },
];

// ---------------------------------------------------------------------------
// 자형(自刑)
// ---------------------------------------------------------------------------

/**
 * 자형(自刑) 항목 인터페이스
 *
 * 동일한 지지가 두 개 이상 있을 때 스스로를 형하는 관계.
 */
export interface Jahyeong {
  /** 자형하는 지지 */
  branch: BranchName;
  /** 한자 */
  hanja: string;
  /** 자형의 성질 설명 */
  nature: string;
}

/**
 * 자형(自刑) 목록
 *
 * 진·오·유·해(辰·午·酉·亥) 지지가 사주에 같은 지지가 두 개 이상 있으면 자형이 성립한다.
 */
export const JAHYEONG_BRANCHES: Jahyeong[] = [
  { branch: 'JIN',  hanja: '辰', nature: '진토(辰土) 자형 — 자기 스스로를 해치는 기운. 강박·집착·과욕과 연관.' },
  { branch: 'O',    hanja: '午', nature: '오화(午火) 자형 — 과도한 열정이 자신을 태우는 기운. 급화·흥분·심장 문제와 연관.' },
  { branch: 'YU',   hanja: '酉', nature: '유금(酉金) 자형 — 지나친 완벽주의가 자신을 자르는 기운. 예리함이 역방향으로 작용.' },
  { branch: 'HAE',  hanja: '亥', nature: '해수(亥水) 자형 — 넘치는 감성·욕망이 자신을 잠기게 하는 기운. 방종·감정 과잉과 연관.' },
];

// ---------------------------------------------------------------------------
// 형의 길흉 작용 원칙
// ---------------------------------------------------------------------------

/**
 * 형(刑) 작용 원칙
 *
 * 형은 충(沖)에 비해 느리지만 더 오래 지속되는 변동을 일으킨다.
 * 길흉 판단은 형에 관여된 십신(十神)과 격국(格局)의 관계에 따라 달라진다.
 */
export const HYEONG_PRINCIPLES: {
  general: string;
  gilhyung: Array<{ situation: string; judgment: string }>;
} = {
  general:
    '형(刑)은 두 지지 또는 세 지지가 상호 충돌·마찰하는 관계로, ' +
    '충(沖)보다 서서히 나타나지만 변화의 파급력이 크다. ' +
    '원국(原局)에 형이 있으면 평생 그 기운의 영향이 지속되며, ' +
    '운(運)에서 형이 발동하면 해당 기간에 집중적으로 그 영향이 나타난다.',

  gilhyung: [
    {
      situation: '기신(忌神) 지지가 형을 받는 경우',
      judgment:  '기신이 형으로 억제되어 사주가 균형을 찾는다 → 길(吉)',
    },
    {
      situation: '용신(用神) 지지가 형을 받는 경우',
      judgment:  '용신의 기운이 손상되어 격국이 흔들린다 → 흉(凶)',
    },
    {
      situation: '관성(官星)이 형을 받는 경우',
      judgment:  '관재(官災)·법률문제·직장 변동의 위험이 있다 → 흉(凶)',
    },
    {
      situation: '인성(印星)이 형을 받는 경우',
      judgment:  '어머니·문서 관련 문제, 학업 손상 → 흉(凶)',
    },
    {
      situation: '재성(財星)이 형을 받는 경우',
      judgment:  '재물 손실·배우자와의 마찰 → 흉(凶)',
    },
  ],
};

// ---------------------------------------------------------------------------
// 유틸리티 함수
// ---------------------------------------------------------------------------

/**
 * 두 지지 이름이 이형(二刑) 또는 삼형(三刑) 관계인지 확인한다
 *
 * 삼형의 경우 두 지지만 있어도 반형(半刑)으로 true를 반환한다.
 *
 * @param a - 첫 번째 지지 로마자
 * @param b - 두 번째 지지 로마자
 * @returns 형 관계이면 true
 *
 * @example
 * isHyeong('IN', 'SA')   // true  — 인사 반삼형
 * isHyeong('JA', 'MYO')  // true  — 자묘 무례지형
 * isHyeong('JA', 'IN')   // false — 형 관계 아님
 */
export function isHyeong(a: BranchName, b: BranchName): boolean {
  // 이형 확인
  for (const pair of IHYEONG_PAIRS) {
    const [x, y] = pair.branches;
    if ((x === a && y === b) || (x === b && y === a)) return true;
  }
  // 삼형 반형 확인 (두 지지가 같은 삼형 그룹에 속하면 반형)
  for (const group of SAMHYEONG_GROUPS) {
    const bs = group.branches as BranchName[];
    if (bs.includes(a) && bs.includes(b) && a !== b) return true;
  }
  return false;
}

/**
 * 자형(自刑) 지지인지 확인한다
 *
 * @param branch - 지지 로마자
 * @returns 자형 지지이면 true
 */
export function isJahyeong(branch: BranchName): boolean {
  return JAHYEONG_BRANCHES.some(j => j.branch === branch);
}
