/**
 * 지지해론(地支害論) — 지지 육해(六害) 이론
 *
 * 해(害)란 두 지지가 서로 방해하거나 상처를 주는 관계로,
 * 육합(六合)을 파괴하는 기운에서 발생한다.
 *
 * 육해(六害)의 원인: 육합(六合)을 충(沖)이 깨뜨리는 원리
 * -------------------------------------------------------
 * 육합은 두 지지가 친밀하게 합하는 관계다. 그런데 합하는 상대방의 충(沖) 지지가
 * 끼어들면, 합이 깨지면서 해(害) — 즉 "방해·상처"의 관계가 성립한다.
 *
 * 도출 과정:
 *   子+丑 합(合) → 丑의 충(沖)은 未 → 子未害 / 子의 충(沖)은 午 → 丑午害
 *   寅+亥 합(合) → 亥의 충(沖)은 巳 → 寅巳害 / 寅의 충(沖)은 申 → 申亥害
 *   卯+戌 합(合) → 戌의 충(沖)은 辰 → 卯辰害 / 卯의 충(沖)은 酉 → 酉戌害
 *   辰+酉 합(合) → (酉의 충은 卯 → 辰이 卯를 해하지 않고 卯辰害로 이미 수록)
 *   巳+申 합(合) → (巳의 충은 亥 → 申亥害로 이미 수록)
 *   午+未 합(合) → (午의 충은 子 → 子未害로 이미 수록)
 *
 * 결과 육해(六害) 6쌍:
 *   子未(자미)·丑午(축오)·寅巳(인사)·卯辰(묘진)·申亥(신해)·酉戌(유술)
 */

// ---------------------------------------------------------------------------
// 지지 이름 타입
// ---------------------------------------------------------------------------

export type BranchName =
  | 'JA' | 'CHUK' | 'IN' | 'MYO' | 'JIN' | 'SA'
  | 'O' | 'MI' | 'SHIN' | 'YU' | 'SUL' | 'HAE';

// ---------------------------------------------------------------------------
// 해(害)의 영향 강도
// ---------------------------------------------------------------------------

/**
 * 해(害)의 영향 강도를 나타내는 등급.
 * 해의 강도는 관여된 오행의 극(剋) 관계 유무와 깨뜨리는 합의 종류에 따라 달라진다.
 *
 * - STRONG: 극(剋) 관계가 내재되어 있어 상처가 깊은 경우
 * - MODERATE: 상생 관계이지만 합을 깨뜨리는 원한이 강한 경우
 * - MILD: 상생 관계이고 직접적 극이 적은 경우
 */
export type HaeStrength = 'STRONG' | 'MODERATE' | 'MILD';

// ---------------------------------------------------------------------------
// 육해(六害) 목록
// ---------------------------------------------------------------------------

/**
 * 지지해(地支害) 단일 항목 인터페이스
 */
export interface JijiHae {
  /** 두 지지 로마자 */
  branches: [BranchName, BranchName];
  /** 해의 명칭 */
  name: string;
  /** 해의 원리 — 어떤 합을 방해하는가 */
  origin: string;
  /** 해의 성질 */
  nature: string;
  /** 해의 주요 작용 */
  effect: string;
  /** 영향 강도 */
  strength: HaeStrength;
  /** 건강 영향 */
  health: string;
  /** 성격·심리 영향 */
  psychology: string;
  /** 관계·사회적 영향 */
  relationship: string;
}

/**
 * 육해(六害) 목록
 *
 * 해(害)의 구조: 두 지지가 각각 육합하는 상대방이 서로 충(沖) 관계일 때 해가 성립한다.
 * 예) 子丑합, 子의 충은 午 → 丑午해 성립 / 丑의 충은 未 → 子未해 성립
 */
export const YUKHAE_PAIRS: JijiHae[] = [
  {
    branches: ['JA', 'MI'],             // 子未害
    name:     '자미해(子未害)',
    origin:
      '子는 丑과 육합(合土)하는데, 丑의 충(沖)은 未다. 따라서 未가 子丑合을 방해하여 子未害 성립. ' +
      '또한 午는 未와 육합(合土)하는데, 午의 충(沖)은 子다. 따라서 子가 午未合을 방해하여 子未害가 된다. ' +
      '양방향에서 서로의 합을 깨뜨리는 관계이므로 원한이 깊다.',
    nature:
      '수(水)와 토(土)의 해. 토극수(土剋水)의 극 관계가 내재되어 있다. ' +
      '子(水왕지)와 未(여름 조토)의 만남으로, 물이 마른 땅에 스며들어 흔적 없이 사라지는 형상. ' +
      '조용히, 서서히 힘이 빠지는 특성이 있다.',
    effect:
      '고독감·배신당함·마음의 상처와 연관. 특히 감정적 배신, ' +
      '신뢰의 상실, 음식·음독 관련 사건과 연관되기도 한다. ' +
      '子는 지혜의 지지, 未는 감성의 지지로 이성과 감성의 충돌을 나타낸다.',
    strength: 'STRONG',
    health:
      '신장(子-水)·비장·위장(未-土) 질환. 토극수의 작용으로 ' +
      '신장 기능 저하, 소화불량, 당뇨(수분 대사 이상)에 유의. ' +
      '음식물 중독, 약물 부작용 등과도 연관.',
    psychology:
      '외로움, 고독감이 깊어지는 심리. 주위에 사람이 있어도 ' +
      '마음이 통하지 않는다는 느낌. 감정을 숨기고 혼자 앓는 성향. ' +
      '이성적으로 판단해야 할 때 감정에 끌리고, 감정을 따라야 할 때 이성이 방해하는 갈등.',
    relationship:
      '가까운 사람에게 배신당하는 형상. 특히 子가 도화(桃花)이므로 ' +
      '이성 관계에서의 배신·실망과 연관이 깊다. ' +
      '년주·월주에 있으면 부모·형제에게 상처를 받고, ' +
      '일주·시주에 있으면 배우자·자녀에게 실망하는 일이 있다.',
  },
  {
    branches: ['CHUK', 'O'],            // 丑午害
    name:     '축오해(丑午害)',
    origin:
      '午는 未와 육합(合土)하는데, 未의 충(沖)은 丑이다. 따라서 丑이 午未合을 방해하여 丑午害 성립. ' +
      '子는 丑과 육합(合土)하는데, 子의 충(沖)은 午다. 따라서 午가 子丑合을 방해하여 丑午害가 된다.',
    nature:
      '토(土)와 화(火)의 해. 丑의 차가운 습토(濕土)가 午의 열기를 억누른다. ' +
      '화생토(火生土) 상생 관계이지만, 午의 화기(火氣)가 丑의 습기에 꺼지는 형상. ' +
      '열정이 현실에 부딪혀 좌절하는 모습.',
    effect:
      '배우자와의 갈등·재물 손실과 연관. 특히 午(화, 열정)가 丑(토, 현실)에 ' +
      '좌절하는 형상으로, 이상과 현실의 괴리에서 오는 고통을 나타낸다. ' +
      '관료·공무원 사회에서의 좌천·불이익과도 연관.',
    strength: 'MODERATE',
    health:
      '심장·소장(午-火)과 비장·위장(丑-土) 질환. 습토가 화기를 억누르므로 ' +
      '심장 기능 저하, 소화불량, 심인성 위장병에 유의. ' +
      '냉증(冷症), 수족냉증, 혈액 순환 장애 등.',
    psychology:
      '열정과 의욕이 갑자기 꺾이는 좌절감. 뜻을 펼치려 하지만 ' +
      '현실적 장벽에 부딪혀 무기력해지는 패턴. ' +
      '자존심과 인내심의 충돌로 내면적 갈등이 크다.',
    relationship:
      '부부 관계에서 한쪽의 열정을 다른 쪽이 꺾는 형상. ' +
      '午가 일주에 있고 丑이 시주에 있으면 말년에 배우자와의 갈등이 심화. ' +
      '월주와 일주에 있으면 직장에서 능력을 발휘하지 못하는 좌절.',
  },
  {
    branches: ['IN', 'SA'],             // 寅巳害
    name:     '인사해(寅巳害)',
    origin:
      '寅은 亥와 육합(合木)하는데, 亥의 충(沖)은 巳다. 따라서 巳가 寅亥合을 방해하여 寅巳害 성립. ' +
      '巳는 申과 육합(合水)하는데, 申의 충(沖)은 寅이다. 따라서 寅이 巳申合을 방해하여 寅巳害가 된다.',
    nature:
      '목(木)과 화(火)의 해. 목생화(木生火) 상생 관계이지만 해를 이룬다. ' +
      '은인이 원수가 되는 형상. 寅(木)이 巳(火)를 생하지만, ' +
      '巳의 지장간에 庚금이 있어 寅의 甲목을 극한다. ' +
      '도움을 주었더니 오히려 해를 입는 배은(背恩)의 구조.',
    effect:
      '믿었던 사람에게 배신당함·형제간 다툼과 연관. ' +
      '인사(寅巳)는 무은지형(寅巳申 無恩之刑)의 반삼형이기도 하여 ' +
      '해와 형이 이중으로 작용하면 배은·관재의 기운이 매우 강해진다.',
    strength: 'STRONG',
    health:
      '간담(肝膽, 寅-木)·심장(巳-火) 질환. 목생화의 과도한 작용으로 ' +
      '간 기능 저하 → 심화(心火) 상승의 연쇄 반응. ' +
      '고혈압, 두통, 안구 질환, 간염 등에 유의.',
    psychology:
      '선의가 악의로 돌아오는 경험이 반복되어 사람에 대한 불신이 생긴다. ' +
      '처음에는 적극적으로 도우려 하지만, 배신을 경험하면 ' +
      '방어적이고 닫힌 성격으로 변하기 쉽다.',
    relationship:
      '은인-수혜자 관계, 스승-제자 관계, 선배-후배 관계에서 ' +
      '배신이 일어나는 형상. 도움을 줬는데 되려 뒷담화를 듣거나 소송을 당하는 일. ' +
      '형제자매 간에도 은혜를 모르는 갈등이 생기기 쉽다.',
  },
  {
    branches: ['MYO', 'JIN'],           // 卯辰害
    name:     '묘진해(卯辰害)',
    origin:
      '卯는 戌과 육합(合火)하는데, 戌의 충(沖)은 辰이다. 따라서 辰이 卯戌合을 방해하여 卯辰害 성립. ' +
      '辰은 酉와 육합(合金)하는데, 酉의 충(沖)은 卯다. 따라서 卯가 辰酉合을 방해하여 卯辰害가 된다.',
    nature:
      '목(木)과 토(土)의 해. 목극토(木剋土)의 극 관계. ' +
      '이웃한 지지(인덱스 3과 4)가 해를 이루는 독특한 구조. ' +
      '卯(봄의 왕목)가 辰(봄의 습토)을 극하는 형상으로, ' +
      '가까운 이웃이 서로 상처를 주는 모습이다.',
    effect:
      '이웃·형제와의 갈등·작은 손해의 지속과 연관. ' +
      '큰 사건보다는 소소한 마찰, 잔소리, 작은 다툼이 끊이지 않는 형상. ' +
      '피해가 치명적이지는 않지만 지속되어 정신적으로 지치게 만든다.',
    strength: 'MILD',
    health:
      '간담(卯-木)·위장·비장(辰-土) 질환. 목극토의 작용으로 ' +
      '위장 기능 저하, 소화불량, 식욕 감퇴에 유의. ' +
      '만성적이고 경미한 증상이 오래 지속되는 패턴.',
    psychology:
      '가까운 사이에서 오는 소소한 스트레스가 쌓이는 심리. ' +
      '큰 갈등은 아니지만 일상적인 잔소리, 간섭이 쌓여 ' +
      '만성 피로와 무기력감을 유발한다.',
    relationship:
      '이웃·직장 동료·형제 등 매일 마주치는 가까운 관계에서의 마찰. ' +
      '피하고 싶지만 피할 수 없는 관계에서 오는 스트레스. ' +
      '같은 공간에 있는 사람과의 갈등이 특징이다.',
  },
  {
    branches: ['SHIN', 'HAE'],          // 申亥害
    name:     '신해해(申亥害)',
    origin:
      '亥는 寅과 육합(合木)하는데, 寅의 충(沖)은 申이다. 따라서 申이 寅亥合을 방해하여 申亥害 성립. ' +
      '申은 巳와 육합(合水)하는데, 巳의 충(沖)은 亥다. 따라서 亥가 巳申合을 방해하여 申亥害가 된다.',
    nature:
      '금(金)과 수(水)의 해. 금생수(金生水)의 상생 관계이지만 해를 이룬다. ' +
      '申(金생지)이 亥(水생지)를 생하는 관계로, 생지끼리의 해(害)다. ' +
      '새로운 시작의 에너지끼리 부딪혀 출발부터 삐걱거리는 형상.',
    effect:
      '관재(官災)·이동·여행 중 사고와 연관. 새로운 일을 시작하려 할 때 ' +
      '방해가 들어오는 형상. 출장·여행 중 사고, 이사 후 부적응, ' +
      '새 직장에서의 초기 갈등 등.',
    strength: 'MODERATE',
    health:
      '폐·대장(申-金)과 신장·방광(亥-水) 질환. 금생수의 과도한 작용으로 ' +
      '수분 대사 과다, 부종, 방광염, 비뇨기 질환에 유의. ' +
      '기관지·호흡기 질환, 감기에 잘 걸리는 체질과 연관.',
    psychology:
      '새로운 시작에 대한 불안감. 무언가를 시작하려 할 때마다 ' +
      '방해가 들어와 좌절하는 경험이 반복되면 도전 의지가 약해진다. ' +
      '이동·변화에 대한 저항감이 생기기 쉽다.',
    relationship:
      '새로운 관계를 맺으려 할 때 방해가 들어오는 형상. ' +
      '이직, 전학, 이사 등 새 환경에서 적응하기 어렵다. ' +
      '여행·이동 중 파트너와 다투는 일이 많다.',
  },
  {
    branches: ['YU', 'SUL'],            // 酉戌害
    name:     '유술해(酉戌害)',
    origin:
      '酉는 辰과 육합(合金)하는데, 辰의 충(沖)은 戌이다. 따라서 戌이 辰酉合을 방해하여 酉戌害 성립. ' +
      '戌은 卯와 육합(合火)하는데, 卯의 충(沖)은 酉다. 따라서 酉가 卯戌合을 방해하여 酉戌害가 된다.',
    nature:
      '금(金)과 토(土)의 해. 토생금(土生金) 상생 관계이지만 해를 이룬다. ' +
      '이웃한 지지(인덱스 9와 10)의 해로 卯辰害와 대칭적 구조. ' +
      '戌(조토)이 酉(금왕지)를 생하지만 酉가 그 생을 받아들이지 않는 형상. ' +
      '은혜를 주지만 인정받지 못하는 편.',
    effect:
      '배우자와의 갈등·사업 파트너와의 불화와 연관. ' +
      '酉는 도화(桃花)이므로 이성 관계에서의 상처와 연관되기도 한다. ' +
      '가까운 사이에서 뜻밖의 서운함, 인정받지 못하는 억울함.',
    strength: 'MODERATE',
    health:
      '폐·대장·피부(酉-金)과 위장·비장(戌-土) 질환. ' +
      '금의 예리함이 토의 둔중함에 갇히는 형상으로 ' +
      '변비, 치질, 피부 트러블, 호흡기 답답함에 유의.',
    psychology:
      '자신의 가치를 인정받지 못한다는 서운함. ' +
      '열심히 했는데 결과가 따르지 않는 허탈감. ' +
      '완벽주의적 성향이 주변의 무관심과 부딪혀 외로움을 느낀다.',
    relationship:
      '가까운 사이일수록 서로의 장점을 인정하지 못하는 관계. ' +
      '부부·사업 파트너 사이에서 소소한 서운함이 쌓이다 폭발하는 패턴. ' +
      '酉(도화)와 戌(화개살) 모두 예술·심미와 관련되어 ' +
      '창작·예술 분야에서 파트너와의 갈등으로 표출되기도 한다.',
  },
];

// ---------------------------------------------------------------------------
// 해(害) 이론 원칙
// ---------------------------------------------------------------------------

/**
 * 해(害) 이론 원칙
 */
export const HAE_PRINCIPLES: {
  definition: string;
  mechanism: string;
  strength: string;
  gilhyung: string;
  pairStrengthRanking: string;
  resolution: string;
} = {
  definition:
    '해(害)는 두 지지가 서로의 육합(六合)을 방해하는 관계에서 발생하는 ' +
    '상호 상처·방해의 기운이다. ' +
    '형(刑)·충(沖)과 달리 직접적 충돌보다는 간접적·지속적 방해로 손상을 일으킨다. ' +
    '해(害)의 한자 자체가 "해롭다"는 뜻이며, 서서히 스며드는 독과 같은 작용을 한다.',

  mechanism:
    '해(害)의 발생 원리: A와 B가 육합하는 관계일 때, A의 충(沖) 상대인 C가 B를 만나면 ' +
    'B와 C 사이에 해(害)가 형성된다. C가 A-B 합을 방해하기 때문이다. ' +
    '예를 들어 子와 丑이 육합(合土)하는데, 丑의 충(沖)인 未가 子를 만나면 ' +
    '子未害가 성립한다. 未가 子丑合을 방해하기 때문이다. ' +
    '이처럼 모든 육해는 육합을 충이 깨뜨리는 구조에서 도출된다.',

  strength:
    '충(沖) > 형(刑) > 파(破) > 해(害): 해는 네 가지 지지 관계 중 작용력이 가장 약하다. ' +
    '그러나 해당 십신의 기운을 서서히 약화시키며, 원국에 있으면 평생 그 영향이 지속된다. ' +
    '해는 급격한 변동보다는 만성적·잠재적 상처의 성격이 강하다.',

  gilhyung:
    '해는 일반적으로 흉(凶)으로 작용하지만 경우에 따라 중립적일 수 있다. ' +
    '기신(忌神) 지지가 해를 당하면 기신의 작용이 약화되어 오히려 길(吉)하게 작용하기도 한다. ' +
    '또한 불필요한 합(忌合)이 해에 의해 방해받으면 합이 풀려 길하게 작용할 수 있다.',

  pairStrengthRanking:
    '육해의 강도 비교: ' +
    '자미해(子未害) >= 인사해(寅巳害) > 축오해(丑午害) >= 유술해(酉戌害) >= 신해해(申亥害) > 묘진해(卯辰害). ' +
    '극(剋) 관계가 내재된 해(子未: 토극수, 寅巳: 지장간 극)가 가장 강하고, ' +
    '이웃 지지의 해(卯辰)는 작용이 상대적으로 약하다. ' +
    '형(刑)이 겹치는 해(寅巳: 무은지형 반형)는 해 단독보다 훨씬 강하게 작용한다.',

  resolution:
    '해(害)의 해소 조건: 해에 관여된 지지 중 하나가 ' +
    '다른 지지와 합(육합·삼합·방합)을 이루면 해의 작용이 약화된다. ' +
    '예: 子未害에서 子가 丑과 육합(子丑合)하면 해가 약화된다 — 원래의 합이 복구되기 때문이다. ' +
    '삼합이 완성되어 해 지지의 기운이 삼합에 흡수되면 해가 사실상 해소된다. ' +
    '공망(空亡) 지지가 해에 관여하면 해의 작용도 약해진다.',
};

// ---------------------------------------------------------------------------
// 해(害)의 주(柱) 위치별 해석
// ---------------------------------------------------------------------------

/**
 * 해가 사주 어느 주(柱)에 위치하느냐에 따른 영향 차이
 */
export const HAE_BY_POSITION: Array<{
  position: string;
  interpretation: string;
}> = [
  {
    position: '년주(年柱)와 월주(月柱) 사이',
    interpretation:
      '조상·부모와의 관계에서 상처. 어린 시절 정서적 상처, ' +
      '부모의 무관심 또는 과잉 기대로 인한 마음의 짐. ' +
      '가문·집안 내 해묵은 갈등의 영향을 받는다.',
  },
  {
    position: '월주(月柱)와 일주(日柱) 사이',
    interpretation:
      '사회생활·직장에서의 만성적 스트레스. 동료·상사와의 미묘한 갈등, ' +
      '능력을 인정받지 못하는 서운함, 형제·친구 관계의 소원함.',
  },
  {
    position: '일주(日柱)와 시주(時柱) 사이',
    interpretation:
      '배우자·자녀와의 정서적 거리감. 서로 사랑하지만 마음이 ' +
      '완전히 통하지 않는 느낌. 말년의 외로움, ' +
      '자녀와의 소통 부족 등과 연관.',
  },
  {
    position: '원국(原局)과 대운(大運)·세운(歲運)',
    interpretation:
      '원국에 해의 요소가 잠재되어 있다가 대운·세운에서 해 상대 지지가 ' +
      '들어오면 해가 발동한다. 해는 점진적으로 작용하므로 ' +
      '대운(10년)에서 해가 발동하면 해당 10년간 서서히 영향이 나타나며, ' +
      '세운(1년)에서 발동하면 그 해에 집중적으로 표출된다.',
  },
];

// ---------------------------------------------------------------------------
// 유틸리티 함수
// ---------------------------------------------------------------------------

/**
 * 두 지지 이름이 해(害) 관계인지 확인한다
 *
 * @param a - 첫 번째 지지 로마자
 * @param b - 두 번째 지지 로마자
 * @returns 해 관계이면 true
 *
 * @example
 * isHae('JA', 'MI')   // true  — 자미해
 * isHae('YU', 'SUL')  // true  — 유술해
 * isHae('JA', 'IN')   // false — 해 관계 아님
 */
export function isHae(a: BranchName, b: BranchName): boolean {
  return YUKHAE_PAIRS.some(
    pair => (pair.branches[0] === a && pair.branches[1] === b) ||
            (pair.branches[0] === b && pair.branches[1] === a),
  );
}

/**
 * 주어진 지지의 해(害) 상대 지지를 반환한다
 *
 * @param branch - 지지 로마자
 * @returns 해 상대 지지 (없으면 null)
 *
 * @example
 * getHaePartner('JA')   // 'MI'
 * getHaePartner('YU')   // 'SUL'
 */
export function getHaePartner(branch: BranchName): BranchName | null {
  for (const pair of YUKHAE_PAIRS) {
    if (pair.branches[0] === branch) return pair.branches[1];
    if (pair.branches[1] === branch) return pair.branches[0];
  }
  return null;
}

/**
 * 두 지지 사이의 해(害) 정보를 반환한다
 *
 * @param a - 첫 번째 지지 로마자
 * @param b - 두 번째 지지 로마자
 * @returns 해 정보 객체. 해 관계가 아니면 null
 *
 * @example
 * getHaeInfo('JA', 'MI')   // JijiHae { name: '자미해(子未害)', ... }
 * getHaeInfo('JA', 'O')    // null
 */
export function getHaeInfo(a: BranchName, b: BranchName): JijiHae | null {
  return YUKHAE_PAIRS.find(
    pair => (pair.branches[0] === a && pair.branches[1] === b) ||
            (pair.branches[0] === b && pair.branches[1] === a),
  ) ?? null;
}

/**
 * 두 지지의 해(害) 강도를 반환한다
 *
 * @param a - 첫 번째 지지 로마자
 * @param b - 두 번째 지지 로마자
 * @returns 해 강도. 해 관계가 아니면 null
 *
 * @example
 * getHaeStrength('JA', 'MI')     // 'STRONG'
 * getHaeStrength('MYO', 'JIN')   // 'MILD'
 */
export function getHaeStrength(a: BranchName, b: BranchName): HaeStrength | null {
  const info = getHaeInfo(a, b);
  return info?.strength ?? null;
}
