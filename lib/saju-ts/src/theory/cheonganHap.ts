/**
 * 천간합론(天干合論) — 천간 합화(合化) 이론
 *
 * 자평진전(子平眞詮)·명리정종(命理正宗) 기반 천간 오합(五合) 이론을 수록한다.
 *
 * 천간합(天干合)은 10천간 중 서로 간격이 5인 두 천간이 음양으로 짝을 이루어
 * 결합하는 현상이다. 양간(陽干)과 그 다음 5번째 음간이 합을 이루며,
 * 합화(合化)의 성립 여부는 월지 기운과 주변 환경에 따라 달라진다.
 *
 * 오합(五合):
 * - 甲己合土 (GAP + GI → TO)
 * - 乙庚合金 (EUL + GYEONG → GEUM)
 * - 丙辛合水 (BYEONG + SIN → SU)
 * - 丁壬合木 (JEONG + IM → MOK)
 * - 戊癸合火 (MU + GYE → HWA)
 */

import type { StemIdx } from '../core/cycle.js';
import type { Ohhaeng } from './ohhaeng.js';

// ---------------------------------------------------------------------------
// 천간 오합(五合) 테이블
// ---------------------------------------------------------------------------

/**
 * 천간 오합(五合) 단일 항목 인터페이스.
 *
 * 자평진전 기반으로 각 합의 명칭·합화 오행·원리·조건을 기술한다.
 */
export interface CheonganHap {
  /** 양간(陽干) 로마자 식별자 */
  yangStem: string;
  /** 음간(陰干) 로마자 식별자 */
  yinStem: string;
  /** 양간 인덱스 (0·2·4·6·8) */
  yangIdx: StemIdx;
  /** 음간 인덱스 (1·3·5·7·9) */
  yinIdx: StemIdx;
  /** 합화(合化) 결과 오행 로마자 */
  resultOhhaeng: Ohhaeng;
  /** 합 명칭 — 예: '갑기합토(甲己合土)' */
  name: string;
  /** 별칭 — 예: '중정지합(中正之合)' */
  principle: string;
  /** 합화 성립 조건 설명 목록 */
  conditions: string[];
}

/**
 * 천간 오합(五合) 테이블.
 *
 * 인덱스 순서: 갑기(0)·을경(1)·병신(2)·정임(3)·무계(4).
 *
 * 자평진전 원문 "甲與己合, 乙與庚合, 丙與辛合, 丁與壬合, 戊與癸合"
 */
export const CHEONGAN_HAP_TABLE: CheonganHap[] = [
  // ─────────────────────────────────────────────────────────────────────────
  // 1. 甲己合土 — 중정지합(中正之合)
  // ─────────────────────────────────────────────────────────────────────────
  {
    yangStem:      'GAP',   // 甲(0) — 양목(陽木)
    yinStem:       'GI',    // 己(5) — 음토(陰土)
    yangIdx:       0,
    yinIdx:        5,
    resultOhhaeng: 'TO',    // 合化土
    name:          '갑기합토(甲己合土)',
    principle:     '중정지합(中正之合)',
    conditions: [
      '甲은 정관(正官)에 해당하는 己와 합하여 중정(中正)의 덕(德)을 이룬다.',
      '합화토(合化土) 성립 조건: 월지가 辰·戌·丑·未(土월) 또는 토기(土氣)가 강한 경우.',
      '갑일간(甲日干)이 기(己)를 관(官)으로 쓰는 격에서 합이 발생하면 관성(官星)이 묶여 격을 손상시킬 수 있다.',
      '사주 내 갑(甲)과 기(己)가 인접하거나 간격이 없을 때 합력이 가장 강하다.',
      '지지에 토(土)의 뿌리가 있어야 진합화(眞合化)로 인정된다.',
    ],
  },

  // ─────────────────────────────────────────────────────────────────────────
  // 2. 乙庚合金 — 인의지합(仁義之合)
  // ─────────────────────────────────────────────────────────────────────────
  {
    yangStem:      'GYEONG', // 庚(6) — 양금(陽金)
    yinStem:       'EUL',    // 乙(1) — 음목(陰木)
    yangIdx:       6,
    yinIdx:        1,
    resultOhhaeng: 'GEUM',   // 合化金
    name:          '을경합금(乙庚合金)',
    principle:     '인의지합(仁義之合)',
    conditions: [
      '乙은 유연함(仁)을, 庚은 강직함(義)을 상징하여 인의(仁義)가 결합한 합이다.',
      '합화금(合化金) 성립 조건: 월지가 申·酉(金월) 또는 금기(金氣)가 지지에 왕성한 경우.',
      '을목(乙木) 일간이 경금(庚金) 칠살(七殺)과 합하면 살인상정(殺刃相停) 구조를 형성할 수 있다.',
      '경금(庚金) 일간이 을목(乙木) 정재(正財)와 합하면 재성(財星)이 묶여 운용이 달라진다.',
      '지지에 申·酉·丑의 금국(金局) 또는 금 뿌리가 있어야 합화가 성립한다.',
    ],
  },

  // ─────────────────────────────────────────────────────────────────────────
  // 3. 丙辛合水 — 위제지합(威制之合)
  // ─────────────────────────────────────────────────────────────────────────
  {
    yangStem:      'BYEONG', // 丙(2) — 양화(陽火)
    yinStem:       'SIN',    // 辛(7) — 음금(陰金)
    yangIdx:       2,
    yinIdx:        7,
        resultOhhaeng: 'SU',     // 合化水
    name:          '병신합수(丙辛合水)',
    principle:     '위제지합(威制之合)',
    conditions: [
      '丙火의 강한 위세(威勢)가 辛金을 제압(制壓)하여 합화수(合化水)가 된다.',
      '합화수(合化水) 성립 조건: 월지가 亥·子(水월) 또는 수기(水氣)가 지지에 왕성한 경우.',
      '병화(丙火)가 신금(辛金) 정재(正財)와 합하면 재성이 묶여 재(財)를 취하기 어렵게 될 수 있다.',
      '신금(辛金) 일간이 병화(丙火) 정관(正官)과 합하면 관성(官星)이 묶여 격국에 영향을 준다.',
      '지지에 亥·子·申의 수국(水局) 또는 수 뿌리가 있어야 합화가 성립한다.',
    ],
  },

  // ─────────────────────────────────────────────────────────────────────────
  // 4. 丁壬合木 — 음란지합(淫亂之合)
  // ─────────────────────────────────────────────────────────────────────────
  {
    yangStem:      'IM',    // 壬(8) — 양수(陽水)
    yinStem:       'JEONG', // 丁(3) — 음화(陰火)
    yangIdx:       8,
    yinIdx:        3,
    resultOhhaeng: 'MOK',   // 合化木
    name:          '정임합목(丁壬合木)',
    principle:     '음란지합(淫亂之合)',
    conditions: [
      '丁은 음화(陰火)로 내면의 욕망, 壬은 양수(陽水)로 넓은 흐름을 상징하여 두 기운이 절제 없이 합하는 음란지합이다.',
      '합화목(合化木) 성립 조건: 월지가 寅·卯(木월) 또는 목기(木氣)가 지지에 왕성한 경우.',
      '정화(丁火) 일간이 임수(壬水) 정관(正官)과 합하면 관성이 묶이는 현상이 발생한다.',
      '임수(壬水) 일간이 정화(丁火) 정재(正財)와 합하면 재성이 묶여 재물 취득에 영향을 준다.',
      '지지에 寅·卯·亥의 목국(木局) 또는 목 뿌리가 있어야 합화가 성립한다.',
      '음란지합이라도 격국이 깨끗하고 합화가 성립하면 귀격(貴格)이 될 수 있다.',
    ],
  },

  // ─────────────────────────────────────────────────────────────────────────
  // 5. 戊癸合火 — 무정지합(無情之合)
  // ─────────────────────────────────────────────────────────────────────────
  {
    yangStem:      'MU',  // 戊(4) — 양토(陽土)
    yinStem:       'GYE', // 癸(9) — 음수(陰水)
    yangIdx:       4,
    yinIdx:        9,
    resultOhhaeng: 'HWA', // 合化火
    name:          '무계합화(戊癸合化)',
    principle:     '무정지합(無情之合)',
    conditions: [
      '戊는 노양(老陽), 癸는 노음(老陰)으로 노양과 노음의 만남이라 정(情)이 없는 무정지합이다.',
      '합화화(合化火) 성립 조건: 월지가 巳·午(火월) 또는 화기(火氣)가 지지에 왕성한 경우.',
      '무토(戊土) 일간이 계수(癸水) 정재(正財)와 합하면 재성이 묶여 재물 운용이 달라진다.',
      '계수(癸水) 일간이 무토(戊土) 정관(正官)과 합하면 관성이 묶이는 현상이 발생한다.',
      '지지에 巳·午·寅의 화국(火局) 또는 화 뿌리가 있어야 합화가 성립한다.',
      '노음노양(老陰老陽)의 합으로 합력(合力)이 가장 약한 편이다.',
    ],
  },
];

// ---------------------------------------------------------------------------
// 합화 판정 조건 (자평진전 핵심 이론)
// ---------------------------------------------------------------------------

/**
 * 합화(合化) 판정 규칙 인터페이스.
 *
 * 자평진전 「논천간십간합」 편에서 합화(合而化) 여부를 판단하는 원칙을 수록한다.
 */
export interface HapHwaCondition {
  /** 규칙 명칭 (한글) */
  rule: string;
  /** 예시 설명 */
  example: string;
  /** 적용 효과 */
  effect: string;
}

/**
 * 합화(合而化) 성립 조건 목록.
 *
 * 합이 단순히 합(合)으로 묶이는 데 그치지 않고 실제로 오행이 변하는
 * 합화(合化)가 성립하려면 다음 조건이 충족되어야 한다.
 *
 * 자평진전 원문 기반:
 * "合而後化, 必月令有氣方能化" (합하고 나서 화하려면 반드시 월령에 기운이 있어야 한다)
 */
export const HAP_HWA_CONDITIONS: HapHwaCondition[] = [
  {
    rule:    '월령 기운 지원(月令有氣)',
    example: '甲己合에서 월지가 辰·戌·丑·未(토월)이거나 토기(土氣)가 왕성할 때',
    effect:  '합화가 성립하여 두 천간이 모두 합화 결과 오행으로 변질(변화)된다.',
  },
  {
    rule:    '간격 없는 인접 합(鄰近之合)',
    example: '甲·己가 연간(年干)과 월간(月干)처럼 바로 이웃할 때',
    effect:  '합력(合力)이 가장 강하며 합화 성립 가능성이 높다.',
  },
  {
    rule:    '지지 통근(通根) 확인',
    example: '합화 결과 오행이 지지에 뿌리를 두고 있는지 확인',
    effect:  '지지에 통근이 있어야 합화 기운이 실질적 힘을 발휘한다.',
  },
  {
    rule:    '충(沖)·형(刑)의 방해 없음',
    example: '합화 결과 오행을 충하는 천간이나 지지가 없는 경우',
    effect:  '합화 기운이 안정적으로 유지되어 격국(格局)에 온전히 작용한다.',
  },
  {
    rule:    '화기격(化氣格) 성립 시 일간 포함',
    example: '일간 자신이 합에 참여할 때(예: 甲일간이 己와 합)',
    effect:  '화기격(化氣格) 성립 여부를 별도로 판단해야 한다. 진화격(眞化格)이 되면 화신(化神)이 용신(用神)이 된다.',
  },
];

/**
 * 합화(合化)를 방해하거나 파괴하는 요소 목록.
 *
 * 자평진전에서 "합이불화(合而不化)"의 원인으로 제시하는 사항들이다.
 */
export const HAP_BLOCK_CONDITIONS: Array<{
  condition: string;
  example: string;
}> = [
  {
    condition: '월지 기운 부재(月令無氣)',
    example:   '甲己合인데 월지가 寅·卯(木월)이면 土의 기운이 없어 합화 불성립 → 합이불화(合而不化)',
  },
  {
    condition: '충(沖)에 의한 합 파괴',
    example:   '甲己合이 이루어지려 할 때 庚이 甲을 충(甲庚沖)하면 합이 깨진다.',
  },
  {
    condition: '투합(妬合) — 하나가 둘을 합하는 경우',
    example:   '乙·甲·己 구조에서 甲과 己가 합하려 하지만 乙도 庚과 합하려 하여 甲이 질투를 받는 상황',
  },
  {
    condition: '쟁합(爭合) — 둘이 하나를 합하는 경우',
    example:   '甲·己·甲 구조에서 두 甲이 하나의 己를 쟁탈하려 하므로 합력이 약화된다.',
  },
  {
    condition: '격리(隔離) — 두 간 사이에 다른 간이 개입',
    example:   '甲·丙·己처럼 甲과 己 사이에 丙이 끼어 있으면 합력이 크게 감소한다.',
  },
  {
    condition: '합화 결과 오행이 충을 받음',
    example:   '甲己合土인데 지지에 木의 왕성한 기운이 있어 土를 극(木剋土)하면 합화 기운이 약해진다.',
  },
];

// ---------------------------------------------------------------------------
// 간합의 길흉 작용
// ---------------------------------------------------------------------------

/**
 * 간합(干合) 길흉 작용 인터페이스.
 */
export interface HapEffect {
  /** 적용 상황 설명 */
  case: string;
  /** 작용 내용 */
  effect: string;
  /** 길흉 판단 */
  gilhyung: '길' | '흉' | '중립';
}

/**
 * 간합(干合) 길흉 작용 목록.
 *
 * 합이 격국에 미치는 영향은 합하는 두 간의 십신(十神) 관계와 합화 여부에 따라
 * 크게 다르다. 자평진전 논용신(論用神) 편 기반.
 */
export const HAP_EFFECTS: HapEffect[] = [
  {
    case:     '용신(用神)이 합거(合去)되는 경우',
    effect:   '용신이 합으로 묶이거나 다른 오행으로 화하여 본래 기능을 상실한다. 격국이 무너지고 대흉(大凶)의 원인이 된다.',
    gilhyung: '흉',
  },
  {
    case:     '기신(忌神)이 합거(合去)되는 경우',
    effect:   '사주를 해치는 기신이 합으로 제거되거나 중화되어 사주 전체 균형이 좋아진다. 대길(大吉)의 원인이 된다.',
    gilhyung: '길',
  },
  {
    case:     '관성(官星)이 합화(合化)되어 재성(財星)으로 변하는 경우',
    example:  '정관(正官)인 甲이 己와 합하여 土(財)로 화하는 경우',
    effect:   '관직보다 재물로 향하는 기운이 강해진다. 격국의 방향이 바뀌므로 길흉 판단은 재격(財格) 기준으로 재평가한다.',
    gilhyung: '중립',
  },
  {
    case:     '식신(食神)·상관(傷官)이 합화되어 인성(印星)으로 변하는 경우',
    effect:   '표현력·창의성이 묶이고 학업·권위의 기운으로 전환된다. 재능을 발휘하기 어렵고 보수적 경향이 강해진다.',
    gilhyung: '흉',
  },
  {
    case:     '비겁(比劫)이 합화되어 관성(官星)으로 변하는 경우',
    effect:   '경쟁자·형제 기운이 제어되어 관(官)의 기운으로 전환. 다툼이 줄고 사회적 명예·직위가 올라가는 방향으로 작용한다.',
    gilhyung: '길',
  },
  {
    case:     '인성(印星)이 합화되어 재성(財星)으로 변하는 경우',
    effect:   '학문·어머니·보호 기운이 약화되고 재물 기운으로 전환. 재다신약(財多身弱) 구조를 악화시킬 수 있다.',
    gilhyung: '중립',
  },
  {
    case:     '합이 있어도 합화(合化)가 불성립하는 경우(합이불화)',
    effect:   '두 천간이 합으로 묶여 본래 기능을 발휘하지 못하는 상태. 용신이 묶이면 흉, 기신이 묶이면 길로 작용한다.',
    gilhyung: '중립',
  },
  {
    case:     '세운·대운에서 합이 발생하는 경우',
    effect:   '원국의 특정 천간이 운(運)의 간과 합하여 기능이 묶이거나 강화된다. 용신이 합거되는 운은 흉운, 기신이 합거되는 운은 길운이다.',
    gilhyung: '중립',
  },
];

// ---------------------------------------------------------------------------
// 유정지합(有情之合) vs 무정지합(無情之合)
// ---------------------------------------------------------------------------

/**
 * 유정지합(有情之合) vs 무정지합(無情之合) 분류.
 *
 * 합의 성질에 따라 정(情)이 있는 합과 없는 합으로 나눈다.
 * - 유정지합: 두 천간의 오행 성질이 서로 친화력이 있어 자연스럽게 끌리는 합
 * - 무정지합: 오행 성질이 서로 이질적이거나 극(剋) 관계가 개입되어 억지로 합하는 합
 */
export const HAP_TYPES: {
  yujong: Array<{ stems: string[]; reason: string }>;
  mujong: Array<{ stems: string[]; reason: string }>;
} = {
  /** 유정지합(有情之合) — 정이 있어 자연스러운 합 */
  yujong: [
    {
      stems:  ['GAP(甲)', 'GI(己)'],
      reason: '중정지합(中正之合). 甲은 인(仁)을, 己는 중(中)을 상징하며 정관과 일간의 관계처럼 정당하고 바른 만남이다.',
    },
    {
      stems:  ['EUL(乙)', 'GYEONG(庚)'],
      reason: '인의지합(仁義之合). 乙의 인(仁)과 庚의 의(義)가 결합하여 인의를 갖춘 합이다.',
    },
  ],
  /** 무정지합(無情之合) — 정이 없어 어색한 합 */
  mujong: [
    {
      stems:  ['BYEONG(丙)', 'SIN(辛)'],
      reason: '위제지합(威制之合). 丙이 강한 위세로 辛을 억압·제복(制伏)하는 관계로, 자연스러운 끌림이 아닌 강제적 결합이다.',
    },
    {
      stems:  ['JEONG(丁)', 'IM(壬)'],
      reason: '음란지합(淫亂之合). 丁·壬은 서로 절제 없이 합하는 성질로, 도덕적으로 절도가 없는 합이다.',
    },
    {
      stems:  ['MU(戊)', 'GYE(癸)'],
      reason: '무정지합(無情之合). 戊는 노양(老陽), 癸는 노음(老陰)으로 노쇠한 음양의 만남이라 정(情)이 없는 합이다.',
    },
  ],
};

// ---------------------------------------------------------------------------
// 합이 격국에 미치는 영향
// ---------------------------------------------------------------------------

/**
 * 합이 격국(格局)에 미치는 영향 목록.
 *
 * 자평진전 논격국(論格局) 및 논용신(論用神) 편 기반으로
 * 합이 격국을 손상시키거나 성립시키는 주요 시나리오를 수록한다.
 */
export const HAP_GYEOKGUK_IMPACT: Array<{
  scenario: string;
  impact: string;
  example: string;
}> = [
  {
    scenario: '정관격(正官格)에서 관성이 합거(合去)될 때',
    impact:   '정관격이 무너져 격국이 손상된다. 관직·명예에 불리하며 격국의 청(淸)함이 사라진다.',
    example:  '甲일간 정관 辛이 丙과 합하여 水로 화하면 辛의 관성 기능이 상실된다.',
  },
  {
    scenario: '재격(財格)에서 재성이 합거(合去)될 때',
    impact:   '재성이 묶여 재물 취득이 어렵거나 재운이 막힌다.',
    example:  '壬일간 정재 丁이 壬과 합하여 木으로 화하면 丁의 재성 기능이 상실된다.',
  },
  {
    scenario: '기신(忌神)이 합거(合去)되어 격국이 맑아질 때',
    impact:   '격국을 방해하던 기신이 제거되어 격국의 청(淸)함이 높아지고 길한 작용이 강해진다.',
    example:  '식신격(食神格)에서 정관을 상(傷)하는 편관(偏官)이 합거되면 격국이 온전해진다.',
  },
  {
    scenario: '용신이 운(運)에서 합거(合去)될 때',
    impact:   '해당 대운·세운 기간 동안 용신이 기능을 상실하여 흉험(凶險)한 시기가 된다.',
    example:  '용신 甲이 己운에 합거되면 그 운 기간은 크게 불리하다.',
  },
  {
    scenario: '합화(合化)로 격국이 변질될 때',
    impact:   '원래 격국이 합화 결과 오행의 격국으로 바뀐다. 새로운 격국의 기준으로 다시 용신을 정해야 한다.',
    example:  '식신격에서 식신이 합화되어 재성으로 변하면 재격(財格)으로 격국이 전환된다.',
  },
  {
    scenario: '화기격(化氣格) 성립으로 격국이 순화(純化)될 때',
    impact:   '일간이 합에 참여하여 화기격이 성립하면 화신(化神)이 용신이 되어 새로운 격국 체계가 적용된다.',
    example:  '甲일간이 己와 합하여 화기토격(化氣土格)이 성립하면 土가 왕성한 환경이 길하다.',
  },
];

// ---------------------------------------------------------------------------
// 화기격(化氣格) 이론
// ---------------------------------------------------------------------------

/**
 * 화기격(化氣格) 이론.
 *
 * 일간(日干)이 다른 천간과 합하여 본래 오행을 버리고 합화 결과 오행으로
 * 완전히 변질되는 특수 격국이다.
 * 자평진전 「논화기(論化氣)」 편 기반.
 */
export const HWAGI_GYEOK: {
  definition: string;
  conditions: string[];
  types: Array<{
    name: string;
    stems: string[];
    resultElement: string;
    monthSupport: string[];
    characteristics: string;
  }>;
  trueVsFalse: {
    true: string;
    false: string;
  };
} = {
  definition:
    '화기격(化氣格)이란 일간(日干)이 특정 천간과 합(合)하여 합화(合化)가 성립하고, ' +
    '사주 전체 기운이 합화 결과 오행으로 완전히 통일된 특수 격국이다. ' +
    '이 경우 일간의 본래 오행을 버리고 화신(化神)을 중심으로 용신·격국을 판단한다.',

  conditions: [
    '일간(日干) 자신이 합에 직접 참여해야 한다 (예: 甲일간 + 己합).',
    '월지(月支)가 합화 결과 오행의 기운을 강하게 지원해야 한다.',
    '사주 내에 일간의 본래 오행을 강하게 지지하는 간지(干支)가 없어야 한다.',
    '화신(化神)을 충(沖)·극(剋)하는 간지가 없어야 한다.',
    '지지에 화신의 뿌리(통근)가 충분히 갖춰져 있어야 한다.',
    '합을 깨는 충(沖)이나 별도의 합이 개입하지 않아야 한다.',
  ],

  types: [
    {
      name:           '화기토격(化氣土格)',
      stems:          ['GAP(甲)', 'GI(己)'],
      resultElement:  'TO(土)',
      monthSupport:   ['辰월', '戌월', '丑월', '未월', '기타 土월'],
      characteristics:
        '토(土)의 중화(中和)·포용의 기운이 충만. 토(土)가 왕성한 환경에서 번성하며 ' +
        '土를 극하는 木이나 약화시키는 水가 없어야 진격(眞格)이 된다.',
    },
    {
      name:           '화기금격(化氣金格)',
      stems:          ['EUL(乙)', 'GYEONG(庚)'],
      resultElement:  'GEUM(金)',
      monthSupport:   ['申월', '酉월', '丑월(금창고)'],
      characteristics:
        '금(金)의 숙살(肅殺)·결단의 기운이 충만. 申·酉·丑이 지지에 있을 때 진격(眞格). ' +
        '金을 극하는 火나 설기(泄氣)하는 水가 없어야 한다.',
    },
    {
      name:           '화기수격(化氣水格)',
      stems:          ['BYEONG(丙)', 'SIN(辛)'],
      resultElement:  'SU(水)',
      monthSupport:   ['亥월', '子월', '申월(수생지)'],
      characteristics:
        '수(水)의 지혜·유연의 기운이 충만. 亥·子·申이 지지에 있을 때 진격(眞格). ' +
        '水를 극하는 土나 설기하는 木이 없어야 한다.',
    },
    {
      name:           '화기목격(化氣木格)',
      stems:          ['JEONG(丁)', 'IM(壬)'],
      resultElement:  'MOK(木)',
      monthSupport:   ['寅월', '卯월', '亥월(목장생)'],
      characteristics:
        '목(木)의 생장(生長)·진취의 기운이 충만. 寅·卯·亥가 지지에 있을 때 진격(眞格). ' +
        '木을 극하는 金이나 설기하는 火가 없어야 한다.',
    },
    {
      name:           '화기화격(化氣火格)',
      stems:          ['MU(戊)', 'GYE(癸)'],
      resultElement:  'HWA(火)',
      monthSupport:   ['巳월', '午월', '寅월(화장생)'],
      characteristics:
        '화(火)의 광명(光明)·열정의 기운이 충만. 巳·午·寅이 지지에 있을 때 진격(眞格). ' +
        '火를 극하는 水나 설기하는 土가 없어야 한다.',
    },
  ],

  trueVsFalse: {
    true:
      '진화격(眞化格): 합화 조건이 완전히 충족되어 사주 전체가 화신(化神) 오행으로 통일된 상태. ' +
      '화신이 용신이 되며, 화신을 생(生)하는 오행이 희신(喜神), 화신을 극(剋)하거나 설(泄)하는 오행이 기신(忌神)이 된다. ' +
      '진화격은 희신 운에서 크게 발복(發福)하며 화신이 강한 사주는 귀격(貴格)이 된다.',
    false:
      '가화격(假化格): 합화 조건이 부분적으로 충족되었으나 완전하지 않은 상태. ' +
      '일간의 본래 오행이 지지에 뿌리가 남아 있거나 화신을 극하는 간지가 있는 경우. ' +
      '가화격은 진화격에 비해 크게 발복하지 못하며, 운에서 본래 오행이 강해지면 합이 깨지는 현상이 발생한다.',
  },
};

// ---------------------------------------------------------------------------
// 유틸리티 함수
// ---------------------------------------------------------------------------

/**
 * 두 천간 인덱스의 합(合) 결과 오행을 반환한다.
 *
 * 합이 성립하면 합화 결과 오행 로마자를 반환하고, 합이 아니면 null을 반환한다.
 * 이 함수는 합화(合化) 성립 여부를 판단하지 않으며, 단순히 오합(五合) 쌍 여부만 확인한다.
 *
 * @param stemA - 첫 번째 천간 인덱스 (0~9)
 * @param stemB - 두 번째 천간 인덱스 (0~9)
 * @returns 합화 결과 오행 로마자 (합이 아니면 null)
 *
 * @example
 * getHapResult(0, 5)  // 'TO'   — 甲己合土
 * getHapResult(1, 6)  // 'GEUM' — 乙庚合金
 * getHapResult(0, 1)  // null   — 합 아님
 */
export function getHapResult(stemA: StemIdx, stemB: StemIdx): Ohhaeng | null {
  const a = ((stemA % 10) + 10) % 10;
  const b = ((stemB % 10) + 10) % 10;
  const lo = Math.min(a, b);
  const hi = Math.max(a, b);
  // 오합(五合) 쌍: 간격이 5인 양간+음간 조합
  if (lo === 0 && hi === 5) return 'TO';
  if (lo === 1 && hi === 6) return 'GEUM';
  if (lo === 2 && hi === 7) return 'SU';
  if (lo === 3 && hi === 8) return 'MOK';
  if (lo === 4 && hi === 9) return 'HWA';
  return null;
}

/**
 * 두 천간 인덱스가 합(合) 관계인지 판별한다.
 *
 * 두 천간의 인덱스 차이가 5이면 합 관계이다 (양간 + 음간, 간격 5).
 *
 * @param stemA - 첫 번째 천간 인덱스 (0~9)
 * @param stemB - 두 번째 천간 인덱스 (0~9)
 * @returns 합 관계이면 true
 *
 * @example
 * isHap(0, 5)  // true  — 甲己合
 * isHap(3, 8)  // true  — 丁壬合
 * isHap(0, 6)  // false — 甲庚沖 (합 아님)
 */
export function isHap(stemA: StemIdx, stemB: StemIdx): boolean {
  return getHapResult(stemA, stemB) !== null;
}

/**
 * 두 천간 인덱스의 합화(合化) 결과 오행을 반환한다.
 *
 * {@link getHapResult}와 동일하지만 명시적으로 합화(合化) 맥락임을 나타낸다.
 * 실제 합화 성립 여부는 월지·지지 환경을 별도로 검토해야 한다.
 *
 * @param stemA - 첫 번째 천간 인덱스 (0~9)
 * @param stemB - 두 번째 천간 인덱스 (0~9)
 * @returns 합화 결과 오행 로마자 (합이 아니면 null)
 *
 * @example
 * hapHwaResult(2, 7)  // 'SU'  — 丙辛合水
 * hapHwaResult(4, 9)  // 'HWA' — 戊癸合火
 * hapHwaResult(0, 2)  // null  — 합 아님
 */
export function hapHwaResult(stemA: StemIdx, stemB: StemIdx): Ohhaeng | null {
  return getHapResult(stemA, stemB);
}

/**
 * 주어진 천간 인덱스의 합(合) 상대 천간 인덱스를 반환한다.
 *
 * 오합(五合)은 인덱스 차이가 5이므로, 상대 인덱스는 (idx + 5) % 10이다.
 *
 * @param stemIdx - 천간 인덱스 (0~9)
 * @returns 합 상대 천간 인덱스 (0~9)
 *
 * @example
 * getHapPartner(0)  // 5  — 甲의 합 상대는 己
 * getHapPartner(5)  // 0  — 己의 합 상대는 甲
 * getHapPartner(3)  // 8  — 丁의 합 상대는 壬
 */
export function getHapPartner(stemIdx: StemIdx): StemIdx {
  return (((stemIdx % 10) + 5) % 10) as StemIdx;
}
